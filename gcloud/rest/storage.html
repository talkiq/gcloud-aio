<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.1.0"/>
    <title>gcloud.rest.storage API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../rest.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;gcloud.rest</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>

            <h2>Contents</h2>
            <ul>
  <li><a href="#installation">Installation</a></li>
  <li><a href="#usage">Usage</a></li>
  <li><a href="#file-encodings">File Encodings</a></li>
  <li><a href="#emulators">Emulators</a></li>
  <li><a href="#customization">Customization</a></li>
</ul>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Blob">Blob</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Blob.__init__">Blob</a>
                        </li>
                        <li>
                                <a class="variable" href="#Blob.bucket">bucket</a>
                        </li>
                        <li>
                                <a class="variable" href="#Blob.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#Blob.size">size</a>
                        </li>
                        <li>
                                <a class="variable" href="#Blob.chunk_size">chunk_size</a>
                        </li>
                        <li>
                                <a class="function" href="#Blob.download">download</a>
                        </li>
                        <li>
                                <a class="function" href="#Blob.upload">upload</a>
                        </li>
                        <li>
                                <a class="function" href="#Blob.get_signed_url">get_signed_url</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Bucket">Bucket</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Bucket.__init__">Bucket</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bucket.storage">storage</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bucket.name">name</a>
                        </li>
                        <li>
                                <a class="function" href="#Bucket.get_blob">get_blob</a>
                        </li>
                        <li>
                                <a class="function" href="#Bucket.blob_exists">blob_exists</a>
                        </li>
                        <li>
                                <a class="function" href="#Bucket.list_blobs">list_blobs</a>
                        </li>
                        <li>
                                <a class="function" href="#Bucket.new_blob">new_blob</a>
                        </li>
                        <li>
                                <a class="function" href="#Bucket.get_metadata">get_metadata</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="variable" href="#SCOPES">SCOPES</a>
            </li>
            <li>
                    <a class="class" href="#Storage">Storage</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Storage.__init__">Storage</a>
                        </li>
                        <li>
                                <a class="variable" href="#Storage.session">session</a>
                        </li>
                        <li>
                                <a class="variable" href="#Storage.token">token</a>
                        </li>
                        <li>
                                <a class="function" href="#Storage.list_buckets">list_buckets</a>
                        </li>
                        <li>
                                <a class="function" href="#Storage.get_bucket">get_bucket</a>
                        </li>
                        <li>
                                <a class="function" href="#Storage.copy">copy</a>
                        </li>
                        <li>
                                <a class="function" href="#Storage.delete">delete</a>
                        </li>
                        <li>
                                <a class="function" href="#Storage.download">download</a>
                        </li>
                        <li>
                                <a class="function" href="#Storage.download_to_filename">download_to_filename</a>
                        </li>
                        <li>
                                <a class="function" href="#Storage.download_metadata">download_metadata</a>
                        </li>
                        <li>
                                <a class="function" href="#Storage.download_stream">download_stream</a>
                        </li>
                        <li>
                                <a class="function" href="#Storage.list_objects">list_objects</a>
                        </li>
                        <li>
                                <a class="function" href="#Storage.upload">upload</a>
                        </li>
                        <li>
                                <a class="function" href="#Storage.upload_from_filename">upload_from_filename</a>
                        </li>
                        <li>
                                <a class="function" href="#Storage.patch_metadata">patch_metadata</a>
                        </li>
                        <li>
                                <a class="function" href="#Storage.get_bucket_metadata">get_bucket_metadata</a>
                        </li>
                        <li>
                                <a class="function" href="#Storage.close">close</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#StreamResponse">StreamResponse</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#StreamResponse.__init__">StreamResponse</a>
                        </li>
                        <li>
                                <a class="variable" href="#StreamResponse.content_length">content_length</a>
                        </li>
                        <li>
                                <a class="function" href="#StreamResponse.read">read</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="variable" href="#__version__">__version__</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../gcloud.html">gcloud</a><wbr>.<a href="./../rest.html">rest</a><wbr>.storage    </h1>

                        <div class="docstring"><p>This library implements various methods for working with the Google Storage
APIs.</p>

<h2 id="installation">Installation</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">$ </span>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>gcloud-rest-storage
</code></pre>
</div>

<h2 id="usage">Usage</h2>

<p>To upload a file, you might do something like the following:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">aiofiles</span>
<span class="kn">import</span> <span class="nn">aiohttp</span>
<span class="kn">from</span> <span class="nn"><a href="">gcloud.rest.storage</a></span> <span class="kn">import</span> <span class="n">Storage</span>


<span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Storage</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">aiofiles</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;/path/to/my/file&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span>
            <span class="s1">&#39;my-bucket-name&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path/to/gcs/folder&#39;</span><span class="p">,</span>
            <span class="n">output</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
</code></pre>
</div>

<p>Note that there are multiple ways to accomplish the above, ie,. by making use
of the <code><a href="#Bucket">Bucket</a></code> and <code><a href="#Blob">Blob</a></code> convenience classes if that better fits your
use-case.</p>

<p>Of course, the major benefit of using an library is being able to
parallelize operations like this. Since <code>gcloud-rest-storage</code> is fully
asyncio-compatible, you can use any of the builtin asyncio method to perform
more complicated operations:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">my_files</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;/local/path/to/file.1&#39;</span><span class="p">:</span> <span class="s1">&#39;path/in/gcs.1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/local/path/to/file.2&#39;</span><span class="p">:</span> <span class="s1">&#39;path/in/gcs.2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/local/path/to/file.3&#39;</span><span class="p">:</span> <span class="s1">&#39;different/gcs/path/filename.3&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">with</span> <span class="n">Storage</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
    <span class="c1"># Prepare all our upload data</span>
    <span class="n">uploads</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">local_name</span><span class="p">,</span> <span class="n">gcs_name</span> <span class="ow">in</span> <span class="n">my_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">aiofiles</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">local_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">uploads</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">gcs_name</span><span class="p">,</span> <span class="n">contents</span><span class="p">))</span>

    <span class="c1"># Simultaneously upload all files</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
        <span class="o">*</span><span class="p">[</span>
            <span class="n">client</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="s1">&#39;my-bucket-name&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">file_</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">file_</span> <span class="ow">in</span> <span class="n">uploads</span>
        <span class="p">]</span>
    <span class="p">)</span>
</code></pre>
</div>

<p>You can also refer to the <a href="https://github.com/talkiq/gcloud-rest/blob/master/storage/tests/integration/smoke_test.py">smoke test</a> for more info and examples.</p>

<p>Note that you can also let <code>gcloud-rest-storage</code> do its own session management,
so long as you give us a hint when to close that session:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="k">with</span> <span class="n">Storage</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
    <span class="c1"># closes the client.session on leaving the context manager</span>

<span class="c1"># OR</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">Storage</span><span class="p">()</span>
<span class="c1"># do stuff</span>
<span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># close the session explicitly</span>
</code></pre>
</div>

<h2 id="file-encodings">File Encodings</h2>

<p>In some cases, <code>aiohttp</code> needs to transform the objects returned from GCS into
strings, eg. for debug logging and other such issues. The built-in <code>await
response.text()</code> operation relies on <a href="https://pypi.org/project/chardet/">chardet</a> for guessing the
character encoding in any cases where it can not be determined based on the
file metadata.</p>

<p>Unfortunately, this operation can be extremely slow, especially in cases where
you might be working with particularly large files. If you notice odd latency
issues when reading your results, you may want to set your character encoding
more explicitly within GCS, eg. by ensuring you set the <code>contentType</code> of the
relevant objects to something suffixed with <code>; charset=utf-8</code>. For example, in
the case of <code>contentType='application/x-netcdf'</code> files exhibiting latency, you
could instead set <code>contentType='application/x-netcdf; charset=utf-8</code>. See
<a href="https://github.com/talkiq/gcloud-rest/issues/172">Issue #172</a> for more info!</p>

<h2 id="emulators">Emulators</h2>

<p>For testing purposes, you may want to use <code>gcloud-rest-storage</code> along with a
local GCS emulator. Setting the <code>$STORAGE_EMULATOR_HOST</code> environment variable
to the address of your emulator should be enough to do the trick.</p>

<p>For example, using <a href="https://github.com/fsouza/fake-gcs-server">fsouza/fake-gcs-server</a>, you can do:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>-p<span class="w"> </span><span class="m">4443</span>:4443<span class="w"> </span>-v<span class="w"> </span><span class="nv">$PWD</span>/my-sample-data:/data<span class="w"> </span>fsouza/fake-gcs-server
<span class="nb">export</span><span class="w"> </span><span class="nv">STORAGE_EMULATOR_HOST</span><span class="o">=</span><span class="s1">&#39;0.0.0.0:4443&#39;</span>
</code></pre>
</div>

<p>Any <code>gcloud-rest-storage</code> requests made with that environment variable set will
query <code>fake-gcs-server</code> instead of the official GCS API.</p>

<p>Note that some emulation systems require disabling SSL -- if you're using a
custom http session, you may need to disable SSL verification.</p>

<h2 id="customization">Customization</h2>

<p>This library mostly tries to stay agnostic of potential use-cases; as such, we
do not implement any sort of retrying or other policies under the assumption
that we wouldn't get things right for every user's situation.</p>

<p>As such, we recommend configuring your own policies on an as-needed basis. The
<a href="https://pypi.org/project/backoff/">backoff</a> library can make this quite straightforward! For example,
you may find it useful to configure something like:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="k">class</span> <span class="nc">StorageWithBackoff</span><span class="p">(</span><span class="n"><a href="#Storage">gcloud.rest.storage.Storage</a></span><span class="p">):</span>
    <span class="nd">@backoff</span><span class="o">.</span><span class="n">on_exception</span><span class="p">(</span><span class="n">backoff</span><span class="o">.</span><span class="n">expo</span><span class="p">,</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientResponseError</span><span class="p">,</span>
                          <span class="n">max_tries</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">jitter</span><span class="o">=</span><span class="n">backoff</span><span class="o">.</span><span class="n">full_jitter</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@backoff</span><span class="o">.</span><span class="n">on_exception</span><span class="p">(</span><span class="n">backoff</span><span class="o">.</span><span class="n">expo</span><span class="p">,</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientResponseError</span><span class="p">,</span>
                          <span class="n">max_tries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">jitter</span><span class="o">=</span><span class="n">backoff</span><span class="o">.</span><span class="n">full_jitter</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre>
</div>
</div>

                        <input id="mod-storage-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-storage-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="sd">This library implements various methods for working with the Google Storage</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd">APIs.</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">## Installation</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="sd">```console</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="sd">$ pip install --upgrade gcloud-rest-storage</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="sd">```</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="sd">## Usage</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="sd">To upload a file, you might do something like the following:</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">```python</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">import aiofiles</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">import aiohttp</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">from gcloud.rest.storage import Storage</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">with aiohttp.ClientSession() as session:</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">    client = Storage(session=session)</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="sd">    with aiofiles.open(&#39;/path/to/my/file&#39;, mode=&quot;r&quot;) as f:</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">        output = f.read()</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">        status = client.upload(</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd">            &#39;my-bucket-name&#39;,</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">            &#39;path/to/gcs/folder&#39;,</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">            output,</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">        )</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="sd">        print(status)</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="sd">```</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="sd">Note that there are multiple ways to accomplish the above, ie,. by making use</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="sd">of the `Bucket` and `Blob` convenience classes if that better fits your</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">use-case.</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">Of course, the major benefit of using an library is being able to</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">parallelize operations like this. Since `gcloud-rest-storage` is fully</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">asyncio-compatible, you can use any of the builtin asyncio method to perform</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">more complicated operations:</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">```python</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">my_files = {</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">    &#39;/local/path/to/file.1&#39;: &#39;path/in/gcs.1&#39;,</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">    &#39;/local/path/to/file.2&#39;: &#39;path/in/gcs.2&#39;,</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">    &#39;/local/path/to/file.3&#39;: &#39;different/gcs/path/filename.3&#39;,</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">}</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">with Storage() as client:</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">    # Prepare all our upload data</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">    uploads = []</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">    for local_name, gcs_name in my_files.items():</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">        with aiofiles.open(local_name, mode=&quot;r&quot;) as f:</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">            contents = f.read()</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="sd">            uploads.append((gcs_name, contents))</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">    # Simultaneously upload all files</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="sd">    asyncio.gather(</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="sd">        *[</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">            client.upload(&#39;my-bucket-name&#39;, path, file_)</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">            for path, file_ in uploads</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="sd">        ]</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd">    )</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">```</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="sd">You can also refer to the [smoke test][smoke-test] for more info and examples.</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="sd">Note that you can also let `gcloud-rest-storage` do its own session management,</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="sd">so long as you give us a hint when to close that session:</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="sd">```python</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="sd">with Storage() as client:</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="sd">    # closes the client.session on leaving the context manager</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="sd"># OR</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="sd">client = Storage()</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="sd"># do stuff</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="sd">client.close()  # close the session explicitly</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="sd">```</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="sd">## File Encodings</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="sd">In some cases, `aiohttp` needs to transform the objects returned from GCS into</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="sd">strings, eg. for debug logging and other such issues. The built-in `await</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="sd">response.text()` operation relies on [chardet][chardet] for guessing the</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="sd">character encoding in any cases where it can not be determined based on the</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="sd">file metadata.</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="sd">Unfortunately, this operation can be extremely slow, especially in cases where</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a><span class="sd">you might be working with particularly large files. If you notice odd latency</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a><span class="sd">issues when reading your results, you may want to set your character encoding</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="sd">more explicitly within GCS, eg. by ensuring you set the `contentType` of the</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="sd">relevant objects to something suffixed with `; charset=utf-8`. For example, in</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="sd">the case of `contentType=&#39;application/x-netcdf&#39;` files exhibiting latency, you</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="sd">could instead set `contentType=&#39;application/x-netcdf; charset=utf-8`. See</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="sd">[Issue #172][issue-172] for more info!</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">## Emulators</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a><span class="sd">For testing purposes, you may want to use `gcloud-rest-storage` along with a</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">local GCS emulator. Setting the `$STORAGE_EMULATOR_HOST` environment variable</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">to the address of your emulator should be enough to do the trick.</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">For example, using [fsouza/fake-gcs-server][fake-gcs-server], you can do:</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">```shell</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a><span class="sd">docker run -d -p 4443:4443 -v $PWD/my-sample-data:/data fsouza/fake-gcs-server</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">export STORAGE_EMULATOR_HOST=&#39;0.0.0.0:4443&#39;</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="sd">```</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="sd">Any `gcloud-rest-storage` requests made with that environment variable set will</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="sd">query `fake-gcs-server` instead of the official GCS API.</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a><span class="sd">Note that some emulation systems require disabling SSL -- if you&#39;re using a</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="sd">custom http session, you may need to disable SSL verification.</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a><span class="sd">## Customization</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="sd">This library mostly tries to stay agnostic of potential use-cases; as such, we</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="sd">do not implement any sort of retrying or other policies under the assumption</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="sd">that we wouldn&#39;t get things right for every user&#39;s situation.</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a><span class="sd">As such, we recommend configuring your own policies on an as-needed basis. The</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a><span class="sd">[backoff][backoff] library can make this quite straightforward! For example,</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="sd">you may find it useful to configure something like:</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a><span class="sd">```python</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="sd">class StorageWithBackoff(gcloud.rest.storage.Storage):</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a><span class="sd">    @backoff.on_exception(backoff.expo, aiohttp.ClientResponseError,</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a><span class="sd">                          max_tries=5, jitter=backoff.full_jitter)</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a><span class="sd">    def copy(self, *args: Any, **kwargs: Any):</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a><span class="sd">        return super().copy(*args, **kwargs)</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="sd">    @backoff.on_exception(backoff.expo, aiohttp.ClientResponseError,</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a><span class="sd">                          max_tries=10, jitter=backoff.full_jitter)</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a><span class="sd">    def download(self, *args: Any, **kwargs: Any):</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="sd">        return super().download(*args, **kwargs)</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a><span class="sd">```</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a><span class="sd">[backoff]: https://pypi.org/project/backoff/</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a><span class="sd">[chardet]: https://pypi.org/project/chardet/</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="sd">[fake-gcs-server]: https://github.com/fsouza/fake-gcs-server</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a><span class="sd">[issue-172]: https://github.com/talkiq/gcloud-rest/issues/172</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="sd">[smoke-test]:</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">https://github.com/talkiq/gcloud-rest/blob/master/storage/tests/integration/smoke_test.py</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a><span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="kn">import</span> <span class="n">get_distribution</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a><span class="n">__version__</span> <span class="o">=</span> <span class="n">get_distribution</span><span class="p">(</span><span class="s1">&#39;gcloud-rest-storage&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a><span class="kn">from</span> <span class="nn">gcloud.rest.storage.blob</span> <span class="kn">import</span> <span class="n">Blob</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a><span class="kn">from</span> <span class="nn">gcloud.rest.storage.bucket</span> <span class="kn">import</span> <span class="n">Bucket</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a><span class="kn">from</span> <span class="nn">gcloud.rest.storage.storage</span> <span class="kn">import</span> <span class="n">SCOPES</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a><span class="kn">from</span> <span class="nn">gcloud.rest.storage.storage</span> <span class="kn">import</span> <span class="n">Storage</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a><span class="kn">from</span> <span class="nn">gcloud.rest.storage.storage</span> <span class="kn">import</span> <span class="n">StreamResponse</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>    <span class="s1">&#39;Blob&#39;</span><span class="p">,</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>    <span class="s1">&#39;Bucket&#39;</span><span class="p">,</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>    <span class="s1">&#39;SCOPES&#39;</span><span class="p">,</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>    <span class="s1">&#39;Storage&#39;</span><span class="p">,</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>    <span class="s1">&#39;StreamResponse&#39;</span><span class="p">,</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>    <span class="s1">&#39;__version__&#39;</span><span class="p">,</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a><span class="p">]</span>
</span></pre></div>


            </section>
                <section id="Blob">
                            <input id="Blob-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Blob</span>:

                <label class="view-source-button" for="Blob-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Blob"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Blob-69"><a href="#Blob-69"><span class="linenos"> 69</span></a><span class="k">class</span> <span class="nc">Blob</span><span class="p">:</span>
</span><span id="Blob-70"><a href="#Blob-70"><span class="linenos"> 70</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="Blob-71"><a href="#Blob-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="s1">&#39;Bucket&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Blob-72"><a href="#Blob-72"><span class="linenos"> 72</span></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="Blob-73"><a href="#Blob-73"><span class="linenos"> 73</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Blob-74"><a href="#Blob-74"><span class="linenos"> 74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
</span><span id="Blob-75"><a href="#Blob-75"><span class="linenos"> 75</span></a>
</span><span id="Blob-76"><a href="#Blob-76"><span class="linenos"> 76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span> <span class="o">=</span> <span class="n">bucket</span>
</span><span id="Blob-77"><a href="#Blob-77"><span class="linenos"> 77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span><span id="Blob-78"><a href="#Blob-78"><span class="linenos"> 78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span><span id="Blob-79"><a href="#Blob-79"><span class="linenos"> 79</span></a>
</span><span id="Blob-80"><a href="#Blob-80"><span class="linenos"> 80</span></a>    <span class="nd">@property</span>
</span><span id="Blob-81"><a href="#Blob-81"><span class="linenos"> 81</span></a>    <span class="k">def</span> <span class="nf">chunk_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Blob-82"><a href="#Blob-82"><span class="linenos"> 82</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="p">(</span><span class="mi">262144</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">%</span> <span class="mi">262144</span><span class="p">))</span>
</span><span id="Blob-83"><a href="#Blob-83"><span class="linenos"> 83</span></a>
</span><span id="Blob-84"><a href="#Blob-84"><span class="linenos"> 84</span></a>    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span>
</span><span id="Blob-85"><a href="#Blob-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Blob-86"><a href="#Blob-86"><span class="linenos"> 86</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Blob-87"><a href="#Blob-87"><span class="linenos"> 87</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="Blob-88"><a href="#Blob-88"><span class="linenos"> 88</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">download</span><span class="p">(</span>
</span><span id="Blob-89"><a href="#Blob-89"><span class="linenos"> 89</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="Blob-90"><a href="#Blob-90"><span class="linenos"> 90</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="Blob-91"><a href="#Blob-91"><span class="linenos"> 91</span></a>            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Blob-92"><a href="#Blob-92"><span class="linenos"> 92</span></a>            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
</span><span id="Blob-93"><a href="#Blob-93"><span class="linenos"> 93</span></a>        <span class="p">)</span>
</span><span id="Blob-94"><a href="#Blob-94"><span class="linenos"> 94</span></a>
</span><span id="Blob-95"><a href="#Blob-95"><span class="linenos"> 95</span></a>    <span class="k">def</span> <span class="nf">upload</span><span class="p">(</span>
</span><span id="Blob-96"><a href="#Blob-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="Blob-97"><a href="#Blob-97"><span class="linenos"> 97</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Blob-98"><a href="#Blob-98"><span class="linenos"> 98</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Blob-99"><a href="#Blob-99"><span class="linenos"> 99</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span>
</span><span id="Blob-100"><a href="#Blob-100"><span class="linenos">100</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
</span><span id="Blob-101"><a href="#Blob-101"><span class="linenos">101</span></a>        <span class="p">)</span>
</span><span id="Blob-102"><a href="#Blob-102"><span class="linenos">102</span></a>
</span><span id="Blob-103"><a href="#Blob-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
</span><span id="Blob-104"><a href="#Blob-104"><span class="linenos">104</span></a>        <span class="k">return</span> <span class="n">metadata</span>
</span><span id="Blob-105"><a href="#Blob-105"><span class="linenos">105</span></a>
</span><span id="Blob-106"><a href="#Blob-106"><span class="linenos">106</span></a>    <span class="k">def</span> <span class="nf">get_signed_url</span><span class="p">(</span>  <span class="c1"># pylint: disable=too-many-locals</span>
</span><span id="Blob-107"><a href="#Blob-107"><span class="linenos">107</span></a>            <span class="bp">self</span><span class="p">,</span> <span class="n">expiration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Blob-108"><a href="#Blob-108"><span class="linenos">108</span></a>            <span class="n">query_params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Blob-109"><a href="#Blob-109"><span class="linenos">109</span></a>            <span class="n">http_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Token</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Blob-110"><a href="#Blob-110"><span class="linenos">110</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Blob-111"><a href="#Blob-111"><span class="linenos">111</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Blob-112"><a href="#Blob-112"><span class="linenos">112</span></a><span class="sd">        Create a temporary access URL for Storage Blob accessible by anyone</span>
</span><span id="Blob-113"><a href="#Blob-113"><span class="linenos">113</span></a><span class="sd">        with the link.</span>
</span><span id="Blob-114"><a href="#Blob-114"><span class="linenos">114</span></a>
</span><span id="Blob-115"><a href="#Blob-115"><span class="linenos">115</span></a><span class="sd">        Adapted from Google Documentation:</span>
</span><span id="Blob-116"><a href="#Blob-116"><span class="linenos">116</span></a><span class="sd">        https://cloud.google.com/storage/docs/access-control/signing-urls-manually#python-sample</span>
</span><span id="Blob-117"><a href="#Blob-117"><span class="linenos">117</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Blob-118"><a href="#Blob-118"><span class="linenos">118</span></a>        <span class="k">if</span> <span class="n">expiration</span> <span class="o">&gt;</span> <span class="mi">604800</span><span class="p">:</span>
</span><span id="Blob-119"><a href="#Blob-119"><span class="linenos">119</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Blob-120"><a href="#Blob-120"><span class="linenos">120</span></a>                <span class="s2">&quot;expiration time can&#39;t be longer than 604800 &quot;</span>
</span><span id="Blob-121"><a href="#Blob-121"><span class="linenos">121</span></a>                <span class="s1">&#39;seconds (7 days)&#39;</span><span class="p">,</span>
</span><span id="Blob-122"><a href="#Blob-122"><span class="linenos">122</span></a>            <span class="p">)</span>
</span><span id="Blob-123"><a href="#Blob-123"><span class="linenos">123</span></a>
</span><span id="Blob-124"><a href="#Blob-124"><span class="linenos">124</span></a>        <span class="n">quoted_name</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;/~&#39;</span><span class="p">)</span>
</span><span id="Blob-125"><a href="#Blob-125"><span class="linenos">125</span></a>        <span class="n">canonical_uri</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">quoted_name</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Blob-126"><a href="#Blob-126"><span class="linenos">126</span></a>
</span><span id="Blob-127"><a href="#Blob-127"><span class="linenos">127</span></a>        <span class="n">datetime_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
</span><span id="Blob-128"><a href="#Blob-128"><span class="linenos">128</span></a>        <span class="n">request_timestamp</span> <span class="o">=</span> <span class="n">datetime_now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">T%H%M%SZ&#39;</span><span class="p">)</span>
</span><span id="Blob-129"><a href="#Blob-129"><span class="linenos">129</span></a>        <span class="n">datestamp</span> <span class="o">=</span> <span class="n">datetime_now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="Blob-130"><a href="#Blob-130"><span class="linenos">130</span></a>
</span><span id="Blob-131"><a href="#Blob-131"><span class="linenos">131</span></a>        <span class="c1"># TODO: support for GCE_METADATA and AUTHORIZED_USER tokens. It should</span>
</span><span id="Blob-132"><a href="#Blob-132"><span class="linenos">132</span></a>        <span class="c1"># be possible via API, but seems to not be working for us in some</span>
</span><span id="Blob-133"><a href="#Blob-133"><span class="linenos">133</span></a>        <span class="c1"># cases.</span>
</span><span id="Blob-134"><a href="#Blob-134"><span class="linenos">134</span></a>        <span class="c1">#</span>
</span><span id="Blob-135"><a href="#Blob-135"><span class="linenos">135</span></a>        <span class="c1"># https://cloud.google.com/iam/docs/reference/credentials/rest/v1/</span>
</span><span id="Blob-136"><a href="#Blob-136"><span class="linenos">136</span></a>        <span class="c1"># projects.serviceAccounts/signBlob</span>
</span><span id="Blob-137"><a href="#Blob-137"><span class="linenos">137</span></a>        <span class="n">token</span> <span class="o">=</span> <span class="n">token</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">token</span>
</span><span id="Blob-138"><a href="#Blob-138"><span class="linenos">138</span></a>        <span class="n">client_email</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">service_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;client_email&#39;</span><span class="p">)</span>
</span><span id="Blob-139"><a href="#Blob-139"><span class="linenos">139</span></a>        <span class="n">private_key</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">service_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;private_key&#39;</span><span class="p">)</span>
</span><span id="Blob-140"><a href="#Blob-140"><span class="linenos">140</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">client_email</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">private_key</span><span class="p">:</span>
</span><span id="Blob-141"><a href="#Blob-141"><span class="linenos">141</span></a>            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
</span><span id="Blob-142"><a href="#Blob-142"><span class="linenos">142</span></a>                <span class="s1">&#39;Blob signing is only suported for tokens with &#39;</span>
</span><span id="Blob-143"><a href="#Blob-143"><span class="linenos">143</span></a>                <span class="s1">&#39;explicit client_email and private_key data; &#39;</span>
</span><span id="Blob-144"><a href="#Blob-144"><span class="linenos">144</span></a>                <span class="s1">&#39;please check your token points to a JSON service &#39;</span>
</span><span id="Blob-145"><a href="#Blob-145"><span class="linenos">145</span></a>                <span class="s1">&#39;account file&#39;</span><span class="p">,</span>
</span><span id="Blob-146"><a href="#Blob-146"><span class="linenos">146</span></a>            <span class="p">)</span>
</span><span id="Blob-147"><a href="#Blob-147"><span class="linenos">147</span></a>
</span><span id="Blob-148"><a href="#Blob-148"><span class="linenos">148</span></a>        <span class="n">credential_scope</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">datestamp</span><span class="si">}</span><span class="s1">/auto/storage/goog4_request&#39;</span>
</span><span id="Blob-149"><a href="#Blob-149"><span class="linenos">149</span></a>        <span class="n">credential</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">client_email</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">credential_scope</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Blob-150"><a href="#Blob-150"><span class="linenos">150</span></a>
</span><span id="Blob-151"><a href="#Blob-151"><span class="linenos">151</span></a>        <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Blob-152"><a href="#Blob-152"><span class="linenos">152</span></a>        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">HOST</span>
</span><span id="Blob-153"><a href="#Blob-153"><span class="linenos">153</span></a>
</span><span id="Blob-154"><a href="#Blob-154"><span class="linenos">154</span></a>        <span class="n">ordered_headers</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span>
</span><span id="Blob-155"><a href="#Blob-155"><span class="linenos">155</span></a>            <span class="nb">sorted</span><span class="p">(</span><span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
</span><span id="Blob-156"><a href="#Blob-156"><span class="linenos">156</span></a>        <span class="n">canonical_headers</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="Blob-157"><a href="#Blob-157"><span class="linenos">157</span></a>            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="Blob-158"><a href="#Blob-158"><span class="linenos">158</span></a>            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ordered_headers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Blob-159"><a href="#Blob-159"><span class="linenos">159</span></a>        <span class="p">)</span>
</span><span id="Blob-160"><a href="#Blob-160"><span class="linenos">160</span></a>
</span><span id="Blob-161"><a href="#Blob-161"><span class="linenos">161</span></a>        <span class="n">signed_headers</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="Blob-162"><a href="#Blob-162"><span class="linenos">162</span></a>            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ordered_headers</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="Blob-163"><a href="#Blob-163"><span class="linenos">163</span></a>        <span class="p">)</span>
</span><span id="Blob-164"><a href="#Blob-164"><span class="linenos">164</span></a>
</span><span id="Blob-165"><a href="#Blob-165"><span class="linenos">165</span></a>        <span class="n">query_params</span> <span class="o">=</span> <span class="n">query_params</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Blob-166"><a href="#Blob-166"><span class="linenos">166</span></a>        <span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;X-Goog-Algorithm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;GOOG4-RSA-SHA256&#39;</span>
</span><span id="Blob-167"><a href="#Blob-167"><span class="linenos">167</span></a>        <span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;X-Goog-Credential&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">credential</span>
</span><span id="Blob-168"><a href="#Blob-168"><span class="linenos">168</span></a>        <span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;X-Goog-Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request_timestamp</span>
</span><span id="Blob-169"><a href="#Blob-169"><span class="linenos">169</span></a>        <span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;X-Goog-Expires&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expiration</span>
</span><span id="Blob-170"><a href="#Blob-170"><span class="linenos">170</span></a>        <span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;X-Goog-SignedHeaders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signed_headers</span>
</span><span id="Blob-171"><a href="#Blob-171"><span class="linenos">171</span></a>
</span><span id="Blob-172"><a href="#Blob-172"><span class="linenos">172</span></a>        <span class="n">ordered_query_params</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span>
</span><span id="Blob-173"><a href="#Blob-173"><span class="linenos">173</span></a>            <span class="nb">sorted</span><span class="p">(</span><span class="n">query_params</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
</span><span id="Blob-174"><a href="#Blob-174"><span class="linenos">174</span></a>        <span class="p">)</span>
</span><span id="Blob-175"><a href="#Blob-175"><span class="linenos">175</span></a>
</span><span id="Blob-176"><a href="#Blob-176"><span class="linenos">176</span></a>        <span class="n">canonical_query_str</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="Blob-177"><a href="#Blob-177"><span class="linenos">177</span></a>            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">quote</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="n">safe</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">quote</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">),</span><span class="w"> </span><span class="n">safe</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Blob-178"><a href="#Blob-178"><span class="linenos">178</span></a>            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ordered_query_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Blob-179"><a href="#Blob-179"><span class="linenos">179</span></a>        <span class="p">)</span>
</span><span id="Blob-180"><a href="#Blob-180"><span class="linenos">180</span></a>
</span><span id="Blob-181"><a href="#Blob-181"><span class="linenos">181</span></a>        <span class="n">canonical_req</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
</span><span id="Blob-182"><a href="#Blob-182"><span class="linenos">182</span></a>            <span class="n">http_method</span><span class="p">,</span> <span class="n">canonical_uri</span><span class="p">,</span>
</span><span id="Blob-183"><a href="#Blob-183"><span class="linenos">183</span></a>            <span class="n">canonical_query_str</span><span class="p">,</span> <span class="n">canonical_headers</span><span class="p">,</span>
</span><span id="Blob-184"><a href="#Blob-184"><span class="linenos">184</span></a>            <span class="n">signed_headers</span><span class="p">,</span> <span class="s1">&#39;UNSIGNED-PAYLOAD&#39;</span><span class="p">,</span>
</span><span id="Blob-185"><a href="#Blob-185"><span class="linenos">185</span></a>        <span class="p">])</span>
</span><span id="Blob-186"><a href="#Blob-186"><span class="linenos">186</span></a>        <span class="n">canonical_req_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">canonical_req</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span><span id="Blob-187"><a href="#Blob-187"><span class="linenos">187</span></a>
</span><span id="Blob-188"><a href="#Blob-188"><span class="linenos">188</span></a>        <span class="n">str_to_sign</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
</span><span id="Blob-189"><a href="#Blob-189"><span class="linenos">189</span></a>            <span class="s1">&#39;GOOG4-RSA-SHA256&#39;</span><span class="p">,</span> <span class="n">request_timestamp</span><span class="p">,</span>
</span><span id="Blob-190"><a href="#Blob-190"><span class="linenos">190</span></a>            <span class="n">credential_scope</span><span class="p">,</span> <span class="n">canonical_req_hash</span><span class="p">,</span>
</span><span id="Blob-191"><a href="#Blob-191"><span class="linenos">191</span></a>        <span class="p">])</span>
</span><span id="Blob-192"><a href="#Blob-192"><span class="linenos">192</span></a>
</span><span id="Blob-193"><a href="#Blob-193"><span class="linenos">193</span></a>        <span class="c1"># N.B. see the ``PemKind`` enum</span>
</span><span id="Blob-194"><a href="#Blob-194"><span class="linenos">194</span></a>        <span class="n">marker_id</span><span class="p">,</span> <span class="n">key_bytes</span> <span class="o">=</span> <span class="n">pem</span><span class="o">.</span><span class="n">readPemBlocksFromFile</span><span class="p">(</span>
</span><span id="Blob-195"><a href="#Blob-195"><span class="linenos">195</span></a>            <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">private_key</span><span class="p">),</span> <span class="n">PKCS1_MARKER</span><span class="p">,</span> <span class="n">PKCS8_MARKER</span><span class="p">,</span>
</span><span id="Blob-196"><a href="#Blob-196"><span class="linenos">196</span></a>        <span class="p">)</span>
</span><span id="Blob-197"><a href="#Blob-197"><span class="linenos">197</span></a>        <span class="k">if</span> <span class="n">marker_id</span> <span class="o">==</span> <span class="n">PemKind</span><span class="o">.</span><span class="n">INVALID</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
</span><span id="Blob-198"><a href="#Blob-198"><span class="linenos">198</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;private key is invalid or unsupported&#39;</span><span class="p">)</span>
</span><span id="Blob-199"><a href="#Blob-199"><span class="linenos">199</span></a>
</span><span id="Blob-200"><a href="#Blob-200"><span class="linenos">200</span></a>        <span class="k">if</span> <span class="n">marker_id</span> <span class="o">==</span> <span class="n">PemKind</span><span class="o">.</span><span class="n">PKCS8</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
</span><span id="Blob-201"><a href="#Blob-201"><span class="linenos">201</span></a>            <span class="c1"># convert from pkcs8 to pkcs1</span>
</span><span id="Blob-202"><a href="#Blob-202"><span class="linenos">202</span></a>            <span class="n">key_info</span><span class="p">,</span> <span class="n">remaining</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
</span><span id="Blob-203"><a href="#Blob-203"><span class="linenos">203</span></a>                <span class="n">key_bytes</span><span class="p">,</span>
</span><span id="Blob-204"><a href="#Blob-204"><span class="linenos">204</span></a>                <span class="n">asn1Spec</span><span class="o">=</span><span class="n">PKCS8_SPEC</span><span class="p">,</span>
</span><span id="Blob-205"><a href="#Blob-205"><span class="linenos">205</span></a>            <span class="p">)</span>
</span><span id="Blob-206"><a href="#Blob-206"><span class="linenos">206</span></a>            <span class="k">if</span> <span class="n">remaining</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
</span><span id="Blob-207"><a href="#Blob-207"><span class="linenos">207</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Blob-208"><a href="#Blob-208"><span class="linenos">208</span></a>                    <span class="s1">&#39;could not read PKCS8 key: found extra bytes&#39;</span><span class="p">,</span>
</span><span id="Blob-209"><a href="#Blob-209"><span class="linenos">209</span></a>                    <span class="n">remaining</span><span class="p">,</span>
</span><span id="Blob-210"><a href="#Blob-210"><span class="linenos">210</span></a>                <span class="p">)</span>
</span><span id="Blob-211"><a href="#Blob-211"><span class="linenos">211</span></a>
</span><span id="Blob-212"><a href="#Blob-212"><span class="linenos">212</span></a>            <span class="n">private_key_info</span> <span class="o">=</span> <span class="n">key_info</span><span class="o">.</span><span class="n">getComponentByName</span><span class="p">(</span><span class="s1">&#39;privateKey&#39;</span><span class="p">)</span>
</span><span id="Blob-213"><a href="#Blob-213"><span class="linenos">213</span></a>            <span class="n">key_bytes</span> <span class="o">=</span> <span class="n">private_key_info</span><span class="o">.</span><span class="n">asOctets</span><span class="p">()</span>
</span><span id="Blob-214"><a href="#Blob-214"><span class="linenos">214</span></a>
</span><span id="Blob-215"><a href="#Blob-215"><span class="linenos">215</span></a>        <span class="n">key</span> <span class="o">=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">PrivateKey</span><span class="o">.</span><span class="n">load_pkcs1</span><span class="p">(</span><span class="n">key_bytes</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;DER&#39;</span><span class="p">)</span>
</span><span id="Blob-216"><a href="#Blob-216"><span class="linenos">216</span></a>        <span class="n">signed_blob</span> <span class="o">=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">pkcs1</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">str_to_sign</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39;SHA-256&#39;</span><span class="p">)</span>
</span><span id="Blob-217"><a href="#Blob-217"><span class="linenos">217</span></a>
</span><span id="Blob-218"><a href="#Blob-218"><span class="linenos">218</span></a>        <span class="n">signature</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">signed_blob</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span><span id="Blob-219"><a href="#Blob-219"><span class="linenos">219</span></a>
</span><span id="Blob-220"><a href="#Blob-220"><span class="linenos">220</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="Blob-221"><a href="#Blob-221"><span class="linenos">221</span></a>            <span class="sa">f</span><span class="s1">&#39;https://</span><span class="si">{</span><span class="n">HOST</span><span class="si">}{</span><span class="n">canonical_uri</span><span class="si">}</span><span class="s1">?&#39;</span>
</span><span id="Blob-222"><a href="#Blob-222"><span class="linenos">222</span></a>            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">canonical_query_str</span><span class="si">}</span><span class="s1">&amp;X-Goog-Signature=</span><span class="si">{</span><span class="n">signature</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Blob-223"><a href="#Blob-223"><span class="linenos">223</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            <div id="Blob.__init__" class="classattr">
                                        <input id="Blob.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Blob</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">bucket</span><span class="p">:</span> <span class="n"><a href="#Bucket">Bucket</a></span>,</span><span class="param">	<span class="n">name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span></span>)</span>

                <label class="view-source-button" for="Blob.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Blob.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Blob.__init__-70"><a href="#Blob.__init__-70"><span class="linenos">70</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="Blob.__init__-71"><a href="#Blob.__init__-71"><span class="linenos">71</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="s1">&#39;Bucket&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Blob.__init__-72"><a href="#Blob.__init__-72"><span class="linenos">72</span></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="Blob.__init__-73"><a href="#Blob.__init__-73"><span class="linenos">73</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Blob.__init__-74"><a href="#Blob.__init__-74"><span class="linenos">74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
</span><span id="Blob.__init__-75"><a href="#Blob.__init__-75"><span class="linenos">75</span></a>
</span><span id="Blob.__init__-76"><a href="#Blob.__init__-76"><span class="linenos">76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span> <span class="o">=</span> <span class="n">bucket</span>
</span><span id="Blob.__init__-77"><a href="#Blob.__init__-77"><span class="linenos">77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span><span id="Blob.__init__-78"><a href="#Blob.__init__-78"><span class="linenos">78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="Blob.bucket" class="classattr">
                                <div class="attr variable">
            <span class="name">bucket</span>

        
    </div>
    <a class="headerlink" href="#Blob.bucket"></a>
    
    

                            </div>
                            <div id="Blob.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span>

        
    </div>
    <a class="headerlink" href="#Blob.name"></a>
    
    

                            </div>
                            <div id="Blob.size" class="classattr">
                                <div class="attr variable">
            <span class="name">size</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#Blob.size"></a>
    
    

                            </div>
                            <div id="Blob.chunk_size" class="classattr">
                                <div class="attr variable">
            <span class="name">chunk_size</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#Blob.chunk_size"></a>
    
    

                            </div>
                            <div id="Blob.download" class="classattr">
                                        <input id="Blob.download-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">download</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">requests</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Any</span>:</span></span>

                <label class="view-source-button" for="Blob.download-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Blob.download"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Blob.download-84"><a href="#Blob.download-84"><span class="linenos">84</span></a>    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span>
</span><span id="Blob.download-85"><a href="#Blob.download-85"><span class="linenos">85</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Blob.download-86"><a href="#Blob.download-86"><span class="linenos">86</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Blob.download-87"><a href="#Blob.download-87"><span class="linenos">87</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="Blob.download-88"><a href="#Blob.download-88"><span class="linenos">88</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">download</span><span class="p">(</span>
</span><span id="Blob.download-89"><a href="#Blob.download-89"><span class="linenos">89</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="Blob.download-90"><a href="#Blob.download-90"><span class="linenos">90</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="Blob.download-91"><a href="#Blob.download-91"><span class="linenos">91</span></a>            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Blob.download-92"><a href="#Blob.download-92"><span class="linenos">92</span></a>            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
</span><span id="Blob.download-93"><a href="#Blob.download-93"><span class="linenos">93</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="Blob.upload" class="classattr">
                                        <input id="Blob.upload-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">upload</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">data</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">requests</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Blob.upload-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Blob.upload"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Blob.upload-95"><a href="#Blob.upload-95"><span class="linenos"> 95</span></a>    <span class="k">def</span> <span class="nf">upload</span><span class="p">(</span>
</span><span id="Blob.upload-96"><a href="#Blob.upload-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="Blob.upload-97"><a href="#Blob.upload-97"><span class="linenos"> 97</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Blob.upload-98"><a href="#Blob.upload-98"><span class="linenos"> 98</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Blob.upload-99"><a href="#Blob.upload-99"><span class="linenos"> 99</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span>
</span><span id="Blob.upload-100"><a href="#Blob.upload-100"><span class="linenos">100</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
</span><span id="Blob.upload-101"><a href="#Blob.upload-101"><span class="linenos">101</span></a>        <span class="p">)</span>
</span><span id="Blob.upload-102"><a href="#Blob.upload-102"><span class="linenos">102</span></a>
</span><span id="Blob.upload-103"><a href="#Blob.upload-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
</span><span id="Blob.upload-104"><a href="#Blob.upload-104"><span class="linenos">104</span></a>        <span class="k">return</span> <span class="n">metadata</span>
</span></pre></div>


    

                            </div>
                            <div id="Blob.get_signed_url" class="classattr">
                                        <input id="Blob.get_signed_url-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_signed_url</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">expiration</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">query_params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">http_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span>,</span><span class="param">	<span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">gcloud</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="Blob.get_signed_url-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Blob.get_signed_url"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Blob.get_signed_url-106"><a href="#Blob.get_signed_url-106"><span class="linenos">106</span></a>    <span class="k">def</span> <span class="nf">get_signed_url</span><span class="p">(</span>  <span class="c1"># pylint: disable=too-many-locals</span>
</span><span id="Blob.get_signed_url-107"><a href="#Blob.get_signed_url-107"><span class="linenos">107</span></a>            <span class="bp">self</span><span class="p">,</span> <span class="n">expiration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Blob.get_signed_url-108"><a href="#Blob.get_signed_url-108"><span class="linenos">108</span></a>            <span class="n">query_params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Blob.get_signed_url-109"><a href="#Blob.get_signed_url-109"><span class="linenos">109</span></a>            <span class="n">http_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Token</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Blob.get_signed_url-110"><a href="#Blob.get_signed_url-110"><span class="linenos">110</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Blob.get_signed_url-111"><a href="#Blob.get_signed_url-111"><span class="linenos">111</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Blob.get_signed_url-112"><a href="#Blob.get_signed_url-112"><span class="linenos">112</span></a><span class="sd">        Create a temporary access URL for Storage Blob accessible by anyone</span>
</span><span id="Blob.get_signed_url-113"><a href="#Blob.get_signed_url-113"><span class="linenos">113</span></a><span class="sd">        with the link.</span>
</span><span id="Blob.get_signed_url-114"><a href="#Blob.get_signed_url-114"><span class="linenos">114</span></a>
</span><span id="Blob.get_signed_url-115"><a href="#Blob.get_signed_url-115"><span class="linenos">115</span></a><span class="sd">        Adapted from Google Documentation:</span>
</span><span id="Blob.get_signed_url-116"><a href="#Blob.get_signed_url-116"><span class="linenos">116</span></a><span class="sd">        https://cloud.google.com/storage/docs/access-control/signing-urls-manually#python-sample</span>
</span><span id="Blob.get_signed_url-117"><a href="#Blob.get_signed_url-117"><span class="linenos">117</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Blob.get_signed_url-118"><a href="#Blob.get_signed_url-118"><span class="linenos">118</span></a>        <span class="k">if</span> <span class="n">expiration</span> <span class="o">&gt;</span> <span class="mi">604800</span><span class="p">:</span>
</span><span id="Blob.get_signed_url-119"><a href="#Blob.get_signed_url-119"><span class="linenos">119</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Blob.get_signed_url-120"><a href="#Blob.get_signed_url-120"><span class="linenos">120</span></a>                <span class="s2">&quot;expiration time can&#39;t be longer than 604800 &quot;</span>
</span><span id="Blob.get_signed_url-121"><a href="#Blob.get_signed_url-121"><span class="linenos">121</span></a>                <span class="s1">&#39;seconds (7 days)&#39;</span><span class="p">,</span>
</span><span id="Blob.get_signed_url-122"><a href="#Blob.get_signed_url-122"><span class="linenos">122</span></a>            <span class="p">)</span>
</span><span id="Blob.get_signed_url-123"><a href="#Blob.get_signed_url-123"><span class="linenos">123</span></a>
</span><span id="Blob.get_signed_url-124"><a href="#Blob.get_signed_url-124"><span class="linenos">124</span></a>        <span class="n">quoted_name</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;/~&#39;</span><span class="p">)</span>
</span><span id="Blob.get_signed_url-125"><a href="#Blob.get_signed_url-125"><span class="linenos">125</span></a>        <span class="n">canonical_uri</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">quoted_name</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Blob.get_signed_url-126"><a href="#Blob.get_signed_url-126"><span class="linenos">126</span></a>
</span><span id="Blob.get_signed_url-127"><a href="#Blob.get_signed_url-127"><span class="linenos">127</span></a>        <span class="n">datetime_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
</span><span id="Blob.get_signed_url-128"><a href="#Blob.get_signed_url-128"><span class="linenos">128</span></a>        <span class="n">request_timestamp</span> <span class="o">=</span> <span class="n">datetime_now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">T%H%M%SZ&#39;</span><span class="p">)</span>
</span><span id="Blob.get_signed_url-129"><a href="#Blob.get_signed_url-129"><span class="linenos">129</span></a>        <span class="n">datestamp</span> <span class="o">=</span> <span class="n">datetime_now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="Blob.get_signed_url-130"><a href="#Blob.get_signed_url-130"><span class="linenos">130</span></a>
</span><span id="Blob.get_signed_url-131"><a href="#Blob.get_signed_url-131"><span class="linenos">131</span></a>        <span class="c1"># TODO: support for GCE_METADATA and AUTHORIZED_USER tokens. It should</span>
</span><span id="Blob.get_signed_url-132"><a href="#Blob.get_signed_url-132"><span class="linenos">132</span></a>        <span class="c1"># be possible via API, but seems to not be working for us in some</span>
</span><span id="Blob.get_signed_url-133"><a href="#Blob.get_signed_url-133"><span class="linenos">133</span></a>        <span class="c1"># cases.</span>
</span><span id="Blob.get_signed_url-134"><a href="#Blob.get_signed_url-134"><span class="linenos">134</span></a>        <span class="c1">#</span>
</span><span id="Blob.get_signed_url-135"><a href="#Blob.get_signed_url-135"><span class="linenos">135</span></a>        <span class="c1"># https://cloud.google.com/iam/docs/reference/credentials/rest/v1/</span>
</span><span id="Blob.get_signed_url-136"><a href="#Blob.get_signed_url-136"><span class="linenos">136</span></a>        <span class="c1"># projects.serviceAccounts/signBlob</span>
</span><span id="Blob.get_signed_url-137"><a href="#Blob.get_signed_url-137"><span class="linenos">137</span></a>        <span class="n">token</span> <span class="o">=</span> <span class="n">token</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">token</span>
</span><span id="Blob.get_signed_url-138"><a href="#Blob.get_signed_url-138"><span class="linenos">138</span></a>        <span class="n">client_email</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">service_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;client_email&#39;</span><span class="p">)</span>
</span><span id="Blob.get_signed_url-139"><a href="#Blob.get_signed_url-139"><span class="linenos">139</span></a>        <span class="n">private_key</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">service_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;private_key&#39;</span><span class="p">)</span>
</span><span id="Blob.get_signed_url-140"><a href="#Blob.get_signed_url-140"><span class="linenos">140</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">client_email</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">private_key</span><span class="p">:</span>
</span><span id="Blob.get_signed_url-141"><a href="#Blob.get_signed_url-141"><span class="linenos">141</span></a>            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
</span><span id="Blob.get_signed_url-142"><a href="#Blob.get_signed_url-142"><span class="linenos">142</span></a>                <span class="s1">&#39;Blob signing is only suported for tokens with &#39;</span>
</span><span id="Blob.get_signed_url-143"><a href="#Blob.get_signed_url-143"><span class="linenos">143</span></a>                <span class="s1">&#39;explicit client_email and private_key data; &#39;</span>
</span><span id="Blob.get_signed_url-144"><a href="#Blob.get_signed_url-144"><span class="linenos">144</span></a>                <span class="s1">&#39;please check your token points to a JSON service &#39;</span>
</span><span id="Blob.get_signed_url-145"><a href="#Blob.get_signed_url-145"><span class="linenos">145</span></a>                <span class="s1">&#39;account file&#39;</span><span class="p">,</span>
</span><span id="Blob.get_signed_url-146"><a href="#Blob.get_signed_url-146"><span class="linenos">146</span></a>            <span class="p">)</span>
</span><span id="Blob.get_signed_url-147"><a href="#Blob.get_signed_url-147"><span class="linenos">147</span></a>
</span><span id="Blob.get_signed_url-148"><a href="#Blob.get_signed_url-148"><span class="linenos">148</span></a>        <span class="n">credential_scope</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">datestamp</span><span class="si">}</span><span class="s1">/auto/storage/goog4_request&#39;</span>
</span><span id="Blob.get_signed_url-149"><a href="#Blob.get_signed_url-149"><span class="linenos">149</span></a>        <span class="n">credential</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">client_email</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">credential_scope</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Blob.get_signed_url-150"><a href="#Blob.get_signed_url-150"><span class="linenos">150</span></a>
</span><span id="Blob.get_signed_url-151"><a href="#Blob.get_signed_url-151"><span class="linenos">151</span></a>        <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Blob.get_signed_url-152"><a href="#Blob.get_signed_url-152"><span class="linenos">152</span></a>        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">HOST</span>
</span><span id="Blob.get_signed_url-153"><a href="#Blob.get_signed_url-153"><span class="linenos">153</span></a>
</span><span id="Blob.get_signed_url-154"><a href="#Blob.get_signed_url-154"><span class="linenos">154</span></a>        <span class="n">ordered_headers</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span>
</span><span id="Blob.get_signed_url-155"><a href="#Blob.get_signed_url-155"><span class="linenos">155</span></a>            <span class="nb">sorted</span><span class="p">(</span><span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
</span><span id="Blob.get_signed_url-156"><a href="#Blob.get_signed_url-156"><span class="linenos">156</span></a>        <span class="n">canonical_headers</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="Blob.get_signed_url-157"><a href="#Blob.get_signed_url-157"><span class="linenos">157</span></a>            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="Blob.get_signed_url-158"><a href="#Blob.get_signed_url-158"><span class="linenos">158</span></a>            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ordered_headers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Blob.get_signed_url-159"><a href="#Blob.get_signed_url-159"><span class="linenos">159</span></a>        <span class="p">)</span>
</span><span id="Blob.get_signed_url-160"><a href="#Blob.get_signed_url-160"><span class="linenos">160</span></a>
</span><span id="Blob.get_signed_url-161"><a href="#Blob.get_signed_url-161"><span class="linenos">161</span></a>        <span class="n">signed_headers</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="Blob.get_signed_url-162"><a href="#Blob.get_signed_url-162"><span class="linenos">162</span></a>            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ordered_headers</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="Blob.get_signed_url-163"><a href="#Blob.get_signed_url-163"><span class="linenos">163</span></a>        <span class="p">)</span>
</span><span id="Blob.get_signed_url-164"><a href="#Blob.get_signed_url-164"><span class="linenos">164</span></a>
</span><span id="Blob.get_signed_url-165"><a href="#Blob.get_signed_url-165"><span class="linenos">165</span></a>        <span class="n">query_params</span> <span class="o">=</span> <span class="n">query_params</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Blob.get_signed_url-166"><a href="#Blob.get_signed_url-166"><span class="linenos">166</span></a>        <span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;X-Goog-Algorithm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;GOOG4-RSA-SHA256&#39;</span>
</span><span id="Blob.get_signed_url-167"><a href="#Blob.get_signed_url-167"><span class="linenos">167</span></a>        <span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;X-Goog-Credential&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">credential</span>
</span><span id="Blob.get_signed_url-168"><a href="#Blob.get_signed_url-168"><span class="linenos">168</span></a>        <span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;X-Goog-Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request_timestamp</span>
</span><span id="Blob.get_signed_url-169"><a href="#Blob.get_signed_url-169"><span class="linenos">169</span></a>        <span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;X-Goog-Expires&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expiration</span>
</span><span id="Blob.get_signed_url-170"><a href="#Blob.get_signed_url-170"><span class="linenos">170</span></a>        <span class="n">query_params</span><span class="p">[</span><span class="s1">&#39;X-Goog-SignedHeaders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signed_headers</span>
</span><span id="Blob.get_signed_url-171"><a href="#Blob.get_signed_url-171"><span class="linenos">171</span></a>
</span><span id="Blob.get_signed_url-172"><a href="#Blob.get_signed_url-172"><span class="linenos">172</span></a>        <span class="n">ordered_query_params</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span>
</span><span id="Blob.get_signed_url-173"><a href="#Blob.get_signed_url-173"><span class="linenos">173</span></a>            <span class="nb">sorted</span><span class="p">(</span><span class="n">query_params</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
</span><span id="Blob.get_signed_url-174"><a href="#Blob.get_signed_url-174"><span class="linenos">174</span></a>        <span class="p">)</span>
</span><span id="Blob.get_signed_url-175"><a href="#Blob.get_signed_url-175"><span class="linenos">175</span></a>
</span><span id="Blob.get_signed_url-176"><a href="#Blob.get_signed_url-176"><span class="linenos">176</span></a>        <span class="n">canonical_query_str</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="Blob.get_signed_url-177"><a href="#Blob.get_signed_url-177"><span class="linenos">177</span></a>            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">quote</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="n">safe</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">quote</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">),</span><span class="w"> </span><span class="n">safe</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Blob.get_signed_url-178"><a href="#Blob.get_signed_url-178"><span class="linenos">178</span></a>            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ordered_query_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Blob.get_signed_url-179"><a href="#Blob.get_signed_url-179"><span class="linenos">179</span></a>        <span class="p">)</span>
</span><span id="Blob.get_signed_url-180"><a href="#Blob.get_signed_url-180"><span class="linenos">180</span></a>
</span><span id="Blob.get_signed_url-181"><a href="#Blob.get_signed_url-181"><span class="linenos">181</span></a>        <span class="n">canonical_req</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
</span><span id="Blob.get_signed_url-182"><a href="#Blob.get_signed_url-182"><span class="linenos">182</span></a>            <span class="n">http_method</span><span class="p">,</span> <span class="n">canonical_uri</span><span class="p">,</span>
</span><span id="Blob.get_signed_url-183"><a href="#Blob.get_signed_url-183"><span class="linenos">183</span></a>            <span class="n">canonical_query_str</span><span class="p">,</span> <span class="n">canonical_headers</span><span class="p">,</span>
</span><span id="Blob.get_signed_url-184"><a href="#Blob.get_signed_url-184"><span class="linenos">184</span></a>            <span class="n">signed_headers</span><span class="p">,</span> <span class="s1">&#39;UNSIGNED-PAYLOAD&#39;</span><span class="p">,</span>
</span><span id="Blob.get_signed_url-185"><a href="#Blob.get_signed_url-185"><span class="linenos">185</span></a>        <span class="p">])</span>
</span><span id="Blob.get_signed_url-186"><a href="#Blob.get_signed_url-186"><span class="linenos">186</span></a>        <span class="n">canonical_req_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">canonical_req</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span><span id="Blob.get_signed_url-187"><a href="#Blob.get_signed_url-187"><span class="linenos">187</span></a>
</span><span id="Blob.get_signed_url-188"><a href="#Blob.get_signed_url-188"><span class="linenos">188</span></a>        <span class="n">str_to_sign</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
</span><span id="Blob.get_signed_url-189"><a href="#Blob.get_signed_url-189"><span class="linenos">189</span></a>            <span class="s1">&#39;GOOG4-RSA-SHA256&#39;</span><span class="p">,</span> <span class="n">request_timestamp</span><span class="p">,</span>
</span><span id="Blob.get_signed_url-190"><a href="#Blob.get_signed_url-190"><span class="linenos">190</span></a>            <span class="n">credential_scope</span><span class="p">,</span> <span class="n">canonical_req_hash</span><span class="p">,</span>
</span><span id="Blob.get_signed_url-191"><a href="#Blob.get_signed_url-191"><span class="linenos">191</span></a>        <span class="p">])</span>
</span><span id="Blob.get_signed_url-192"><a href="#Blob.get_signed_url-192"><span class="linenos">192</span></a>
</span><span id="Blob.get_signed_url-193"><a href="#Blob.get_signed_url-193"><span class="linenos">193</span></a>        <span class="c1"># N.B. see the ``PemKind`` enum</span>
</span><span id="Blob.get_signed_url-194"><a href="#Blob.get_signed_url-194"><span class="linenos">194</span></a>        <span class="n">marker_id</span><span class="p">,</span> <span class="n">key_bytes</span> <span class="o">=</span> <span class="n">pem</span><span class="o">.</span><span class="n">readPemBlocksFromFile</span><span class="p">(</span>
</span><span id="Blob.get_signed_url-195"><a href="#Blob.get_signed_url-195"><span class="linenos">195</span></a>            <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">private_key</span><span class="p">),</span> <span class="n">PKCS1_MARKER</span><span class="p">,</span> <span class="n">PKCS8_MARKER</span><span class="p">,</span>
</span><span id="Blob.get_signed_url-196"><a href="#Blob.get_signed_url-196"><span class="linenos">196</span></a>        <span class="p">)</span>
</span><span id="Blob.get_signed_url-197"><a href="#Blob.get_signed_url-197"><span class="linenos">197</span></a>        <span class="k">if</span> <span class="n">marker_id</span> <span class="o">==</span> <span class="n">PemKind</span><span class="o">.</span><span class="n">INVALID</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
</span><span id="Blob.get_signed_url-198"><a href="#Blob.get_signed_url-198"><span class="linenos">198</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;private key is invalid or unsupported&#39;</span><span class="p">)</span>
</span><span id="Blob.get_signed_url-199"><a href="#Blob.get_signed_url-199"><span class="linenos">199</span></a>
</span><span id="Blob.get_signed_url-200"><a href="#Blob.get_signed_url-200"><span class="linenos">200</span></a>        <span class="k">if</span> <span class="n">marker_id</span> <span class="o">==</span> <span class="n">PemKind</span><span class="o">.</span><span class="n">PKCS8</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
</span><span id="Blob.get_signed_url-201"><a href="#Blob.get_signed_url-201"><span class="linenos">201</span></a>            <span class="c1"># convert from pkcs8 to pkcs1</span>
</span><span id="Blob.get_signed_url-202"><a href="#Blob.get_signed_url-202"><span class="linenos">202</span></a>            <span class="n">key_info</span><span class="p">,</span> <span class="n">remaining</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
</span><span id="Blob.get_signed_url-203"><a href="#Blob.get_signed_url-203"><span class="linenos">203</span></a>                <span class="n">key_bytes</span><span class="p">,</span>
</span><span id="Blob.get_signed_url-204"><a href="#Blob.get_signed_url-204"><span class="linenos">204</span></a>                <span class="n">asn1Spec</span><span class="o">=</span><span class="n">PKCS8_SPEC</span><span class="p">,</span>
</span><span id="Blob.get_signed_url-205"><a href="#Blob.get_signed_url-205"><span class="linenos">205</span></a>            <span class="p">)</span>
</span><span id="Blob.get_signed_url-206"><a href="#Blob.get_signed_url-206"><span class="linenos">206</span></a>            <span class="k">if</span> <span class="n">remaining</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
</span><span id="Blob.get_signed_url-207"><a href="#Blob.get_signed_url-207"><span class="linenos">207</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Blob.get_signed_url-208"><a href="#Blob.get_signed_url-208"><span class="linenos">208</span></a>                    <span class="s1">&#39;could not read PKCS8 key: found extra bytes&#39;</span><span class="p">,</span>
</span><span id="Blob.get_signed_url-209"><a href="#Blob.get_signed_url-209"><span class="linenos">209</span></a>                    <span class="n">remaining</span><span class="p">,</span>
</span><span id="Blob.get_signed_url-210"><a href="#Blob.get_signed_url-210"><span class="linenos">210</span></a>                <span class="p">)</span>
</span><span id="Blob.get_signed_url-211"><a href="#Blob.get_signed_url-211"><span class="linenos">211</span></a>
</span><span id="Blob.get_signed_url-212"><a href="#Blob.get_signed_url-212"><span class="linenos">212</span></a>            <span class="n">private_key_info</span> <span class="o">=</span> <span class="n">key_info</span><span class="o">.</span><span class="n">getComponentByName</span><span class="p">(</span><span class="s1">&#39;privateKey&#39;</span><span class="p">)</span>
</span><span id="Blob.get_signed_url-213"><a href="#Blob.get_signed_url-213"><span class="linenos">213</span></a>            <span class="n">key_bytes</span> <span class="o">=</span> <span class="n">private_key_info</span><span class="o">.</span><span class="n">asOctets</span><span class="p">()</span>
</span><span id="Blob.get_signed_url-214"><a href="#Blob.get_signed_url-214"><span class="linenos">214</span></a>
</span><span id="Blob.get_signed_url-215"><a href="#Blob.get_signed_url-215"><span class="linenos">215</span></a>        <span class="n">key</span> <span class="o">=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">PrivateKey</span><span class="o">.</span><span class="n">load_pkcs1</span><span class="p">(</span><span class="n">key_bytes</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;DER&#39;</span><span class="p">)</span>
</span><span id="Blob.get_signed_url-216"><a href="#Blob.get_signed_url-216"><span class="linenos">216</span></a>        <span class="n">signed_blob</span> <span class="o">=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">pkcs1</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">str_to_sign</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39;SHA-256&#39;</span><span class="p">)</span>
</span><span id="Blob.get_signed_url-217"><a href="#Blob.get_signed_url-217"><span class="linenos">217</span></a>
</span><span id="Blob.get_signed_url-218"><a href="#Blob.get_signed_url-218"><span class="linenos">218</span></a>        <span class="n">signature</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">signed_blob</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span><span id="Blob.get_signed_url-219"><a href="#Blob.get_signed_url-219"><span class="linenos">219</span></a>
</span><span id="Blob.get_signed_url-220"><a href="#Blob.get_signed_url-220"><span class="linenos">220</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="Blob.get_signed_url-221"><a href="#Blob.get_signed_url-221"><span class="linenos">221</span></a>            <span class="sa">f</span><span class="s1">&#39;https://</span><span class="si">{</span><span class="n">HOST</span><span class="si">}{</span><span class="n">canonical_uri</span><span class="si">}</span><span class="s1">?&#39;</span>
</span><span id="Blob.get_signed_url-222"><a href="#Blob.get_signed_url-222"><span class="linenos">222</span></a>            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">canonical_query_str</span><span class="si">}</span><span class="s1">&amp;X-Goog-Signature=</span><span class="si">{</span><span class="n">signature</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Blob.get_signed_url-223"><a href="#Blob.get_signed_url-223"><span class="linenos">223</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create a temporary access URL for Storage Blob accessible by anyone
with the link.</p>

<p>Adapted from Google Documentation:
<a href="https://cloud.google.com/storage/docs/access-control/signing-urls-manually#python-sample">https://cloud.google.com/storage/docs/access-control/signing-urls-manually#python-sample</a></p>
</div>


                            </div>
                </section>
                <section id="Bucket">
                            <input id="Bucket-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Bucket</span>:

                <label class="view-source-button" for="Bucket-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bucket"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bucket-31"><a href="#Bucket-31"><span class="linenos">31</span></a><span class="k">class</span> <span class="nc">Bucket</span><span class="p">:</span>
</span><span id="Bucket-32"><a href="#Bucket-32"><span class="linenos">32</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storage</span><span class="p">:</span> <span class="s1">&#39;Storage&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bucket-33"><a href="#Bucket-33"><span class="linenos">33</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="n">storage</span>
</span><span id="Bucket-34"><a href="#Bucket-34"><span class="linenos">34</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span><span id="Bucket-35"><a href="#Bucket-35"><span class="linenos">35</span></a>
</span><span id="Bucket-36"><a href="#Bucket-36"><span class="linenos">36</span></a>    <span class="k">def</span> <span class="nf">get_blob</span><span class="p">(</span>
</span><span id="Bucket-37"><a href="#Bucket-37"><span class="linenos">37</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">blob_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Bucket-38"><a href="#Bucket-38"><span class="linenos">38</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Bucket-39"><a href="#Bucket-39"><span class="linenos">39</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Blob</span><span class="p">:</span>
</span><span id="Bucket-40"><a href="#Bucket-40"><span class="linenos">40</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">download_metadata</span><span class="p">(</span>
</span><span id="Bucket-41"><a href="#Bucket-41"><span class="linenos">41</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">blob_name</span><span class="p">,</span>
</span><span id="Bucket-42"><a href="#Bucket-42"><span class="linenos">42</span></a>            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Bucket-43"><a href="#Bucket-43"><span class="linenos">43</span></a>            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
</span><span id="Bucket-44"><a href="#Bucket-44"><span class="linenos">44</span></a>        <span class="p">)</span>
</span><span id="Bucket-45"><a href="#Bucket-45"><span class="linenos">45</span></a>
</span><span id="Bucket-46"><a href="#Bucket-46"><span class="linenos">46</span></a>        <span class="k">return</span> <span class="n">Blob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blob_name</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
</span><span id="Bucket-47"><a href="#Bucket-47"><span class="linenos">47</span></a>
</span><span id="Bucket-48"><a href="#Bucket-48"><span class="linenos">48</span></a>    <span class="k">def</span> <span class="nf">blob_exists</span><span class="p">(</span>
</span><span id="Bucket-49"><a href="#Bucket-49"><span class="linenos">49</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">blob_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Bucket-50"><a href="#Bucket-50"><span class="linenos">50</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Bucket-51"><a href="#Bucket-51"><span class="linenos">51</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Bucket-52"><a href="#Bucket-52"><span class="linenos">52</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Bucket-53"><a href="#Bucket-53"><span class="linenos">53</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">get_blob</span><span class="p">(</span><span class="n">blob_name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
</span><span id="Bucket-54"><a href="#Bucket-54"><span class="linenos">54</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="Bucket-55"><a href="#Bucket-55"><span class="linenos">55</span></a>        <span class="k">except</span> <span class="n">ResponseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Bucket-56"><a href="#Bucket-56"><span class="linenos">56</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Bucket-57"><a href="#Bucket-57"><span class="linenos">57</span></a>                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">404</span><span class="p">,</span> <span class="mi">410</span><span class="p">}:</span>  <span class="c1"># type: ignore[attr-defined]</span>
</span><span id="Bucket-58"><a href="#Bucket-58"><span class="linenos">58</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="Bucket-59"><a href="#Bucket-59"><span class="linenos">59</span></a>            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="Bucket-60"><a href="#Bucket-60"><span class="linenos">60</span></a>                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">404</span><span class="p">,</span> <span class="mi">410</span><span class="p">}:</span>  <span class="c1"># type: ignore[attr-defined]</span>
</span><span id="Bucket-61"><a href="#Bucket-61"><span class="linenos">61</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="Bucket-62"><a href="#Bucket-62"><span class="linenos">62</span></a>
</span><span id="Bucket-63"><a href="#Bucket-63"><span class="linenos">63</span></a>            <span class="k">raise</span> <span class="n">e</span>
</span><span id="Bucket-64"><a href="#Bucket-64"><span class="linenos">64</span></a>
</span><span id="Bucket-65"><a href="#Bucket-65"><span class="linenos">65</span></a>    <span class="k">def</span> <span class="nf">list_blobs</span><span class="p">(</span>
</span><span id="Bucket-66"><a href="#Bucket-66"><span class="linenos">66</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span id="Bucket-67"><a href="#Bucket-67"><span class="linenos">67</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Bucket-68"><a href="#Bucket-68"><span class="linenos">68</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="Bucket-69"><a href="#Bucket-69"><span class="linenos">69</span></a>        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;pageToken&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
</span><span id="Bucket-70"><a href="#Bucket-70"><span class="linenos">70</span></a>        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bucket-71"><a href="#Bucket-71"><span class="linenos">71</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="Bucket-72"><a href="#Bucket-72"><span class="linenos">72</span></a>            <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">list_objects</span><span class="p">(</span>
</span><span id="Bucket-73"><a href="#Bucket-73"><span class="linenos">73</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="Bucket-74"><a href="#Bucket-74"><span class="linenos">74</span></a>                <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
</span><span id="Bucket-75"><a href="#Bucket-75"><span class="linenos">75</span></a>                <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
</span><span id="Bucket-76"><a href="#Bucket-76"><span class="linenos">76</span></a>            <span class="p">)</span>
</span><span id="Bucket-77"><a href="#Bucket-77"><span class="linenos">77</span></a>            <span class="n">items</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;items&#39;</span><span class="p">,</span> <span class="p">[])])</span>
</span><span id="Bucket-78"><a href="#Bucket-78"><span class="linenos">78</span></a>
</span><span id="Bucket-79"><a href="#Bucket-79"><span class="linenos">79</span></a>            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;pageToken&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nextPageToken&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="Bucket-80"><a href="#Bucket-80"><span class="linenos">80</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;pageToken&#39;</span><span class="p">]:</span>
</span><span id="Bucket-81"><a href="#Bucket-81"><span class="linenos">81</span></a>                <span class="k">break</span>
</span><span id="Bucket-82"><a href="#Bucket-82"><span class="linenos">82</span></a>
</span><span id="Bucket-83"><a href="#Bucket-83"><span class="linenos">83</span></a>        <span class="k">return</span> <span class="n">items</span>
</span><span id="Bucket-84"><a href="#Bucket-84"><span class="linenos">84</span></a>
</span><span id="Bucket-85"><a href="#Bucket-85"><span class="linenos">85</span></a>    <span class="k">def</span> <span class="nf">new_blob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blob_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Blob</span><span class="p">:</span>
</span><span id="Bucket-86"><a href="#Bucket-86"><span class="linenos">86</span></a>        <span class="k">return</span> <span class="n">Blob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blob_name</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
</span><span id="Bucket-87"><a href="#Bucket-87"><span class="linenos">87</span></a>
</span><span id="Bucket-88"><a href="#Bucket-88"><span class="linenos">88</span></a>    <span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span>
</span><span id="Bucket-89"><a href="#Bucket-89"><span class="linenos">89</span></a>            <span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Bucket-90"><a href="#Bucket-90"><span class="linenos">90</span></a>            <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Bucket-91"><a href="#Bucket-91"><span class="linenos">91</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Bucket-92"><a href="#Bucket-92"><span class="linenos">92</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get_bucket_metadata</span><span class="p">(</span>
</span><span id="Bucket-93"><a href="#Bucket-93"><span class="linenos">93</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
</span><span id="Bucket-94"><a href="#Bucket-94"><span class="linenos">94</span></a>            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
</span><span id="Bucket-95"><a href="#Bucket-95"><span class="linenos">95</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            <div id="Bucket.__init__" class="classattr">
                                        <input id="Bucket.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Bucket</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">storage</span><span class="p">:</span> <span class="n"><a href="#Storage">Storage</a></span>, </span><span class="param"><span class="n">name</span><span class="p">:</span> <span class="nb">str</span></span>)</span>

                <label class="view-source-button" for="Bucket.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bucket.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bucket.__init__-32"><a href="#Bucket.__init__-32"><span class="linenos">32</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storage</span><span class="p">:</span> <span class="s1">&#39;Storage&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bucket.__init__-33"><a href="#Bucket.__init__-33"><span class="linenos">33</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="n">storage</span>
</span><span id="Bucket.__init__-34"><a href="#Bucket.__init__-34"><span class="linenos">34</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span></pre></div>


    

                            </div>
                            <div id="Bucket.storage" class="classattr">
                                <div class="attr variable">
            <span class="name">storage</span>

        
    </div>
    <a class="headerlink" href="#Bucket.storage"></a>
    
    

                            </div>
                            <div id="Bucket.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span>

        
    </div>
    <a class="headerlink" href="#Bucket.name"></a>
    
    

                            </div>
                            <div id="Bucket.get_blob" class="classattr">
                                        <input id="Bucket.get_blob-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_blob</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">blob_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">requests</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#Blob">Blob</a></span>:</span></span>

                <label class="view-source-button" for="Bucket.get_blob-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bucket.get_blob"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bucket.get_blob-36"><a href="#Bucket.get_blob-36"><span class="linenos">36</span></a>    <span class="k">def</span> <span class="nf">get_blob</span><span class="p">(</span>
</span><span id="Bucket.get_blob-37"><a href="#Bucket.get_blob-37"><span class="linenos">37</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">blob_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Bucket.get_blob-38"><a href="#Bucket.get_blob-38"><span class="linenos">38</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Bucket.get_blob-39"><a href="#Bucket.get_blob-39"><span class="linenos">39</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Blob</span><span class="p">:</span>
</span><span id="Bucket.get_blob-40"><a href="#Bucket.get_blob-40"><span class="linenos">40</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">download_metadata</span><span class="p">(</span>
</span><span id="Bucket.get_blob-41"><a href="#Bucket.get_blob-41"><span class="linenos">41</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">blob_name</span><span class="p">,</span>
</span><span id="Bucket.get_blob-42"><a href="#Bucket.get_blob-42"><span class="linenos">42</span></a>            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Bucket.get_blob-43"><a href="#Bucket.get_blob-43"><span class="linenos">43</span></a>            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
</span><span id="Bucket.get_blob-44"><a href="#Bucket.get_blob-44"><span class="linenos">44</span></a>        <span class="p">)</span>
</span><span id="Bucket.get_blob-45"><a href="#Bucket.get_blob-45"><span class="linenos">45</span></a>
</span><span id="Bucket.get_blob-46"><a href="#Bucket.get_blob-46"><span class="linenos">46</span></a>        <span class="k">return</span> <span class="n">Blob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blob_name</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="Bucket.blob_exists" class="classattr">
                                        <input id="Bucket.blob_exists-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">blob_exists</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">blob_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">requests</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Bucket.blob_exists-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bucket.blob_exists"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bucket.blob_exists-48"><a href="#Bucket.blob_exists-48"><span class="linenos">48</span></a>    <span class="k">def</span> <span class="nf">blob_exists</span><span class="p">(</span>
</span><span id="Bucket.blob_exists-49"><a href="#Bucket.blob_exists-49"><span class="linenos">49</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">blob_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Bucket.blob_exists-50"><a href="#Bucket.blob_exists-50"><span class="linenos">50</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Bucket.blob_exists-51"><a href="#Bucket.blob_exists-51"><span class="linenos">51</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Bucket.blob_exists-52"><a href="#Bucket.blob_exists-52"><span class="linenos">52</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Bucket.blob_exists-53"><a href="#Bucket.blob_exists-53"><span class="linenos">53</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">get_blob</span><span class="p">(</span><span class="n">blob_name</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
</span><span id="Bucket.blob_exists-54"><a href="#Bucket.blob_exists-54"><span class="linenos">54</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="Bucket.blob_exists-55"><a href="#Bucket.blob_exists-55"><span class="linenos">55</span></a>        <span class="k">except</span> <span class="n">ResponseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Bucket.blob_exists-56"><a href="#Bucket.blob_exists-56"><span class="linenos">56</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Bucket.blob_exists-57"><a href="#Bucket.blob_exists-57"><span class="linenos">57</span></a>                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">404</span><span class="p">,</span> <span class="mi">410</span><span class="p">}:</span>  <span class="c1"># type: ignore[attr-defined]</span>
</span><span id="Bucket.blob_exists-58"><a href="#Bucket.blob_exists-58"><span class="linenos">58</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="Bucket.blob_exists-59"><a href="#Bucket.blob_exists-59"><span class="linenos">59</span></a>            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="Bucket.blob_exists-60"><a href="#Bucket.blob_exists-60"><span class="linenos">60</span></a>                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">404</span><span class="p">,</span> <span class="mi">410</span><span class="p">}:</span>  <span class="c1"># type: ignore[attr-defined]</span>
</span><span id="Bucket.blob_exists-61"><a href="#Bucket.blob_exists-61"><span class="linenos">61</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="Bucket.blob_exists-62"><a href="#Bucket.blob_exists-62"><span class="linenos">62</span></a>
</span><span id="Bucket.blob_exists-63"><a href="#Bucket.blob_exists-63"><span class="linenos">63</span></a>            <span class="k">raise</span> <span class="n">e</span>
</span></pre></div>


    

                            </div>
                            <div id="Bucket.list_blobs" class="classattr">
                                        <input id="Bucket.list_blobs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">list_blobs</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>,</span><span class="param">	<span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">requests</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Bucket.list_blobs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bucket.list_blobs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bucket.list_blobs-65"><a href="#Bucket.list_blobs-65"><span class="linenos">65</span></a>    <span class="k">def</span> <span class="nf">list_blobs</span><span class="p">(</span>
</span><span id="Bucket.list_blobs-66"><a href="#Bucket.list_blobs-66"><span class="linenos">66</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span id="Bucket.list_blobs-67"><a href="#Bucket.list_blobs-67"><span class="linenos">67</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Bucket.list_blobs-68"><a href="#Bucket.list_blobs-68"><span class="linenos">68</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="Bucket.list_blobs-69"><a href="#Bucket.list_blobs-69"><span class="linenos">69</span></a>        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;pageToken&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
</span><span id="Bucket.list_blobs-70"><a href="#Bucket.list_blobs-70"><span class="linenos">70</span></a>        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bucket.list_blobs-71"><a href="#Bucket.list_blobs-71"><span class="linenos">71</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="Bucket.list_blobs-72"><a href="#Bucket.list_blobs-72"><span class="linenos">72</span></a>            <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">list_objects</span><span class="p">(</span>
</span><span id="Bucket.list_blobs-73"><a href="#Bucket.list_blobs-73"><span class="linenos">73</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="Bucket.list_blobs-74"><a href="#Bucket.list_blobs-74"><span class="linenos">74</span></a>                <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
</span><span id="Bucket.list_blobs-75"><a href="#Bucket.list_blobs-75"><span class="linenos">75</span></a>                <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
</span><span id="Bucket.list_blobs-76"><a href="#Bucket.list_blobs-76"><span class="linenos">76</span></a>            <span class="p">)</span>
</span><span id="Bucket.list_blobs-77"><a href="#Bucket.list_blobs-77"><span class="linenos">77</span></a>            <span class="n">items</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;items&#39;</span><span class="p">,</span> <span class="p">[])])</span>
</span><span id="Bucket.list_blobs-78"><a href="#Bucket.list_blobs-78"><span class="linenos">78</span></a>
</span><span id="Bucket.list_blobs-79"><a href="#Bucket.list_blobs-79"><span class="linenos">79</span></a>            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;pageToken&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nextPageToken&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="Bucket.list_blobs-80"><a href="#Bucket.list_blobs-80"><span class="linenos">80</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;pageToken&#39;</span><span class="p">]:</span>
</span><span id="Bucket.list_blobs-81"><a href="#Bucket.list_blobs-81"><span class="linenos">81</span></a>                <span class="k">break</span>
</span><span id="Bucket.list_blobs-82"><a href="#Bucket.list_blobs-82"><span class="linenos">82</span></a>
</span><span id="Bucket.list_blobs-83"><a href="#Bucket.list_blobs-83"><span class="linenos">83</span></a>        <span class="k">return</span> <span class="n">items</span>
</span></pre></div>


    

                            </div>
                            <div id="Bucket.new_blob" class="classattr">
                                        <input id="Bucket.new_blob-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">new_blob</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">blob_name</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n"><a href="#Blob">Blob</a></span>:</span></span>

                <label class="view-source-button" for="Bucket.new_blob-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bucket.new_blob"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bucket.new_blob-85"><a href="#Bucket.new_blob-85"><span class="linenos">85</span></a>    <span class="k">def</span> <span class="nf">new_blob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blob_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Blob</span><span class="p">:</span>
</span><span id="Bucket.new_blob-86"><a href="#Bucket.new_blob-86"><span class="linenos">86</span></a>        <span class="k">return</span> <span class="n">Blob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blob_name</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
</span></pre></div>


    

                            </div>
                            <div id="Bucket.get_metadata" class="classattr">
                                        <input id="Bucket.get_metadata-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_metadata</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">requests</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Bucket.get_metadata-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bucket.get_metadata"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bucket.get_metadata-88"><a href="#Bucket.get_metadata-88"><span class="linenos">88</span></a>    <span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span>
</span><span id="Bucket.get_metadata-89"><a href="#Bucket.get_metadata-89"><span class="linenos">89</span></a>            <span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Bucket.get_metadata-90"><a href="#Bucket.get_metadata-90"><span class="linenos">90</span></a>            <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Bucket.get_metadata-91"><a href="#Bucket.get_metadata-91"><span class="linenos">91</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Bucket.get_metadata-92"><a href="#Bucket.get_metadata-92"><span class="linenos">92</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get_bucket_metadata</span><span class="p">(</span>
</span><span id="Bucket.get_metadata-93"><a href="#Bucket.get_metadata-93"><span class="linenos">93</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
</span><span id="Bucket.get_metadata-94"><a href="#Bucket.get_metadata-94"><span class="linenos">94</span></a>            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
</span><span id="Bucket.get_metadata-95"><a href="#Bucket.get_metadata-95"><span class="linenos">95</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="SCOPES">
                    <div class="attr variable">
            <span class="name">SCOPES</span>        =
<span class="default_value">[&#39;https://www.googleapis.com/auth/devstorage.read_write&#39;]</span>

        
    </div>
    <a class="headerlink" href="#SCOPES"></a>
    
    

                </section>
                <section id="Storage">
                            <input id="Storage-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Storage</span>:

                <label class="view-source-button" for="Storage-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Storage"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Storage-146"><a href="#Storage-146"><span class="linenos">146</span></a><span class="k">class</span> <span class="nc">Storage</span><span class="p">:</span>
</span><span id="Storage-147"><a href="#Storage-147"><span class="linenos">147</span></a>    <span class="n">_api_root</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="Storage-148"><a href="#Storage-148"><span class="linenos">148</span></a>    <span class="n">_api_is_dev</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="Storage-149"><a href="#Storage-149"><span class="linenos">149</span></a>    <span class="n">_api_root_read</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="Storage-150"><a href="#Storage-150"><span class="linenos">150</span></a>    <span class="n">_api_root_write</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="Storage-151"><a href="#Storage-151"><span class="linenos">151</span></a>
</span><span id="Storage-152"><a href="#Storage-152"><span class="linenos">152</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="Storage-153"><a href="#Storage-153"><span class="linenos">153</span></a>            <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">service_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">IO</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-154"><a href="#Storage-154"><span class="linenos">154</span></a>            <span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Token</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-155"><a href="#Storage-155"><span class="linenos">155</span></a>            <span class="n">api_root</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-156"><a href="#Storage-156"><span class="linenos">156</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Storage-157"><a href="#Storage-157"><span class="linenos">157</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_api_is_dev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api_root</span> <span class="o">=</span> <span class="n">init_api_root</span><span class="p">(</span><span class="n">api_root</span><span class="p">)</span>
</span><span id="Storage-158"><a href="#Storage-158"><span class="linenos">158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_api_root_read</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_root</span><span class="si">}</span><span class="s1">/storage/v1/b&#39;</span>
</span><span id="Storage-159"><a href="#Storage-159"><span class="linenos">159</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_api_root_write</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_root</span><span class="si">}</span><span class="s1">/upload/storage/v1/b&#39;</span>
</span><span id="Storage-160"><a href="#Storage-160"><span class="linenos">160</span></a>
</span><span id="Storage-161"><a href="#Storage-161"><span class="linenos">161</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">SyncSession</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">verify_ssl</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api_is_dev</span><span class="p">)</span>
</span><span id="Storage-162"><a href="#Storage-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span> <span class="ow">or</span> <span class="n">Token</span><span class="p">(</span>
</span><span id="Storage-163"><a href="#Storage-163"><span class="linenos">163</span></a>            <span class="n">service_file</span><span class="o">=</span><span class="n">service_file</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="n">SCOPES</span><span class="p">,</span>
</span><span id="Storage-164"><a href="#Storage-164"><span class="linenos">164</span></a>            <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>  <span class="c1"># type: ignore[arg-type]</span>
</span><span id="Storage-165"><a href="#Storage-165"><span class="linenos">165</span></a>        <span class="p">)</span>
</span><span id="Storage-166"><a href="#Storage-166"><span class="linenos">166</span></a>
</span><span id="Storage-167"><a href="#Storage-167"><span class="linenos">167</span></a>    <span class="k">def</span> <span class="nf">_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="Storage-168"><a href="#Storage-168"><span class="linenos">168</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api_is_dev</span><span class="p">:</span>
</span><span id="Storage-169"><a href="#Storage-169"><span class="linenos">169</span></a>            <span class="k">return</span> <span class="p">{}</span>
</span><span id="Storage-170"><a href="#Storage-170"><span class="linenos">170</span></a>
</span><span id="Storage-171"><a href="#Storage-171"><span class="linenos">171</span></a>        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span><span id="Storage-172"><a href="#Storage-172"><span class="linenos">172</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="Storage-173"><a href="#Storage-173"><span class="linenos">173</span></a>            <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="Storage-174"><a href="#Storage-174"><span class="linenos">174</span></a>        <span class="p">}</span>
</span><span id="Storage-175"><a href="#Storage-175"><span class="linenos">175</span></a>
</span><span id="Storage-176"><a href="#Storage-176"><span class="linenos">176</span></a>    <span class="c1"># This method makes the following API call:</span>
</span><span id="Storage-177"><a href="#Storage-177"><span class="linenos">177</span></a>    <span class="c1"># https://cloud.google.com/storage/docs/json_api/v1/buckets/list</span>
</span><span id="Storage-178"><a href="#Storage-178"><span class="linenos">178</span></a>    <span class="k">def</span> <span class="nf">list_buckets</span><span class="p">(</span>
</span><span id="Storage-179"><a href="#Storage-179"><span class="linenos">179</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
</span><span id="Storage-180"><a href="#Storage-180"><span class="linenos">180</span></a>        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-181"><a href="#Storage-181"><span class="linenos">181</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-182"><a href="#Storage-182"><span class="linenos">182</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-183"><a href="#Storage-183"><span class="linenos">183</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Storage-184"><a href="#Storage-184"><span class="linenos">184</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Bucket</span><span class="p">]:</span>
</span><span id="Storage-185"><a href="#Storage-185"><span class="linenos">185</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_root_read</span><span class="si">}</span><span class="s1">?project=</span><span class="si">{</span><span class="n">project</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Storage-186"><a href="#Storage-186"><span class="linenos">186</span></a>        <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage-187"><a href="#Storage-187"><span class="linenos">187</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">())</span>
</span><span id="Storage-188"><a href="#Storage-188"><span class="linenos">188</span></a>        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage-189"><a href="#Storage-189"><span class="linenos">189</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pageToken&#39;</span><span class="p">):</span>
</span><span id="Storage-190"><a href="#Storage-190"><span class="linenos">190</span></a>            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;pageToken&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="Storage-191"><a href="#Storage-191"><span class="linenos">191</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">SyncSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="k">if</span> <span class="n">session</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span id="Storage-192"><a href="#Storage-192"><span class="linenos">192</span></a>        <span class="n">buckets</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Storage-193"><a href="#Storage-193"><span class="linenos">193</span></a>
</span><span id="Storage-194"><a href="#Storage-194"><span class="linenos">194</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="Storage-195"><a href="#Storage-195"><span class="linenos">195</span></a>            <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
</span><span id="Storage-196"><a href="#Storage-196"><span class="linenos">196</span></a>                               <span class="n">params</span><span class="o">=</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{},</span>
</span><span id="Storage-197"><a href="#Storage-197"><span class="linenos">197</span></a>                               <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="Storage-198"><a href="#Storage-198"><span class="linenos">198</span></a>
</span><span id="Storage-199"><a href="#Storage-199"><span class="linenos">199</span></a>            <span class="n">content</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="Storage-200"><a href="#Storage-200"><span class="linenos">200</span></a>            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;items&#39;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="Storage-201"><a href="#Storage-201"><span class="linenos">201</span></a>                <span class="n">buckets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>
</span><span id="Storage-202"><a href="#Storage-202"><span class="linenos">202</span></a>
</span><span id="Storage-203"><a href="#Storage-203"><span class="linenos">203</span></a>            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;pageToken&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nextPageToken&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="Storage-204"><a href="#Storage-204"><span class="linenos">204</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;pageToken&#39;</span><span class="p">]:</span>
</span><span id="Storage-205"><a href="#Storage-205"><span class="linenos">205</span></a>                <span class="k">break</span>
</span><span id="Storage-206"><a href="#Storage-206"><span class="linenos">206</span></a>        <span class="k">return</span> <span class="n">buckets</span>
</span><span id="Storage-207"><a href="#Storage-207"><span class="linenos">207</span></a>
</span><span id="Storage-208"><a href="#Storage-208"><span class="linenos">208</span></a>    <span class="k">def</span> <span class="nf">get_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Bucket</span><span class="p">:</span>
</span><span id="Storage-209"><a href="#Storage-209"><span class="linenos">209</span></a>        <span class="k">return</span> <span class="n">Bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">)</span>
</span><span id="Storage-210"><a href="#Storage-210"><span class="linenos">210</span></a>
</span><span id="Storage-211"><a href="#Storage-211"><span class="linenos">211</span></a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span>
</span><span id="Storage-212"><a href="#Storage-212"><span class="linenos">212</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Storage-213"><a href="#Storage-213"><span class="linenos">213</span></a>        <span class="n">destination_bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">new_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-214"><a href="#Storage-214"><span class="linenos">214</span></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-215"><a href="#Storage-215"><span class="linenos">215</span></a>        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-216"><a href="#Storage-216"><span class="linenos">216</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-217"><a href="#Storage-217"><span class="linenos">217</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Storage-218"><a href="#Storage-218"><span class="linenos">218</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-219"><a href="#Storage-219"><span class="linenos">219</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Storage-220"><a href="#Storage-220"><span class="linenos">220</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Storage-221"><a href="#Storage-221"><span class="linenos">221</span></a><span class="sd">        When files are too large, multiple calls to `rewriteTo` are made. We</span>
</span><span id="Storage-222"><a href="#Storage-222"><span class="linenos">222</span></a><span class="sd">        refer to the same copy job by using the `rewriteToken` from the</span>
</span><span id="Storage-223"><a href="#Storage-223"><span class="linenos">223</span></a><span class="sd">        previous return payload in subsequent `rewriteTo` calls.</span>
</span><span id="Storage-224"><a href="#Storage-224"><span class="linenos">224</span></a>
</span><span id="Storage-225"><a href="#Storage-225"><span class="linenos">225</span></a><span class="sd">        Using the `rewriteTo` GCS API is preferred in part because it is able</span>
</span><span id="Storage-226"><a href="#Storage-226"><span class="linenos">226</span></a><span class="sd">        to make multiple calls to fully copy an object whereas the `copyTo` GCS</span>
</span><span id="Storage-227"><a href="#Storage-227"><span class="linenos">227</span></a><span class="sd">        API only calls `rewriteTo` once under the hood, and thus may fail if</span>
</span><span id="Storage-228"><a href="#Storage-228"><span class="linenos">228</span></a><span class="sd">        files are large.</span>
</span><span id="Storage-229"><a href="#Storage-229"><span class="linenos">229</span></a>
</span><span id="Storage-230"><a href="#Storage-230"><span class="linenos">230</span></a><span class="sd">        In the rare case you need to resume a copy operation, include the</span>
</span><span id="Storage-231"><a href="#Storage-231"><span class="linenos">231</span></a><span class="sd">        `rewriteToken` in the `params` dictionary. Once you begin a multi-part</span>
</span><span id="Storage-232"><a href="#Storage-232"><span class="linenos">232</span></a><span class="sd">        copy operation, you then have 1 week to complete the copy job.</span>
</span><span id="Storage-233"><a href="#Storage-233"><span class="linenos">233</span></a>
</span><span id="Storage-234"><a href="#Storage-234"><span class="linenos">234</span></a><span class="sd">        https://cloud.google.com/storage/docs/json_api/v1/objects/rewrite</span>
</span><span id="Storage-235"><a href="#Storage-235"><span class="linenos">235</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Storage-236"><a href="#Storage-236"><span class="linenos">236</span></a>        <span class="c1"># pylint: disable=too-many-locals</span>
</span><span id="Storage-237"><a href="#Storage-237"><span class="linenos">237</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_name</span><span class="p">:</span>
</span><span id="Storage-238"><a href="#Storage-238"><span class="linenos">238</span></a>            <span class="n">new_name</span> <span class="o">=</span> <span class="n">object_name</span>
</span><span id="Storage-239"><a href="#Storage-239"><span class="linenos">239</span></a>
</span><span id="Storage-240"><a href="#Storage-240"><span class="linenos">240</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Storage-241"><a href="#Storage-241"><span class="linenos">241</span></a>            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_root_read</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s1">/o/&#39;</span>
</span><span id="Storage-242"><a href="#Storage-242"><span class="linenos">242</span></a>            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">quote</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="w"> </span><span class="n">safe</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">/rewriteTo/b/&#39;</span>
</span><span id="Storage-243"><a href="#Storage-243"><span class="linenos">243</span></a>            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">destination_bucket</span><span class="si">}</span><span class="s1">/o/</span><span class="si">{</span><span class="n">quote</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span><span class="w"> </span><span class="n">safe</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Storage-244"><a href="#Storage-244"><span class="linenos">244</span></a>        <span class="p">)</span>
</span><span id="Storage-245"><a href="#Storage-245"><span class="linenos">245</span></a>
</span><span id="Storage-246"><a href="#Storage-246"><span class="linenos">246</span></a>        <span class="c1"># We may optionally supply metadata* to apply to the rewritten</span>
</span><span id="Storage-247"><a href="#Storage-247"><span class="linenos">247</span></a>        <span class="c1"># object, which explains why `rewriteTo` is a POST endpoint; when no</span>
</span><span id="Storage-248"><a href="#Storage-248"><span class="linenos">248</span></a>        <span class="c1"># metadata is given, we have to send an empty body.</span>
</span><span id="Storage-249"><a href="#Storage-249"><span class="linenos">249</span></a>        <span class="c1"># * https://cloud.google.com/storage/docs/json_api/v1/objects#resource</span>
</span><span id="Storage-250"><a href="#Storage-250"><span class="linenos">250</span></a>        <span class="n">metadict</span> <span class="o">=</span> <span class="p">(</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Storage-251"><a href="#Storage-251"><span class="linenos">251</span></a>        <span class="n">metadict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Storage-252"><a href="#Storage-252"><span class="linenos">252</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_format_metadata_key</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span>
</span><span id="Storage-253"><a href="#Storage-253"><span class="linenos">253</span></a>            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metadict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Storage-254"><a href="#Storage-254"><span class="linenos">254</span></a>        <span class="p">}</span>
</span><span id="Storage-255"><a href="#Storage-255"><span class="linenos">255</span></a>        <span class="k">if</span> <span class="s1">&#39;metadata&#39;</span> <span class="ow">in</span> <span class="n">metadict</span><span class="p">:</span>
</span><span id="Storage-256"><a href="#Storage-256"><span class="linenos">256</span></a>            <span class="n">metadict</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Storage-257"><a href="#Storage-257"><span class="linenos">257</span></a>                <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Storage-258"><a href="#Storage-258"><span class="linenos">258</span></a>                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metadict</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Storage-259"><a href="#Storage-259"><span class="linenos">259</span></a>            <span class="p">}</span>
</span><span id="Storage-260"><a href="#Storage-260"><span class="linenos">260</span></a>
</span><span id="Storage-261"><a href="#Storage-261"><span class="linenos">261</span></a>        <span class="n">metadata_</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadict</span><span class="p">)</span>
</span><span id="Storage-262"><a href="#Storage-262"><span class="linenos">262</span></a>
</span><span id="Storage-263"><a href="#Storage-263"><span class="linenos">263</span></a>        <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage-264"><a href="#Storage-264"><span class="linenos">264</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">())</span>
</span><span id="Storage-265"><a href="#Storage-265"><span class="linenos">265</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
</span><span id="Storage-266"><a href="#Storage-266"><span class="linenos">266</span></a>            <span class="s1">&#39;Content-Length&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metadata_</span><span class="p">)),</span>
</span><span id="Storage-267"><a href="#Storage-267"><span class="linenos">267</span></a>            <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json; charset=UTF-8&#39;</span><span class="p">,</span>
</span><span id="Storage-268"><a href="#Storage-268"><span class="linenos">268</span></a>        <span class="p">})</span>
</span><span id="Storage-269"><a href="#Storage-269"><span class="linenos">269</span></a>
</span><span id="Storage-270"><a href="#Storage-270"><span class="linenos">270</span></a>        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage-271"><a href="#Storage-271"><span class="linenos">271</span></a>
</span><span id="Storage-272"><a href="#Storage-272"><span class="linenos">272</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">SyncSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="k">if</span> <span class="n">session</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span id="Storage-273"><a href="#Storage-273"><span class="linenos">273</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span><span id="Storage-274"><a href="#Storage-274"><span class="linenos">274</span></a>            <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage-275"><a href="#Storage-275"><span class="linenos">275</span></a>            <span class="n">data</span><span class="o">=</span><span class="n">metadata_</span><span class="p">,</span>
</span><span id="Storage-276"><a href="#Storage-276"><span class="linenos">276</span></a>        <span class="p">)</span>
</span><span id="Storage-277"><a href="#Storage-277"><span class="linenos">277</span></a>
</span><span id="Storage-278"><a href="#Storage-278"><span class="linenos">278</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="Storage-279"><a href="#Storage-279"><span class="linenos">279</span></a>
</span><span id="Storage-280"><a href="#Storage-280"><span class="linenos">280</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rewriteToken&#39;</span><span class="p">):</span>
</span><span id="Storage-281"><a href="#Storage-281"><span class="linenos">281</span></a>            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;rewriteToken&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rewriteToken&#39;</span><span class="p">]</span>
</span><span id="Storage-282"><a href="#Storage-282"><span class="linenos">282</span></a>            <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span><span id="Storage-283"><a href="#Storage-283"><span class="linenos">283</span></a>                <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
</span><span id="Storage-284"><a href="#Storage-284"><span class="linenos">284</span></a>                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage-285"><a href="#Storage-285"><span class="linenos">285</span></a>            <span class="p">)</span>
</span><span id="Storage-286"><a href="#Storage-286"><span class="linenos">286</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="Storage-287"><a href="#Storage-287"><span class="linenos">287</span></a>
</span><span id="Storage-288"><a href="#Storage-288"><span class="linenos">288</span></a>        <span class="k">return</span> <span class="n">data</span>
</span><span id="Storage-289"><a href="#Storage-289"><span class="linenos">289</span></a>
</span><span id="Storage-290"><a href="#Storage-290"><span class="linenos">290</span></a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span>
</span><span id="Storage-291"><a href="#Storage-291"><span class="linenos">291</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
</span><span id="Storage-292"><a href="#Storage-292"><span class="linenos">292</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Storage-293"><a href="#Storage-293"><span class="linenos">293</span></a>        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-294"><a href="#Storage-294"><span class="linenos">294</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-295"><a href="#Storage-295"><span class="linenos">295</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-296"><a href="#Storage-296"><span class="linenos">296</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Storage-297"><a href="#Storage-297"><span class="linenos">297</span></a>        <span class="c1"># https://cloud.google.com/storage/docs/request-endpoints#encoding</span>
</span><span id="Storage-298"><a href="#Storage-298"><span class="linenos">298</span></a>        <span class="n">encoded_object_name</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="Storage-299"><a href="#Storage-299"><span class="linenos">299</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_root_read</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s1">/o/</span><span class="si">{</span><span class="n">encoded_object_name</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Storage-300"><a href="#Storage-300"><span class="linenos">300</span></a>        <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage-301"><a href="#Storage-301"><span class="linenos">301</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">())</span>
</span><span id="Storage-302"><a href="#Storage-302"><span class="linenos">302</span></a>
</span><span id="Storage-303"><a href="#Storage-303"><span class="linenos">303</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">SyncSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="k">if</span> <span class="n">session</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span id="Storage-304"><a href="#Storage-304"><span class="linenos">304</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
</span><span id="Storage-305"><a href="#Storage-305"><span class="linenos">305</span></a>            <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{},</span>
</span><span id="Storage-306"><a href="#Storage-306"><span class="linenos">306</span></a>            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage-307"><a href="#Storage-307"><span class="linenos">307</span></a>        <span class="p">)</span>
</span><span id="Storage-308"><a href="#Storage-308"><span class="linenos">308</span></a>
</span><span id="Storage-309"><a href="#Storage-309"><span class="linenos">309</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Storage-310"><a href="#Storage-310"><span class="linenos">310</span></a>            <span class="n">data</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="Storage-311"><a href="#Storage-311"><span class="linenos">311</span></a>        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
</span><span id="Storage-312"><a href="#Storage-312"><span class="linenos">312</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="Storage-313"><a href="#Storage-313"><span class="linenos">313</span></a>
</span><span id="Storage-314"><a href="#Storage-314"><span class="linenos">314</span></a>        <span class="k">return</span> <span class="n">data</span>
</span><span id="Storage-315"><a href="#Storage-315"><span class="linenos">315</span></a>
</span><span id="Storage-316"><a href="#Storage-316"><span class="linenos">316</span></a>    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span>
</span><span id="Storage-317"><a href="#Storage-317"><span class="linenos">317</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
</span><span id="Storage-318"><a href="#Storage-318"><span class="linenos">318</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-319"><a href="#Storage-319"><span class="linenos">319</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Storage-320"><a href="#Storage-320"><span class="linenos">320</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-321"><a href="#Storage-321"><span class="linenos">321</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="Storage-322"><a href="#Storage-322"><span class="linenos">322</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download</span><span class="p">(</span>
</span><span id="Storage-323"><a href="#Storage-323"><span class="linenos">323</span></a>            <span class="n">bucket</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
</span><span id="Storage-324"><a href="#Storage-324"><span class="linenos">324</span></a>            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;alt&#39;</span><span class="p">:</span> <span class="s1">&#39;media&#39;</span><span class="p">},</span>
</span><span id="Storage-325"><a href="#Storage-325"><span class="linenos">325</span></a>            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
</span><span id="Storage-326"><a href="#Storage-326"><span class="linenos">326</span></a>        <span class="p">)</span>
</span><span id="Storage-327"><a href="#Storage-327"><span class="linenos">327</span></a>
</span><span id="Storage-328"><a href="#Storage-328"><span class="linenos">328</span></a>    <span class="k">def</span> <span class="nf">download_to_filename</span><span class="p">(</span>
</span><span id="Storage-329"><a href="#Storage-329"><span class="linenos">329</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Storage-330"><a href="#Storage-330"><span class="linenos">330</span></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="Storage-331"><a href="#Storage-331"><span class="linenos">331</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Storage-332"><a href="#Storage-332"><span class="linenos">332</span></a>        <span class="k">with</span> <span class="n">file_open</span><span class="p">(</span>  <span class="c1"># type: ignore[attr-defined]</span>
</span><span id="Storage-333"><a href="#Storage-333"><span class="linenos">333</span></a>                <span class="n">filename</span><span class="p">,</span>
</span><span id="Storage-334"><a href="#Storage-334"><span class="linenos">334</span></a>                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wb+&#39;</span><span class="p">,</span>
</span><span id="Storage-335"><a href="#Storage-335"><span class="linenos">335</span></a>        <span class="p">)</span> <span class="k">as</span> <span class="n">file_object</span><span class="p">:</span>
</span><span id="Storage-336"><a href="#Storage-336"><span class="linenos">336</span></a>            <span class="n">file_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
</span><span id="Storage-337"><a href="#Storage-337"><span class="linenos">337</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="Storage-338"><a href="#Storage-338"><span class="linenos">338</span></a>            <span class="p">)</span>
</span><span id="Storage-339"><a href="#Storage-339"><span class="linenos">339</span></a>
</span><span id="Storage-340"><a href="#Storage-340"><span class="linenos">340</span></a>    <span class="k">def</span> <span class="nf">download_metadata</span><span class="p">(</span>
</span><span id="Storage-341"><a href="#Storage-341"><span class="linenos">341</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
</span><span id="Storage-342"><a href="#Storage-342"><span class="linenos">342</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-343"><a href="#Storage-343"><span class="linenos">343</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-344"><a href="#Storage-344"><span class="linenos">344</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Storage-345"><a href="#Storage-345"><span class="linenos">345</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Storage-346"><a href="#Storage-346"><span class="linenos">346</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download</span><span class="p">(</span>
</span><span id="Storage-347"><a href="#Storage-347"><span class="linenos">347</span></a>            <span class="n">bucket</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
</span><span id="Storage-348"><a href="#Storage-348"><span class="linenos">348</span></a>            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
</span><span id="Storage-349"><a href="#Storage-349"><span class="linenos">349</span></a>        <span class="p">)</span>
</span><span id="Storage-350"><a href="#Storage-350"><span class="linenos">350</span></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span><span id="Storage-351"><a href="#Storage-351"><span class="linenos">351</span></a>        <span class="k">return</span> <span class="n">metadata</span>
</span><span id="Storage-352"><a href="#Storage-352"><span class="linenos">352</span></a>
</span><span id="Storage-353"><a href="#Storage-353"><span class="linenos">353</span></a>    <span class="k">def</span> <span class="nf">download_stream</span><span class="p">(</span>
</span><span id="Storage-354"><a href="#Storage-354"><span class="linenos">354</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
</span><span id="Storage-355"><a href="#Storage-355"><span class="linenos">355</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-356"><a href="#Storage-356"><span class="linenos">356</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Storage-357"><a href="#Storage-357"><span class="linenos">357</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-358"><a href="#Storage-358"><span class="linenos">358</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StreamResponse</span><span class="p">:</span>
</span><span id="Storage-359"><a href="#Storage-359"><span class="linenos">359</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Download a GCS object in a buffered stream.</span>
</span><span id="Storage-360"><a href="#Storage-360"><span class="linenos">360</span></a>
</span><span id="Storage-361"><a href="#Storage-361"><span class="linenos">361</span></a><span class="sd">        Args:</span>
</span><span id="Storage-362"><a href="#Storage-362"><span class="linenos">362</span></a><span class="sd">            bucket (str): The bucket from which to download.</span>
</span><span id="Storage-363"><a href="#Storage-363"><span class="linenos">363</span></a><span class="sd">            object_name (str): The object within the bucket to download.</span>
</span><span id="Storage-364"><a href="#Storage-364"><span class="linenos">364</span></a><span class="sd">            headers (Optional[Dict[str, Any]], optional): Custom header values</span>
</span><span id="Storage-365"><a href="#Storage-365"><span class="linenos">365</span></a><span class="sd">                for the request, such as range. Defaults to None.</span>
</span><span id="Storage-366"><a href="#Storage-366"><span class="linenos">366</span></a><span class="sd">            timeout (int, optional): Timeout, in seconds, for the request. Note</span>
</span><span id="Storage-367"><a href="#Storage-367"><span class="linenos">367</span></a><span class="sd">                that with this function, this is the time to the beginning of</span>
</span><span id="Storage-368"><a href="#Storage-368"><span class="linenos">368</span></a><span class="sd">                the response data (TTFB). Defaults to 10.</span>
</span><span id="Storage-369"><a href="#Storage-369"><span class="linenos">369</span></a><span class="sd">            session (Optional[Session], optional): A specific session to</span>
</span><span id="Storage-370"><a href="#Storage-370"><span class="linenos">370</span></a><span class="sd">                (re)use. Defaults to None.</span>
</span><span id="Storage-371"><a href="#Storage-371"><span class="linenos">371</span></a>
</span><span id="Storage-372"><a href="#Storage-372"><span class="linenos">372</span></a><span class="sd">        Returns:</span>
</span><span id="Storage-373"><a href="#Storage-373"><span class="linenos">373</span></a><span class="sd">            StreamResponse: A object encapsulating the stream, similar to</span>
</span><span id="Storage-374"><a href="#Storage-374"><span class="linenos">374</span></a><span class="sd">            io.BufferedIOBase, but it only supports the read() function.</span>
</span><span id="Storage-375"><a href="#Storage-375"><span class="linenos">375</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Storage-376"><a href="#Storage-376"><span class="linenos">376</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_stream</span><span class="p">(</span>
</span><span id="Storage-377"><a href="#Storage-377"><span class="linenos">377</span></a>            <span class="n">bucket</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span>
</span><span id="Storage-378"><a href="#Storage-378"><span class="linenos">378</span></a>            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage-379"><a href="#Storage-379"><span class="linenos">379</span></a>            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;alt&#39;</span><span class="p">:</span> <span class="s1">&#39;media&#39;</span><span class="p">},</span>
</span><span id="Storage-380"><a href="#Storage-380"><span class="linenos">380</span></a>            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
</span><span id="Storage-381"><a href="#Storage-381"><span class="linenos">381</span></a>        <span class="p">)</span>
</span><span id="Storage-382"><a href="#Storage-382"><span class="linenos">382</span></a>
</span><span id="Storage-383"><a href="#Storage-383"><span class="linenos">383</span></a>    <span class="k">def</span> <span class="nf">list_objects</span><span class="p">(</span>
</span><span id="Storage-384"><a href="#Storage-384"><span class="linenos">384</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
</span><span id="Storage-385"><a href="#Storage-385"><span class="linenos">385</span></a>        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-386"><a href="#Storage-386"><span class="linenos">386</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-387"><a href="#Storage-387"><span class="linenos">387</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-388"><a href="#Storage-388"><span class="linenos">388</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Storage-389"><a href="#Storage-389"><span class="linenos">389</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Storage-390"><a href="#Storage-390"><span class="linenos">390</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_root_read</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s1">/o&#39;</span>
</span><span id="Storage-391"><a href="#Storage-391"><span class="linenos">391</span></a>        <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage-392"><a href="#Storage-392"><span class="linenos">392</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">())</span>
</span><span id="Storage-393"><a href="#Storage-393"><span class="linenos">393</span></a>
</span><span id="Storage-394"><a href="#Storage-394"><span class="linenos">394</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">SyncSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="k">if</span> <span class="n">session</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span id="Storage-395"><a href="#Storage-395"><span class="linenos">395</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="Storage-396"><a href="#Storage-396"><span class="linenos">396</span></a>            <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{},</span>
</span><span id="Storage-397"><a href="#Storage-397"><span class="linenos">397</span></a>            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage-398"><a href="#Storage-398"><span class="linenos">398</span></a>        <span class="p">)</span>
</span><span id="Storage-399"><a href="#Storage-399"><span class="linenos">399</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="Storage-400"><a href="#Storage-400"><span class="linenos">400</span></a>        <span class="k">return</span> <span class="n">data</span>
</span><span id="Storage-401"><a href="#Storage-401"><span class="linenos">401</span></a>
</span><span id="Storage-402"><a href="#Storage-402"><span class="linenos">402</span></a>    <span class="c1"># https://cloud.google.com/storage/docs/json_api/v1/how-tos/upload</span>
</span><span id="Storage-403"><a href="#Storage-403"><span class="linenos">403</span></a>    <span class="c1"># pylint: disable=too-many-locals</span>
</span><span id="Storage-404"><a href="#Storage-404"><span class="linenos">404</span></a>    <span class="k">def</span> <span class="nf">upload</span><span class="p">(</span>
</span><span id="Storage-405"><a href="#Storage-405"><span class="linenos">405</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_data</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="Storage-406"><a href="#Storage-406"><span class="linenos">406</span></a>        <span class="o">*</span><span class="p">,</span> <span class="n">content_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-407"><a href="#Storage-407"><span class="linenos">407</span></a>        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-408"><a href="#Storage-408"><span class="linenos">408</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-409"><a href="#Storage-409"><span class="linenos">409</span></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-410"><a href="#Storage-410"><span class="linenos">410</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-411"><a href="#Storage-411"><span class="linenos">411</span></a>        <span class="n">force_resumable_upload</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-412"><a href="#Storage-412"><span class="linenos">412</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
</span><span id="Storage-413"><a href="#Storage-413"><span class="linenos">413</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Storage-414"><a href="#Storage-414"><span class="linenos">414</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_root_write</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s1">/o&#39;</span>
</span><span id="Storage-415"><a href="#Storage-415"><span class="linenos">415</span></a>
</span><span id="Storage-416"><a href="#Storage-416"><span class="linenos">416</span></a>        <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_data</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
</span><span id="Storage-417"><a href="#Storage-417"><span class="linenos">417</span></a>
</span><span id="Storage-418"><a href="#Storage-418"><span class="linenos">418</span></a>        <span class="k">if</span> <span class="n">BUILD_GCLOUD_REST</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">):</span>
</span><span id="Storage-419"><a href="#Storage-419"><span class="linenos">419</span></a>            <span class="c1"># HACK: `requests` library does not accept `str` as `data` in `put`</span>
</span><span id="Storage-420"><a href="#Storage-420"><span class="linenos">420</span></a>            <span class="c1"># HTTP request.</span>
</span><span id="Storage-421"><a href="#Storage-421"><span class="linenos">421</span></a>            <span class="n">stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</span><span id="Storage-422"><a href="#Storage-422"><span class="linenos">422</span></a>
</span><span id="Storage-423"><a href="#Storage-423"><span class="linenos">423</span></a>        <span class="n">content_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stream_len</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
</span><span id="Storage-424"><a href="#Storage-424"><span class="linenos">424</span></a>
</span><span id="Storage-425"><a href="#Storage-425"><span class="linenos">425</span></a>        <span class="c1"># mime detection method same as in aiohttp 3.4.4</span>
</span><span id="Storage-426"><a href="#Storage-426"><span class="linenos">426</span></a>        <span class="n">content_type</span> <span class="o">=</span> <span class="n">content_type</span> <span class="ow">or</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">object_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Storage-427"><a href="#Storage-427"><span class="linenos">427</span></a>
</span><span id="Storage-428"><a href="#Storage-428"><span class="linenos">428</span></a>        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage-429"><a href="#Storage-429"><span class="linenos">429</span></a>
</span><span id="Storage-430"><a href="#Storage-430"><span class="linenos">430</span></a>        <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage-431"><a href="#Storage-431"><span class="linenos">431</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">())</span>
</span><span id="Storage-432"><a href="#Storage-432"><span class="linenos">432</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
</span><span id="Storage-433"><a href="#Storage-433"><span class="linenos">433</span></a>            <span class="s1">&#39;Content-Length&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">content_length</span><span class="p">),</span>
</span><span id="Storage-434"><a href="#Storage-434"><span class="linenos">434</span></a>            <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="n">content_type</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span id="Storage-435"><a href="#Storage-435"><span class="linenos">435</span></a>        <span class="p">})</span>
</span><span id="Storage-436"><a href="#Storage-436"><span class="linenos">436</span></a>
</span><span id="Storage-437"><a href="#Storage-437"><span class="linenos">437</span></a>        <span class="n">upload_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decide_upload_type</span><span class="p">(</span>
</span><span id="Storage-438"><a href="#Storage-438"><span class="linenos">438</span></a>            <span class="n">force_resumable_upload</span><span class="p">,</span>
</span><span id="Storage-439"><a href="#Storage-439"><span class="linenos">439</span></a>            <span class="n">content_length</span><span class="p">,</span>
</span><span id="Storage-440"><a href="#Storage-440"><span class="linenos">440</span></a>        <span class="p">)</span>
</span><span id="Storage-441"><a href="#Storage-441"><span class="linenos">441</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;using </span><span class="si">%r</span><span class="s1"> gcloud storage upload method&#39;</span><span class="p">,</span> <span class="n">upload_type</span><span class="p">)</span>
</span><span id="Storage-442"><a href="#Storage-442"><span class="linenos">442</span></a>
</span><span id="Storage-443"><a href="#Storage-443"><span class="linenos">443</span></a>        <span class="k">if</span> <span class="n">upload_type</span> <span class="o">==</span> <span class="n">UploadType</span><span class="o">.</span><span class="n">RESUMABLE</span><span class="p">:</span>
</span><span id="Storage-444"><a href="#Storage-444"><span class="linenos">444</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upload_resumable</span><span class="p">(</span>
</span><span id="Storage-445"><a href="#Storage-445"><span class="linenos">445</span></a>                <span class="n">url</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span>
</span><span id="Storage-446"><a href="#Storage-446"><span class="linenos">446</span></a>                <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage-447"><a href="#Storage-447"><span class="linenos">447</span></a>            <span class="p">)</span>
</span><span id="Storage-448"><a href="#Storage-448"><span class="linenos">448</span></a>        <span class="k">if</span> <span class="n">upload_type</span> <span class="o">==</span> <span class="n">UploadType</span><span class="o">.</span><span class="n">SIMPLE</span><span class="p">:</span>
</span><span id="Storage-449"><a href="#Storage-449"><span class="linenos">449</span></a>            <span class="k">if</span> <span class="n">metadata</span><span class="p">:</span>
</span><span id="Storage-450"><a href="#Storage-450"><span class="linenos">450</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upload_multipart</span><span class="p">(</span>
</span><span id="Storage-451"><a href="#Storage-451"><span class="linenos">451</span></a>                    <span class="n">url</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
</span><span id="Storage-452"><a href="#Storage-452"><span class="linenos">452</span></a>                    <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage-453"><a href="#Storage-453"><span class="linenos">453</span></a>                <span class="p">)</span>
</span><span id="Storage-454"><a href="#Storage-454"><span class="linenos">454</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upload_simple</span><span class="p">(</span>
</span><span id="Storage-455"><a href="#Storage-455"><span class="linenos">455</span></a>                <span class="n">url</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
</span><span id="Storage-456"><a href="#Storage-456"><span class="linenos">456</span></a>                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage-457"><a href="#Storage-457"><span class="linenos">457</span></a>            <span class="p">)</span>
</span><span id="Storage-458"><a href="#Storage-458"><span class="linenos">458</span></a>
</span><span id="Storage-459"><a href="#Storage-459"><span class="linenos">459</span></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;upload type </span><span class="si">{</span><span class="n">upload_type</span><span class="si">}</span><span class="s1"> not supported&#39;</span><span class="p">)</span>
</span><span id="Storage-460"><a href="#Storage-460"><span class="linenos">460</span></a>
</span><span id="Storage-461"><a href="#Storage-461"><span class="linenos">461</span></a>    <span class="k">def</span> <span class="nf">upload_from_filename</span><span class="p">(</span>
</span><span id="Storage-462"><a href="#Storage-462"><span class="linenos">462</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Storage-463"><a href="#Storage-463"><span class="linenos">463</span></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Storage-464"><a href="#Storage-464"><span class="linenos">464</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="Storage-465"><a href="#Storage-465"><span class="linenos">465</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Storage-466"><a href="#Storage-466"><span class="linenos">466</span></a>        <span class="k">with</span> <span class="n">file_open</span><span class="p">(</span>  <span class="c1"># type: ignore[attr-defined]</span>
</span><span id="Storage-467"><a href="#Storage-467"><span class="linenos">467</span></a>                <span class="n">filename</span><span class="p">,</span>
</span><span id="Storage-468"><a href="#Storage-468"><span class="linenos">468</span></a>                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">,</span>
</span><span id="Storage-469"><a href="#Storage-469"><span class="linenos">469</span></a>        <span class="p">)</span> <span class="k">as</span> <span class="n">file_object</span><span class="p">:</span>
</span><span id="Storage-470"><a href="#Storage-470"><span class="linenos">470</span></a>            <span class="n">contents</span> <span class="o">=</span> <span class="n">file_object</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="Storage-471"><a href="#Storage-471"><span class="linenos">471</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">contents</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="Storage-472"><a href="#Storage-472"><span class="linenos">472</span></a>
</span><span id="Storage-473"><a href="#Storage-473"><span class="linenos">473</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Storage-474"><a href="#Storage-474"><span class="linenos">474</span></a>    <span class="k">def</span> <span class="nf">_get_stream_len</span><span class="p">(</span><span class="n">stream</span><span class="p">:</span> <span class="n">IO</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Storage-475"><a href="#Storage-475"><span class="linenos">475</span></a>        <span class="n">current</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
</span><span id="Storage-476"><a href="#Storage-476"><span class="linenos">476</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Storage-477"><a href="#Storage-477"><span class="linenos">477</span></a>            <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_END</span><span class="p">)</span>
</span><span id="Storage-478"><a href="#Storage-478"><span class="linenos">478</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="Storage-479"><a href="#Storage-479"><span class="linenos">479</span></a>            <span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
</span><span id="Storage-480"><a href="#Storage-480"><span class="linenos">480</span></a>
</span><span id="Storage-481"><a href="#Storage-481"><span class="linenos">481</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Storage-482"><a href="#Storage-482"><span class="linenos">482</span></a>    <span class="k">def</span> <span class="nf">_preprocess_data</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IO</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="Storage-483"><a href="#Storage-483"><span class="linenos">483</span></a>        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Storage-484"><a href="#Storage-484"><span class="linenos">484</span></a>            <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="Storage-485"><a href="#Storage-485"><span class="linenos">485</span></a>
</span><span id="Storage-486"><a href="#Storage-486"><span class="linenos">486</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
</span><span id="Storage-487"><a href="#Storage-487"><span class="linenos">487</span></a>            <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="Storage-488"><a href="#Storage-488"><span class="linenos">488</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Storage-489"><a href="#Storage-489"><span class="linenos">489</span></a>            <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="Storage-490"><a href="#Storage-490"><span class="linenos">490</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">):</span>
</span><span id="Storage-491"><a href="#Storage-491"><span class="linenos">491</span></a>            <span class="k">return</span> <span class="n">data</span>  <span class="c1"># type: ignore[return-value]</span>
</span><span id="Storage-492"><a href="#Storage-492"><span class="linenos">492</span></a>
</span><span id="Storage-493"><a href="#Storage-493"><span class="linenos">493</span></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unsupported upload type: &quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
</span><span id="Storage-494"><a href="#Storage-494"><span class="linenos">494</span></a>
</span><span id="Storage-495"><a href="#Storage-495"><span class="linenos">495</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Storage-496"><a href="#Storage-496"><span class="linenos">496</span></a>    <span class="k">def</span> <span class="nf">_decide_upload_type</span><span class="p">(</span>
</span><span id="Storage-497"><a href="#Storage-497"><span class="linenos">497</span></a>        <span class="n">force_resumable_upload</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
</span><span id="Storage-498"><a href="#Storage-498"><span class="linenos">498</span></a>        <span class="n">content_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="Storage-499"><a href="#Storage-499"><span class="linenos">499</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UploadType</span><span class="p">:</span>
</span><span id="Storage-500"><a href="#Storage-500"><span class="linenos">500</span></a>        <span class="c1"># force resumable</span>
</span><span id="Storage-501"><a href="#Storage-501"><span class="linenos">501</span></a>        <span class="k">if</span> <span class="n">force_resumable_upload</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="Storage-502"><a href="#Storage-502"><span class="linenos">502</span></a>            <span class="k">return</span> <span class="n">UploadType</span><span class="o">.</span><span class="n">RESUMABLE</span>
</span><span id="Storage-503"><a href="#Storage-503"><span class="linenos">503</span></a>
</span><span id="Storage-504"><a href="#Storage-504"><span class="linenos">504</span></a>        <span class="c1"># force simple</span>
</span><span id="Storage-505"><a href="#Storage-505"><span class="linenos">505</span></a>        <span class="k">if</span> <span class="n">force_resumable_upload</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="Storage-506"><a href="#Storage-506"><span class="linenos">506</span></a>            <span class="k">return</span> <span class="n">UploadType</span><span class="o">.</span><span class="n">SIMPLE</span>
</span><span id="Storage-507"><a href="#Storage-507"><span class="linenos">507</span></a>
</span><span id="Storage-508"><a href="#Storage-508"><span class="linenos">508</span></a>        <span class="c1"># decide based on Content-Length</span>
</span><span id="Storage-509"><a href="#Storage-509"><span class="linenos">509</span></a>        <span class="k">if</span> <span class="n">content_length</span> <span class="o">&gt;</span> <span class="n">MAX_CONTENT_LENGTH_SIMPLE_UPLOAD</span><span class="p">:</span>
</span><span id="Storage-510"><a href="#Storage-510"><span class="linenos">510</span></a>            <span class="k">return</span> <span class="n">UploadType</span><span class="o">.</span><span class="n">RESUMABLE</span>
</span><span id="Storage-511"><a href="#Storage-511"><span class="linenos">511</span></a>
</span><span id="Storage-512"><a href="#Storage-512"><span class="linenos">512</span></a>        <span class="k">return</span> <span class="n">UploadType</span><span class="o">.</span><span class="n">SIMPLE</span>
</span><span id="Storage-513"><a href="#Storage-513"><span class="linenos">513</span></a>
</span><span id="Storage-514"><a href="#Storage-514"><span class="linenos">514</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Storage-515"><a href="#Storage-515"><span class="linenos">515</span></a>    <span class="k">def</span> <span class="nf">_split_content_type</span><span class="p">(</span><span class="n">content_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
</span><span id="Storage-516"><a href="#Storage-516"><span class="linenos">516</span></a>        <span class="n">content_type_and_encoding_split</span> <span class="o">=</span> <span class="n">content_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
</span><span id="Storage-517"><a href="#Storage-517"><span class="linenos">517</span></a>        <span class="n">content_type</span> <span class="o">=</span> <span class="n">content_type_and_encoding_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="Storage-518"><a href="#Storage-518"><span class="linenos">518</span></a>
</span><span id="Storage-519"><a href="#Storage-519"><span class="linenos">519</span></a>        <span class="n">encoding</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Storage-520"><a href="#Storage-520"><span class="linenos">520</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content_type_and_encoding_split</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Storage-521"><a href="#Storage-521"><span class="linenos">521</span></a>            <span class="n">encoding_str</span> <span class="o">=</span> <span class="n">content_type_and_encoding_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="Storage-522"><a href="#Storage-522"><span class="linenos">522</span></a>            <span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Storage-523"><a href="#Storage-523"><span class="linenos">523</span></a>
</span><span id="Storage-524"><a href="#Storage-524"><span class="linenos">524</span></a>        <span class="k">return</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">encoding</span>
</span><span id="Storage-525"><a href="#Storage-525"><span class="linenos">525</span></a>
</span><span id="Storage-526"><a href="#Storage-526"><span class="linenos">526</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Storage-527"><a href="#Storage-527"><span class="linenos">527</span></a>    <span class="k">def</span> <span class="nf">_format_metadata_key</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Storage-528"><a href="#Storage-528"><span class="linenos">528</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Storage-529"><a href="#Storage-529"><span class="linenos">529</span></a><span class="sd">        Formats the fixed-key metadata keys as wanted by the multipart API.</span>
</span><span id="Storage-530"><a href="#Storage-530"><span class="linenos">530</span></a>
</span><span id="Storage-531"><a href="#Storage-531"><span class="linenos">531</span></a><span class="sd">        Ex: Content-Disposition --&gt; contentDisposition</span>
</span><span id="Storage-532"><a href="#Storage-532"><span class="linenos">532</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Storage-533"><a href="#Storage-533"><span class="linenos">533</span></a>        <span class="n">parts</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
</span><span id="Storage-534"><a href="#Storage-534"><span class="linenos">534</span></a>        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">+</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
</span><span id="Storage-535"><a href="#Storage-535"><span class="linenos">535</span></a>        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
</span><span id="Storage-536"><a href="#Storage-536"><span class="linenos">536</span></a>
</span><span id="Storage-537"><a href="#Storage-537"><span class="linenos">537</span></a>    <span class="k">def</span> <span class="nf">_download</span><span class="p">(</span>
</span><span id="Storage-538"><a href="#Storage-538"><span class="linenos">538</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
</span><span id="Storage-539"><a href="#Storage-539"><span class="linenos">539</span></a>        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-540"><a href="#Storage-540"><span class="linenos">540</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-541"><a href="#Storage-541"><span class="linenos">541</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Storage-542"><a href="#Storage-542"><span class="linenos">542</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-543"><a href="#Storage-543"><span class="linenos">543</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="Storage-544"><a href="#Storage-544"><span class="linenos">544</span></a>        <span class="c1"># https://cloud.google.com/storage/docs/request-endpoints#encoding</span>
</span><span id="Storage-545"><a href="#Storage-545"><span class="linenos">545</span></a>        <span class="n">encoded_object_name</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="Storage-546"><a href="#Storage-546"><span class="linenos">546</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_root_read</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s1">/o/</span><span class="si">{</span><span class="n">encoded_object_name</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Storage-547"><a href="#Storage-547"><span class="linenos">547</span></a>        <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage-548"><a href="#Storage-548"><span class="linenos">548</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">())</span>
</span><span id="Storage-549"><a href="#Storage-549"><span class="linenos">549</span></a>
</span><span id="Storage-550"><a href="#Storage-550"><span class="linenos">550</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">SyncSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="k">if</span> <span class="n">session</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span id="Storage-551"><a href="#Storage-551"><span class="linenos">551</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="Storage-552"><a href="#Storage-552"><span class="linenos">552</span></a>            <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{},</span>
</span><span id="Storage-553"><a href="#Storage-553"><span class="linenos">553</span></a>            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage-554"><a href="#Storage-554"><span class="linenos">554</span></a>        <span class="p">)</span>
</span><span id="Storage-555"><a href="#Storage-555"><span class="linenos">555</span></a>
</span><span id="Storage-556"><a href="#Storage-556"><span class="linenos">556</span></a>        <span class="c1"># N.B. the GCS API sometimes returns &#39;application/octet-stream&#39; when a</span>
</span><span id="Storage-557"><a href="#Storage-557"><span class="linenos">557</span></a>        <span class="c1"># string was uploaded. To avoid potential weirdness, always return a</span>
</span><span id="Storage-558"><a href="#Storage-558"><span class="linenos">558</span></a>        <span class="c1"># bytes object.</span>
</span><span id="Storage-559"><a href="#Storage-559"><span class="linenos">559</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Storage-560"><a href="#Storage-560"><span class="linenos">560</span></a>            <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="Storage-561"><a href="#Storage-561"><span class="linenos">561</span></a>        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
</span><span id="Storage-562"><a href="#Storage-562"><span class="linenos">562</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>  <span class="c1"># type: ignore[assignment]</span>
</span><span id="Storage-563"><a href="#Storage-563"><span class="linenos">563</span></a>
</span><span id="Storage-564"><a href="#Storage-564"><span class="linenos">564</span></a>        <span class="k">return</span> <span class="n">data</span>
</span><span id="Storage-565"><a href="#Storage-565"><span class="linenos">565</span></a>
</span><span id="Storage-566"><a href="#Storage-566"><span class="linenos">566</span></a>    <span class="k">def</span> <span class="nf">_download_stream</span><span class="p">(</span>
</span><span id="Storage-567"><a href="#Storage-567"><span class="linenos">567</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
</span><span id="Storage-568"><a href="#Storage-568"><span class="linenos">568</span></a>        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-569"><a href="#Storage-569"><span class="linenos">569</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-570"><a href="#Storage-570"><span class="linenos">570</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Storage-571"><a href="#Storage-571"><span class="linenos">571</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-572"><a href="#Storage-572"><span class="linenos">572</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StreamResponse</span><span class="p">:</span>
</span><span id="Storage-573"><a href="#Storage-573"><span class="linenos">573</span></a>        <span class="c1"># https://cloud.google.com/storage/docs/request-endpoints#encoding</span>
</span><span id="Storage-574"><a href="#Storage-574"><span class="linenos">574</span></a>        <span class="n">encoded_object_name</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="Storage-575"><a href="#Storage-575"><span class="linenos">575</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_root_read</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s1">/o/</span><span class="si">{</span><span class="n">encoded_object_name</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Storage-576"><a href="#Storage-576"><span class="linenos">576</span></a>        <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage-577"><a href="#Storage-577"><span class="linenos">577</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">())</span>
</span><span id="Storage-578"><a href="#Storage-578"><span class="linenos">578</span></a>
</span><span id="Storage-579"><a href="#Storage-579"><span class="linenos">579</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">SyncSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="k">if</span> <span class="n">session</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span id="Storage-580"><a href="#Storage-580"><span class="linenos">580</span></a>
</span><span id="Storage-581"><a href="#Storage-581"><span class="linenos">581</span></a>        <span class="k">if</span> <span class="n">BUILD_GCLOUD_REST</span><span class="p">:</span>
</span><span id="Storage-582"><a href="#Storage-582"><span class="linenos">582</span></a>            <span class="c1"># stream argument is only expected by requests.Session.</span>
</span><span id="Storage-583"><a href="#Storage-583"><span class="linenos">583</span></a>            <span class="c1"># pylint: disable=unexpected-keyword-arg</span>
</span><span id="Storage-584"><a href="#Storage-584"><span class="linenos">584</span></a>            <span class="k">return</span> <span class="n">StreamResponse</span><span class="p">(</span>
</span><span id="Storage-585"><a href="#Storage-585"><span class="linenos">585</span></a>                <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="Storage-586"><a href="#Storage-586"><span class="linenos">586</span></a>                    <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{},</span>
</span><span id="Storage-587"><a href="#Storage-587"><span class="linenos">587</span></a>                    <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Storage-588"><a href="#Storage-588"><span class="linenos">588</span></a>                <span class="p">),</span>
</span><span id="Storage-589"><a href="#Storage-589"><span class="linenos">589</span></a>            <span class="p">)</span>
</span><span id="Storage-590"><a href="#Storage-590"><span class="linenos">590</span></a>        <span class="k">return</span> <span class="n">StreamResponse</span><span class="p">(</span>
</span><span id="Storage-591"><a href="#Storage-591"><span class="linenos">591</span></a>            <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="Storage-592"><a href="#Storage-592"><span class="linenos">592</span></a>                <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{},</span>
</span><span id="Storage-593"><a href="#Storage-593"><span class="linenos">593</span></a>                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage-594"><a href="#Storage-594"><span class="linenos">594</span></a>            <span class="p">),</span>
</span><span id="Storage-595"><a href="#Storage-595"><span class="linenos">595</span></a>        <span class="p">)</span>
</span><span id="Storage-596"><a href="#Storage-596"><span class="linenos">596</span></a>
</span><span id="Storage-597"><a href="#Storage-597"><span class="linenos">597</span></a>    <span class="k">def</span> <span class="nf">_upload_simple</span><span class="p">(</span>
</span><span id="Storage-598"><a href="#Storage-598"><span class="linenos">598</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Storage-599"><a href="#Storage-599"><span class="linenos">599</span></a>        <span class="n">stream</span><span class="p">:</span> <span class="n">IO</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">],</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
</span><span id="Storage-600"><a href="#Storage-600"><span class="linenos">600</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span>
</span><span id="Storage-601"><a href="#Storage-601"><span class="linenos">601</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-602"><a href="#Storage-602"><span class="linenos">602</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
</span><span id="Storage-603"><a href="#Storage-603"><span class="linenos">603</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Storage-604"><a href="#Storage-604"><span class="linenos">604</span></a>        <span class="c1"># https://cloud.google.com/storage/docs/json_api/v1/how-tos/simple-upload</span>
</span><span id="Storage-605"><a href="#Storage-605"><span class="linenos">605</span></a>        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">object_name</span>
</span><span id="Storage-606"><a href="#Storage-606"><span class="linenos">606</span></a>        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;uploadType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;media&#39;</span>
</span><span id="Storage-607"><a href="#Storage-607"><span class="linenos">607</span></a>
</span><span id="Storage-608"><a href="#Storage-608"><span class="linenos">608</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">SyncSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="k">if</span> <span class="n">session</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span id="Storage-609"><a href="#Storage-609"><span class="linenos">609</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span><span id="Storage-610"><a href="#Storage-610"><span class="linenos">610</span></a>            <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
</span><span id="Storage-611"><a href="#Storage-611"><span class="linenos">611</span></a>            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage-612"><a href="#Storage-612"><span class="linenos">612</span></a>        <span class="p">)</span>
</span><span id="Storage-613"><a href="#Storage-613"><span class="linenos">613</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="Storage-614"><a href="#Storage-614"><span class="linenos">614</span></a>        <span class="k">return</span> <span class="n">data</span>
</span><span id="Storage-615"><a href="#Storage-615"><span class="linenos">615</span></a>
</span><span id="Storage-616"><a href="#Storage-616"><span class="linenos">616</span></a>    <span class="k">def</span> <span class="nf">_upload_multipart</span><span class="p">(</span>
</span><span id="Storage-617"><a href="#Storage-617"><span class="linenos">617</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Storage-618"><a href="#Storage-618"><span class="linenos">618</span></a>        <span class="n">stream</span><span class="p">:</span> <span class="n">IO</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">],</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
</span><span id="Storage-619"><a href="#Storage-619"><span class="linenos">619</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
</span><span id="Storage-620"><a href="#Storage-620"><span class="linenos">620</span></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span>
</span><span id="Storage-621"><a href="#Storage-621"><span class="linenos">621</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-622"><a href="#Storage-622"><span class="linenos">622</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
</span><span id="Storage-623"><a href="#Storage-623"><span class="linenos">623</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Storage-624"><a href="#Storage-624"><span class="linenos">624</span></a>        <span class="c1"># https://cloud.google.com/storage/docs/json_api/v1/how-tos/multipart-upload</span>
</span><span id="Storage-625"><a href="#Storage-625"><span class="linenos">625</span></a>        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;uploadType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;multipart&#39;</span>
</span><span id="Storage-626"><a href="#Storage-626"><span class="linenos">626</span></a>
</span><span id="Storage-627"><a href="#Storage-627"><span class="linenos">627</span></a>        <span class="n">metadata_headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json; charset=UTF-8&#39;</span><span class="p">}</span>
</span><span id="Storage-628"><a href="#Storage-628"><span class="linenos">628</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Storage-629"><a href="#Storage-629"><span class="linenos">629</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_format_metadata_key</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span>
</span><span id="Storage-630"><a href="#Storage-630"><span class="linenos">630</span></a>            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Storage-631"><a href="#Storage-631"><span class="linenos">631</span></a>        <span class="p">}</span>
</span><span id="Storage-632"><a href="#Storage-632"><span class="linenos">632</span></a>        <span class="k">if</span> <span class="s1">&#39;metadata&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
</span><span id="Storage-633"><a href="#Storage-633"><span class="linenos">633</span></a>            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Storage-634"><a href="#Storage-634"><span class="linenos">634</span></a>                <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Storage-635"><a href="#Storage-635"><span class="linenos">635</span></a>                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Storage-636"><a href="#Storage-636"><span class="linenos">636</span></a>            <span class="p">}</span>
</span><span id="Storage-637"><a href="#Storage-637"><span class="linenos">637</span></a>
</span><span id="Storage-638"><a href="#Storage-638"><span class="linenos">638</span></a>        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">object_name</span>
</span><span id="Storage-639"><a href="#Storage-639"><span class="linenos">639</span></a>
</span><span id="Storage-640"><a href="#Storage-640"><span class="linenos">640</span></a>        <span class="n">raw_body</span><span class="p">:</span> <span class="n">AnyStr</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="Storage-641"><a href="#Storage-641"><span class="linenos">641</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_body</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Storage-642"><a href="#Storage-642"><span class="linenos">642</span></a>            <span class="n">bytes_body</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">raw_body</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span><span id="Storage-643"><a href="#Storage-643"><span class="linenos">643</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Storage-644"><a href="#Storage-644"><span class="linenos">644</span></a>            <span class="n">bytes_body</span> <span class="o">=</span> <span class="n">raw_body</span>
</span><span id="Storage-645"><a href="#Storage-645"><span class="linenos">645</span></a>
</span><span id="Storage-646"><a href="#Storage-646"><span class="linenos">646</span></a>        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Storage-647"><a href="#Storage-647"><span class="linenos">647</span></a>            <span class="p">(</span><span class="n">metadata_headers</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)),</span>
</span><span id="Storage-648"><a href="#Storage-648"><span class="linenos">648</span></a>            <span class="p">({</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]},</span> <span class="n">bytes_body</span><span class="p">),</span>
</span><span id="Storage-649"><a href="#Storage-649"><span class="linenos">649</span></a>        <span class="p">]</span>
</span><span id="Storage-650"><a href="#Storage-650"><span class="linenos">650</span></a>        <span class="n">boundary</span> <span class="o">=</span> <span class="n">choose_boundary</span><span class="p">()</span>
</span><span id="Storage-651"><a href="#Storage-651"><span class="linenos">651</span></a>        <span class="n">body</span><span class="p">,</span> <span class="n">content_type</span> <span class="o">=</span> <span class="n">encode_multipart_formdata</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span> <span class="n">boundary</span><span class="p">)</span>
</span><span id="Storage-652"><a href="#Storage-652"><span class="linenos">652</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
</span><span id="Storage-653"><a href="#Storage-653"><span class="linenos">653</span></a>            <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="n">content_type</span><span class="p">,</span>
</span><span id="Storage-654"><a href="#Storage-654"><span class="linenos">654</span></a>            <span class="s1">&#39;Content-Length&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)),</span>
</span><span id="Storage-655"><a href="#Storage-655"><span class="linenos">655</span></a>            <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
</span><span id="Storage-656"><a href="#Storage-656"><span class="linenos">656</span></a>        <span class="p">})</span>
</span><span id="Storage-657"><a href="#Storage-657"><span class="linenos">657</span></a>
</span><span id="Storage-658"><a href="#Storage-658"><span class="linenos">658</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">SyncSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="k">if</span> <span class="n">session</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span id="Storage-659"><a href="#Storage-659"><span class="linenos">659</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">BUILD_GCLOUD_REST</span><span class="p">:</span>
</span><span id="Storage-660"><a href="#Storage-660"><span class="linenos">660</span></a>            <span class="c1"># Wrap data in BytesIO to ensure aiohttp does not emit warning</span>
</span><span id="Storage-661"><a href="#Storage-661"><span class="linenos">661</span></a>            <span class="c1"># when payload size &gt; 1MB</span>
</span><span id="Storage-662"><a href="#Storage-662"><span class="linenos">662</span></a>            <span class="n">body</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>  <span class="c1"># type: ignore[assignment]</span>
</span><span id="Storage-663"><a href="#Storage-663"><span class="linenos">663</span></a>
</span><span id="Storage-664"><a href="#Storage-664"><span class="linenos">664</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span><span id="Storage-665"><a href="#Storage-665"><span class="linenos">665</span></a>            <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
</span><span id="Storage-666"><a href="#Storage-666"><span class="linenos">666</span></a>            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage-667"><a href="#Storage-667"><span class="linenos">667</span></a>        <span class="p">)</span>
</span><span id="Storage-668"><a href="#Storage-668"><span class="linenos">668</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="Storage-669"><a href="#Storage-669"><span class="linenos">669</span></a>        <span class="k">return</span> <span class="n">data</span>
</span><span id="Storage-670"><a href="#Storage-670"><span class="linenos">670</span></a>
</span><span id="Storage-671"><a href="#Storage-671"><span class="linenos">671</span></a>    <span class="k">def</span> <span class="nf">_upload_resumable</span><span class="p">(</span>
</span><span id="Storage-672"><a href="#Storage-672"><span class="linenos">672</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Storage-673"><a href="#Storage-673"><span class="linenos">673</span></a>        <span class="n">stream</span><span class="p">:</span> <span class="n">IO</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">],</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
</span><span id="Storage-674"><a href="#Storage-674"><span class="linenos">674</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span>
</span><span id="Storage-675"><a href="#Storage-675"><span class="linenos">675</span></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-676"><a href="#Storage-676"><span class="linenos">676</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-677"><a href="#Storage-677"><span class="linenos">677</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
</span><span id="Storage-678"><a href="#Storage-678"><span class="linenos">678</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Storage-679"><a href="#Storage-679"><span class="linenos">679</span></a>        <span class="c1"># https://cloud.google.com/storage/docs/json_api/v1/how-tos/resumable-upload</span>
</span><span id="Storage-680"><a href="#Storage-680"><span class="linenos">680</span></a>        <span class="n">session_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initiate_upload</span><span class="p">(</span>
</span><span id="Storage-681"><a href="#Storage-681"><span class="linenos">681</span></a>            <span class="n">url</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
</span><span id="Storage-682"><a href="#Storage-682"><span class="linenos">682</span></a>            <span class="n">headers</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
</span><span id="Storage-683"><a href="#Storage-683"><span class="linenos">683</span></a>            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
</span><span id="Storage-684"><a href="#Storage-684"><span class="linenos">684</span></a>        <span class="p">)</span>
</span><span id="Storage-685"><a href="#Storage-685"><span class="linenos">685</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_upload</span><span class="p">(</span>
</span><span id="Storage-686"><a href="#Storage-686"><span class="linenos">686</span></a>            <span class="n">session_uri</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
</span><span id="Storage-687"><a href="#Storage-687"><span class="linenos">687</span></a>            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage-688"><a href="#Storage-688"><span class="linenos">688</span></a>        <span class="p">)</span>
</span><span id="Storage-689"><a href="#Storage-689"><span class="linenos">689</span></a>
</span><span id="Storage-690"><a href="#Storage-690"><span class="linenos">690</span></a>    <span class="k">def</span> <span class="nf">_initiate_upload</span><span class="p">(</span>
</span><span id="Storage-691"><a href="#Storage-691"><span class="linenos">691</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Storage-692"><a href="#Storage-692"><span class="linenos">692</span></a>        <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
</span><span id="Storage-693"><a href="#Storage-693"><span class="linenos">693</span></a>        <span class="o">*</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-694"><a href="#Storage-694"><span class="linenos">694</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Storage-695"><a href="#Storage-695"><span class="linenos">695</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-696"><a href="#Storage-696"><span class="linenos">696</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Storage-697"><a href="#Storage-697"><span class="linenos">697</span></a>        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;uploadType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;resumable&#39;</span>
</span><span id="Storage-698"><a href="#Storage-698"><span class="linenos">698</span></a>
</span><span id="Storage-699"><a href="#Storage-699"><span class="linenos">699</span></a>        <span class="n">metadict</span> <span class="o">=</span> <span class="p">(</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Storage-700"><a href="#Storage-700"><span class="linenos">700</span></a>        <span class="n">metadict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Storage-701"><a href="#Storage-701"><span class="linenos">701</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_format_metadata_key</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span>
</span><span id="Storage-702"><a href="#Storage-702"><span class="linenos">702</span></a>            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metadict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Storage-703"><a href="#Storage-703"><span class="linenos">703</span></a>        <span class="p">}</span>
</span><span id="Storage-704"><a href="#Storage-704"><span class="linenos">704</span></a>        <span class="k">if</span> <span class="s1">&#39;metadata&#39;</span> <span class="ow">in</span> <span class="n">metadict</span><span class="p">:</span>
</span><span id="Storage-705"><a href="#Storage-705"><span class="linenos">705</span></a>            <span class="n">metadict</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Storage-706"><a href="#Storage-706"><span class="linenos">706</span></a>                <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Storage-707"><a href="#Storage-707"><span class="linenos">707</span></a>                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metadict</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Storage-708"><a href="#Storage-708"><span class="linenos">708</span></a>            <span class="p">}</span>
</span><span id="Storage-709"><a href="#Storage-709"><span class="linenos">709</span></a>
</span><span id="Storage-710"><a href="#Storage-710"><span class="linenos">710</span></a>        <span class="n">metadict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">object_name</span><span class="p">})</span>
</span><span id="Storage-711"><a href="#Storage-711"><span class="linenos">711</span></a>        <span class="n">metadata_</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadict</span><span class="p">)</span>
</span><span id="Storage-712"><a href="#Storage-712"><span class="linenos">712</span></a>
</span><span id="Storage-713"><a href="#Storage-713"><span class="linenos">713</span></a>        <span class="n">post_headers</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Storage-714"><a href="#Storage-714"><span class="linenos">714</span></a>        <span class="n">post_headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
</span><span id="Storage-715"><a href="#Storage-715"><span class="linenos">715</span></a>            <span class="s1">&#39;Content-Length&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metadata_</span><span class="p">)),</span>
</span><span id="Storage-716"><a href="#Storage-716"><span class="linenos">716</span></a>            <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json; charset=UTF-8&#39;</span><span class="p">,</span>
</span><span id="Storage-717"><a href="#Storage-717"><span class="linenos">717</span></a>            <span class="s1">&#39;X-Upload-Content-Type&#39;</span><span class="p">:</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">],</span>
</span><span id="Storage-718"><a href="#Storage-718"><span class="linenos">718</span></a>            <span class="s1">&#39;X-Upload-Content-Length&#39;</span><span class="p">:</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">],</span>
</span><span id="Storage-719"><a href="#Storage-719"><span class="linenos">719</span></a>        <span class="p">})</span>
</span><span id="Storage-720"><a href="#Storage-720"><span class="linenos">720</span></a>
</span><span id="Storage-721"><a href="#Storage-721"><span class="linenos">721</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">SyncSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="k">if</span> <span class="n">session</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span id="Storage-722"><a href="#Storage-722"><span class="linenos">722</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span><span id="Storage-723"><a href="#Storage-723"><span class="linenos">723</span></a>            <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">post_headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
</span><span id="Storage-724"><a href="#Storage-724"><span class="linenos">724</span></a>            <span class="n">data</span><span class="o">=</span><span class="n">metadata_</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage-725"><a href="#Storage-725"><span class="linenos">725</span></a>        <span class="p">)</span>
</span><span id="Storage-726"><a href="#Storage-726"><span class="linenos">726</span></a>        <span class="n">session_uri</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Location&#39;</span><span class="p">]</span>
</span><span id="Storage-727"><a href="#Storage-727"><span class="linenos">727</span></a>        <span class="k">return</span> <span class="n">session_uri</span>
</span><span id="Storage-728"><a href="#Storage-728"><span class="linenos">728</span></a>
</span><span id="Storage-729"><a href="#Storage-729"><span class="linenos">729</span></a>    <span class="k">def</span> <span class="nf">_do_upload</span><span class="p">(</span>
</span><span id="Storage-730"><a href="#Storage-730"><span class="linenos">730</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">session_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stream</span><span class="p">:</span> <span class="n">IO</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">],</span>
</span><span id="Storage-731"><a href="#Storage-731"><span class="linenos">731</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="Storage-732"><a href="#Storage-732"><span class="linenos">732</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-733"><a href="#Storage-733"><span class="linenos">733</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
</span><span id="Storage-734"><a href="#Storage-734"><span class="linenos">734</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Storage-735"><a href="#Storage-735"><span class="linenos">735</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">SyncSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="k">if</span> <span class="n">session</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span id="Storage-736"><a href="#Storage-736"><span class="linenos">736</span></a>
</span><span id="Storage-737"><a href="#Storage-737"><span class="linenos">737</span></a>        <span class="n">original_close</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">close</span>
</span><span id="Storage-738"><a href="#Storage-738"><span class="linenos">738</span></a>        <span class="n">original_position</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
</span><span id="Storage-739"><a href="#Storage-739"><span class="linenos">739</span></a>        <span class="c1"># Prevent the stream being closed if put operation fails</span>
</span><span id="Storage-740"><a href="#Storage-740"><span class="linenos">740</span></a>        <span class="n">stream</span><span class="o">.</span><span class="n">close</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span>  <span class="c1"># type: ignore[method-assign]</span>
</span><span id="Storage-741"><a href="#Storage-741"><span class="linenos">741</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Storage-742"><a href="#Storage-742"><span class="linenos">742</span></a>            <span class="k">for</span> <span class="n">tries</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">retries</span><span class="p">):</span>
</span><span id="Storage-743"><a href="#Storage-743"><span class="linenos">743</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="Storage-744"><a href="#Storage-744"><span class="linenos">744</span></a>                    <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
</span><span id="Storage-745"><a href="#Storage-745"><span class="linenos">745</span></a>                        <span class="n">session_uri</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
</span><span id="Storage-746"><a href="#Storage-746"><span class="linenos">746</span></a>                        <span class="n">data</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage-747"><a href="#Storage-747"><span class="linenos">747</span></a>                    <span class="p">)</span>
</span><span id="Storage-748"><a href="#Storage-748"><span class="linenos">748</span></a>                <span class="k">except</span> <span class="n">ResponseError</span><span class="p">:</span>
</span><span id="Storage-749"><a href="#Storage-749"><span class="linenos">749</span></a>                    <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;Content-Range&#39;</span><span class="p">:</span> <span class="s1">&#39;*/*&#39;</span><span class="p">})</span>
</span><span id="Storage-750"><a href="#Storage-750"><span class="linenos">750</span></a>                    <span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">original_position</span><span class="p">)</span>
</span><span id="Storage-751"><a href="#Storage-751"><span class="linenos">751</span></a>
</span><span id="Storage-752"><a href="#Storage-752"><span class="linenos">752</span></a>                    <span class="n">sleep</span><span class="p">(</span>  <span class="c1"># type: ignore[func-returns-value]</span>
</span><span id="Storage-753"><a href="#Storage-753"><span class="linenos">753</span></a>                        <span class="mf">2.</span> <span class="o">**</span> <span class="n">tries</span><span class="p">,</span>
</span><span id="Storage-754"><a href="#Storage-754"><span class="linenos">754</span></a>                    <span class="p">)</span>
</span><span id="Storage-755"><a href="#Storage-755"><span class="linenos">755</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Storage-756"><a href="#Storage-756"><span class="linenos">756</span></a>                    <span class="k">break</span>
</span><span id="Storage-757"><a href="#Storage-757"><span class="linenos">757</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="Storage-758"><a href="#Storage-758"><span class="linenos">758</span></a>            <span class="n">original_close</span><span class="p">()</span>
</span><span id="Storage-759"><a href="#Storage-759"><span class="linenos">759</span></a>
</span><span id="Storage-760"><a href="#Storage-760"><span class="linenos">760</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="Storage-761"><a href="#Storage-761"><span class="linenos">761</span></a>        <span class="k">return</span> <span class="n">data</span>
</span><span id="Storage-762"><a href="#Storage-762"><span class="linenos">762</span></a>
</span><span id="Storage-763"><a href="#Storage-763"><span class="linenos">763</span></a>    <span class="k">def</span> <span class="nf">patch_metadata</span><span class="p">(</span>
</span><span id="Storage-764"><a href="#Storage-764"><span class="linenos">764</span></a>            <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="Storage-765"><a href="#Storage-765"><span class="linenos">765</span></a>            <span class="o">*</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-766"><a href="#Storage-766"><span class="linenos">766</span></a>            <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-767"><a href="#Storage-767"><span class="linenos">767</span></a>            <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-768"><a href="#Storage-768"><span class="linenos">768</span></a>            <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Storage-769"><a href="#Storage-769"><span class="linenos">769</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Storage-770"><a href="#Storage-770"><span class="linenos">770</span></a>        <span class="c1"># https://cloud.google.com/storage/docs/json_api/v1/objects/patch</span>
</span><span id="Storage-771"><a href="#Storage-771"><span class="linenos">771</span></a>        <span class="n">encoded_object_name</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="Storage-772"><a href="#Storage-772"><span class="linenos">772</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_root_read</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s1">/o/</span><span class="si">{</span><span class="n">encoded_object_name</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Storage-773"><a href="#Storage-773"><span class="linenos">773</span></a>        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage-774"><a href="#Storage-774"><span class="linenos">774</span></a>        <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage-775"><a href="#Storage-775"><span class="linenos">775</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">())</span>
</span><span id="Storage-776"><a href="#Storage-776"><span class="linenos">776</span></a>        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;application/json&#39;</span>
</span><span id="Storage-777"><a href="#Storage-777"><span class="linenos">777</span></a>        <span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span><span id="Storage-778"><a href="#Storage-778"><span class="linenos">778</span></a>
</span><span id="Storage-779"><a href="#Storage-779"><span class="linenos">779</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">SyncSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="k">if</span> <span class="n">session</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span id="Storage-780"><a href="#Storage-780"><span class="linenos">780</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span>
</span><span id="Storage-781"><a href="#Storage-781"><span class="linenos">781</span></a>            <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
</span><span id="Storage-782"><a href="#Storage-782"><span class="linenos">782</span></a>            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage-783"><a href="#Storage-783"><span class="linenos">783</span></a>        <span class="p">)</span>
</span><span id="Storage-784"><a href="#Storage-784"><span class="linenos">784</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="Storage-785"><a href="#Storage-785"><span class="linenos">785</span></a>        <span class="k">return</span> <span class="n">data</span>
</span><span id="Storage-786"><a href="#Storage-786"><span class="linenos">786</span></a>
</span><span id="Storage-787"><a href="#Storage-787"><span class="linenos">787</span></a>    <span class="k">def</span> <span class="nf">get_bucket_metadata</span><span class="p">(</span>
</span><span id="Storage-788"><a href="#Storage-788"><span class="linenos">788</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
</span><span id="Storage-789"><a href="#Storage-789"><span class="linenos">789</span></a>        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-790"><a href="#Storage-790"><span class="linenos">790</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-791"><a href="#Storage-791"><span class="linenos">791</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage-792"><a href="#Storage-792"><span class="linenos">792</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Storage-793"><a href="#Storage-793"><span class="linenos">793</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Storage-794"><a href="#Storage-794"><span class="linenos">794</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_root_read</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Storage-795"><a href="#Storage-795"><span class="linenos">795</span></a>        <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage-796"><a href="#Storage-796"><span class="linenos">796</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">())</span>
</span><span id="Storage-797"><a href="#Storage-797"><span class="linenos">797</span></a>
</span><span id="Storage-798"><a href="#Storage-798"><span class="linenos">798</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">SyncSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="k">if</span> <span class="n">session</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span id="Storage-799"><a href="#Storage-799"><span class="linenos">799</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="Storage-800"><a href="#Storage-800"><span class="linenos">800</span></a>            <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{},</span>
</span><span id="Storage-801"><a href="#Storage-801"><span class="linenos">801</span></a>            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage-802"><a href="#Storage-802"><span class="linenos">802</span></a>        <span class="p">)</span>
</span><span id="Storage-803"><a href="#Storage-803"><span class="linenos">803</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="Storage-804"><a href="#Storage-804"><span class="linenos">804</span></a>        <span class="k">return</span> <span class="n">data</span>
</span><span id="Storage-805"><a href="#Storage-805"><span class="linenos">805</span></a>
</span><span id="Storage-806"><a href="#Storage-806"><span class="linenos">806</span></a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Storage-807"><a href="#Storage-807"><span class="linenos">807</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Storage-808"><a href="#Storage-808"><span class="linenos">808</span></a>
</span><span id="Storage-809"><a href="#Storage-809"><span class="linenos">809</span></a>    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Storage&#39;</span><span class="p">:</span>
</span><span id="Storage-810"><a href="#Storage-810"><span class="linenos">810</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="Storage-811"><a href="#Storage-811"><span class="linenos">811</span></a>
</span><span id="Storage-812"><a href="#Storage-812"><span class="linenos">812</span></a>    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Storage-813"><a href="#Storage-813"><span class="linenos">813</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></pre></div>


    

                            <div id="Storage.__init__" class="classattr">
                                        <input id="Storage.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Storage</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="o">*</span>,</span><span class="param">	<span class="n">service_file</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">IO</span><span class="p">[</span><span class="o">~</span><span class="n">AnyStr</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">gcloud</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">requests</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">api_root</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="Storage.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Storage.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Storage.__init__-152"><a href="#Storage.__init__-152"><span class="linenos">152</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="Storage.__init__-153"><a href="#Storage.__init__-153"><span class="linenos">153</span></a>            <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">service_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">IO</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.__init__-154"><a href="#Storage.__init__-154"><span class="linenos">154</span></a>            <span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Token</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.__init__-155"><a href="#Storage.__init__-155"><span class="linenos">155</span></a>            <span class="n">api_root</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.__init__-156"><a href="#Storage.__init__-156"><span class="linenos">156</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Storage.__init__-157"><a href="#Storage.__init__-157"><span class="linenos">157</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_api_is_dev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api_root</span> <span class="o">=</span> <span class="n">init_api_root</span><span class="p">(</span><span class="n">api_root</span><span class="p">)</span>
</span><span id="Storage.__init__-158"><a href="#Storage.__init__-158"><span class="linenos">158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_api_root_read</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_root</span><span class="si">}</span><span class="s1">/storage/v1/b&#39;</span>
</span><span id="Storage.__init__-159"><a href="#Storage.__init__-159"><span class="linenos">159</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_api_root_write</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_root</span><span class="si">}</span><span class="s1">/upload/storage/v1/b&#39;</span>
</span><span id="Storage.__init__-160"><a href="#Storage.__init__-160"><span class="linenos">160</span></a>
</span><span id="Storage.__init__-161"><a href="#Storage.__init__-161"><span class="linenos">161</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">SyncSession</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">verify_ssl</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api_is_dev</span><span class="p">)</span>
</span><span id="Storage.__init__-162"><a href="#Storage.__init__-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span> <span class="ow">or</span> <span class="n">Token</span><span class="p">(</span>
</span><span id="Storage.__init__-163"><a href="#Storage.__init__-163"><span class="linenos">163</span></a>            <span class="n">service_file</span><span class="o">=</span><span class="n">service_file</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="n">SCOPES</span><span class="p">,</span>
</span><span id="Storage.__init__-164"><a href="#Storage.__init__-164"><span class="linenos">164</span></a>            <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>  <span class="c1"># type: ignore[arg-type]</span>
</span><span id="Storage.__init__-165"><a href="#Storage.__init__-165"><span class="linenos">165</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="Storage.session" class="classattr">
                                <div class="attr variable">
            <span class="name">session</span>

        
    </div>
    <a class="headerlink" href="#Storage.session"></a>
    
    

                            </div>
                            <div id="Storage.token" class="classattr">
                                <div class="attr variable">
            <span class="name">token</span>

        
    </div>
    <a class="headerlink" href="#Storage.token"></a>
    
    

                            </div>
                            <div id="Storage.list_buckets" class="classattr">
                                        <input id="Storage.list_buckets-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">list_buckets</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">project</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="o">*</span>,</span><span class="param">	<span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">requests</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n"><a href="#Bucket">Bucket</a></span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Storage.list_buckets-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Storage.list_buckets"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Storage.list_buckets-178"><a href="#Storage.list_buckets-178"><span class="linenos">178</span></a>    <span class="k">def</span> <span class="nf">list_buckets</span><span class="p">(</span>
</span><span id="Storage.list_buckets-179"><a href="#Storage.list_buckets-179"><span class="linenos">179</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
</span><span id="Storage.list_buckets-180"><a href="#Storage.list_buckets-180"><span class="linenos">180</span></a>        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.list_buckets-181"><a href="#Storage.list_buckets-181"><span class="linenos">181</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.list_buckets-182"><a href="#Storage.list_buckets-182"><span class="linenos">182</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.list_buckets-183"><a href="#Storage.list_buckets-183"><span class="linenos">183</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Storage.list_buckets-184"><a href="#Storage.list_buckets-184"><span class="linenos">184</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Bucket</span><span class="p">]:</span>
</span><span id="Storage.list_buckets-185"><a href="#Storage.list_buckets-185"><span class="linenos">185</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_root_read</span><span class="si">}</span><span class="s1">?project=</span><span class="si">{</span><span class="n">project</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Storage.list_buckets-186"><a href="#Storage.list_buckets-186"><span class="linenos">186</span></a>        <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage.list_buckets-187"><a href="#Storage.list_buckets-187"><span class="linenos">187</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">())</span>
</span><span id="Storage.list_buckets-188"><a href="#Storage.list_buckets-188"><span class="linenos">188</span></a>        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage.list_buckets-189"><a href="#Storage.list_buckets-189"><span class="linenos">189</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pageToken&#39;</span><span class="p">):</span>
</span><span id="Storage.list_buckets-190"><a href="#Storage.list_buckets-190"><span class="linenos">190</span></a>            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;pageToken&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="Storage.list_buckets-191"><a href="#Storage.list_buckets-191"><span class="linenos">191</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">SyncSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="k">if</span> <span class="n">session</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span id="Storage.list_buckets-192"><a href="#Storage.list_buckets-192"><span class="linenos">192</span></a>        <span class="n">buckets</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Storage.list_buckets-193"><a href="#Storage.list_buckets-193"><span class="linenos">193</span></a>
</span><span id="Storage.list_buckets-194"><a href="#Storage.list_buckets-194"><span class="linenos">194</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="Storage.list_buckets-195"><a href="#Storage.list_buckets-195"><span class="linenos">195</span></a>            <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
</span><span id="Storage.list_buckets-196"><a href="#Storage.list_buckets-196"><span class="linenos">196</span></a>                               <span class="n">params</span><span class="o">=</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{},</span>
</span><span id="Storage.list_buckets-197"><a href="#Storage.list_buckets-197"><span class="linenos">197</span></a>                               <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="Storage.list_buckets-198"><a href="#Storage.list_buckets-198"><span class="linenos">198</span></a>
</span><span id="Storage.list_buckets-199"><a href="#Storage.list_buckets-199"><span class="linenos">199</span></a>            <span class="n">content</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="Storage.list_buckets-200"><a href="#Storage.list_buckets-200"><span class="linenos">200</span></a>            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;items&#39;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="Storage.list_buckets-201"><a href="#Storage.list_buckets-201"><span class="linenos">201</span></a>                <span class="n">buckets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>
</span><span id="Storage.list_buckets-202"><a href="#Storage.list_buckets-202"><span class="linenos">202</span></a>
</span><span id="Storage.list_buckets-203"><a href="#Storage.list_buckets-203"><span class="linenos">203</span></a>            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;pageToken&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nextPageToken&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="Storage.list_buckets-204"><a href="#Storage.list_buckets-204"><span class="linenos">204</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;pageToken&#39;</span><span class="p">]:</span>
</span><span id="Storage.list_buckets-205"><a href="#Storage.list_buckets-205"><span class="linenos">205</span></a>                <span class="k">break</span>
</span><span id="Storage.list_buckets-206"><a href="#Storage.list_buckets-206"><span class="linenos">206</span></a>        <span class="k">return</span> <span class="n">buckets</span>
</span></pre></div>


    

                            </div>
                            <div id="Storage.get_bucket" class="classattr">
                                        <input id="Storage.get_bucket-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_bucket</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">bucket_name</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n"><a href="#Bucket">Bucket</a></span>:</span></span>

                <label class="view-source-button" for="Storage.get_bucket-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Storage.get_bucket"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Storage.get_bucket-208"><a href="#Storage.get_bucket-208"><span class="linenos">208</span></a>    <span class="k">def</span> <span class="nf">get_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Bucket</span><span class="p">:</span>
</span><span id="Storage.get_bucket-209"><a href="#Storage.get_bucket-209"><span class="linenos">209</span></a>        <span class="k">return</span> <span class="n">Bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="Storage.copy" class="classattr">
                                        <input id="Storage.copy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">copy</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">destination_bucket</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="o">*</span>,</span><span class="param">	<span class="n">new_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">requests</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Storage.copy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Storage.copy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Storage.copy-211"><a href="#Storage.copy-211"><span class="linenos">211</span></a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span>
</span><span id="Storage.copy-212"><a href="#Storage.copy-212"><span class="linenos">212</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Storage.copy-213"><a href="#Storage.copy-213"><span class="linenos">213</span></a>        <span class="n">destination_bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">new_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.copy-214"><a href="#Storage.copy-214"><span class="linenos">214</span></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.copy-215"><a href="#Storage.copy-215"><span class="linenos">215</span></a>        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.copy-216"><a href="#Storage.copy-216"><span class="linenos">216</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.copy-217"><a href="#Storage.copy-217"><span class="linenos">217</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Storage.copy-218"><a href="#Storage.copy-218"><span class="linenos">218</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.copy-219"><a href="#Storage.copy-219"><span class="linenos">219</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Storage.copy-220"><a href="#Storage.copy-220"><span class="linenos">220</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Storage.copy-221"><a href="#Storage.copy-221"><span class="linenos">221</span></a><span class="sd">        When files are too large, multiple calls to `rewriteTo` are made. We</span>
</span><span id="Storage.copy-222"><a href="#Storage.copy-222"><span class="linenos">222</span></a><span class="sd">        refer to the same copy job by using the `rewriteToken` from the</span>
</span><span id="Storage.copy-223"><a href="#Storage.copy-223"><span class="linenos">223</span></a><span class="sd">        previous return payload in subsequent `rewriteTo` calls.</span>
</span><span id="Storage.copy-224"><a href="#Storage.copy-224"><span class="linenos">224</span></a>
</span><span id="Storage.copy-225"><a href="#Storage.copy-225"><span class="linenos">225</span></a><span class="sd">        Using the `rewriteTo` GCS API is preferred in part because it is able</span>
</span><span id="Storage.copy-226"><a href="#Storage.copy-226"><span class="linenos">226</span></a><span class="sd">        to make multiple calls to fully copy an object whereas the `copyTo` GCS</span>
</span><span id="Storage.copy-227"><a href="#Storage.copy-227"><span class="linenos">227</span></a><span class="sd">        API only calls `rewriteTo` once under the hood, and thus may fail if</span>
</span><span id="Storage.copy-228"><a href="#Storage.copy-228"><span class="linenos">228</span></a><span class="sd">        files are large.</span>
</span><span id="Storage.copy-229"><a href="#Storage.copy-229"><span class="linenos">229</span></a>
</span><span id="Storage.copy-230"><a href="#Storage.copy-230"><span class="linenos">230</span></a><span class="sd">        In the rare case you need to resume a copy operation, include the</span>
</span><span id="Storage.copy-231"><a href="#Storage.copy-231"><span class="linenos">231</span></a><span class="sd">        `rewriteToken` in the `params` dictionary. Once you begin a multi-part</span>
</span><span id="Storage.copy-232"><a href="#Storage.copy-232"><span class="linenos">232</span></a><span class="sd">        copy operation, you then have 1 week to complete the copy job.</span>
</span><span id="Storage.copy-233"><a href="#Storage.copy-233"><span class="linenos">233</span></a>
</span><span id="Storage.copy-234"><a href="#Storage.copy-234"><span class="linenos">234</span></a><span class="sd">        https://cloud.google.com/storage/docs/json_api/v1/objects/rewrite</span>
</span><span id="Storage.copy-235"><a href="#Storage.copy-235"><span class="linenos">235</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Storage.copy-236"><a href="#Storage.copy-236"><span class="linenos">236</span></a>        <span class="c1"># pylint: disable=too-many-locals</span>
</span><span id="Storage.copy-237"><a href="#Storage.copy-237"><span class="linenos">237</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_name</span><span class="p">:</span>
</span><span id="Storage.copy-238"><a href="#Storage.copy-238"><span class="linenos">238</span></a>            <span class="n">new_name</span> <span class="o">=</span> <span class="n">object_name</span>
</span><span id="Storage.copy-239"><a href="#Storage.copy-239"><span class="linenos">239</span></a>
</span><span id="Storage.copy-240"><a href="#Storage.copy-240"><span class="linenos">240</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Storage.copy-241"><a href="#Storage.copy-241"><span class="linenos">241</span></a>            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_root_read</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s1">/o/&#39;</span>
</span><span id="Storage.copy-242"><a href="#Storage.copy-242"><span class="linenos">242</span></a>            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">quote</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span><span class="w"> </span><span class="n">safe</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">/rewriteTo/b/&#39;</span>
</span><span id="Storage.copy-243"><a href="#Storage.copy-243"><span class="linenos">243</span></a>            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">destination_bucket</span><span class="si">}</span><span class="s1">/o/</span><span class="si">{</span><span class="n">quote</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span><span class="w"> </span><span class="n">safe</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Storage.copy-244"><a href="#Storage.copy-244"><span class="linenos">244</span></a>        <span class="p">)</span>
</span><span id="Storage.copy-245"><a href="#Storage.copy-245"><span class="linenos">245</span></a>
</span><span id="Storage.copy-246"><a href="#Storage.copy-246"><span class="linenos">246</span></a>        <span class="c1"># We may optionally supply metadata* to apply to the rewritten</span>
</span><span id="Storage.copy-247"><a href="#Storage.copy-247"><span class="linenos">247</span></a>        <span class="c1"># object, which explains why `rewriteTo` is a POST endpoint; when no</span>
</span><span id="Storage.copy-248"><a href="#Storage.copy-248"><span class="linenos">248</span></a>        <span class="c1"># metadata is given, we have to send an empty body.</span>
</span><span id="Storage.copy-249"><a href="#Storage.copy-249"><span class="linenos">249</span></a>        <span class="c1"># * https://cloud.google.com/storage/docs/json_api/v1/objects#resource</span>
</span><span id="Storage.copy-250"><a href="#Storage.copy-250"><span class="linenos">250</span></a>        <span class="n">metadict</span> <span class="o">=</span> <span class="p">(</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Storage.copy-251"><a href="#Storage.copy-251"><span class="linenos">251</span></a>        <span class="n">metadict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Storage.copy-252"><a href="#Storage.copy-252"><span class="linenos">252</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_format_metadata_key</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span>
</span><span id="Storage.copy-253"><a href="#Storage.copy-253"><span class="linenos">253</span></a>            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metadict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Storage.copy-254"><a href="#Storage.copy-254"><span class="linenos">254</span></a>        <span class="p">}</span>
</span><span id="Storage.copy-255"><a href="#Storage.copy-255"><span class="linenos">255</span></a>        <span class="k">if</span> <span class="s1">&#39;metadata&#39;</span> <span class="ow">in</span> <span class="n">metadict</span><span class="p">:</span>
</span><span id="Storage.copy-256"><a href="#Storage.copy-256"><span class="linenos">256</span></a>            <span class="n">metadict</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Storage.copy-257"><a href="#Storage.copy-257"><span class="linenos">257</span></a>                <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Storage.copy-258"><a href="#Storage.copy-258"><span class="linenos">258</span></a>                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metadict</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Storage.copy-259"><a href="#Storage.copy-259"><span class="linenos">259</span></a>            <span class="p">}</span>
</span><span id="Storage.copy-260"><a href="#Storage.copy-260"><span class="linenos">260</span></a>
</span><span id="Storage.copy-261"><a href="#Storage.copy-261"><span class="linenos">261</span></a>        <span class="n">metadata_</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadict</span><span class="p">)</span>
</span><span id="Storage.copy-262"><a href="#Storage.copy-262"><span class="linenos">262</span></a>
</span><span id="Storage.copy-263"><a href="#Storage.copy-263"><span class="linenos">263</span></a>        <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage.copy-264"><a href="#Storage.copy-264"><span class="linenos">264</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">())</span>
</span><span id="Storage.copy-265"><a href="#Storage.copy-265"><span class="linenos">265</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
</span><span id="Storage.copy-266"><a href="#Storage.copy-266"><span class="linenos">266</span></a>            <span class="s1">&#39;Content-Length&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metadata_</span><span class="p">)),</span>
</span><span id="Storage.copy-267"><a href="#Storage.copy-267"><span class="linenos">267</span></a>            <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json; charset=UTF-8&#39;</span><span class="p">,</span>
</span><span id="Storage.copy-268"><a href="#Storage.copy-268"><span class="linenos">268</span></a>        <span class="p">})</span>
</span><span id="Storage.copy-269"><a href="#Storage.copy-269"><span class="linenos">269</span></a>
</span><span id="Storage.copy-270"><a href="#Storage.copy-270"><span class="linenos">270</span></a>        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage.copy-271"><a href="#Storage.copy-271"><span class="linenos">271</span></a>
</span><span id="Storage.copy-272"><a href="#Storage.copy-272"><span class="linenos">272</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">SyncSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="k">if</span> <span class="n">session</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span id="Storage.copy-273"><a href="#Storage.copy-273"><span class="linenos">273</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span><span id="Storage.copy-274"><a href="#Storage.copy-274"><span class="linenos">274</span></a>            <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage.copy-275"><a href="#Storage.copy-275"><span class="linenos">275</span></a>            <span class="n">data</span><span class="o">=</span><span class="n">metadata_</span><span class="p">,</span>
</span><span id="Storage.copy-276"><a href="#Storage.copy-276"><span class="linenos">276</span></a>        <span class="p">)</span>
</span><span id="Storage.copy-277"><a href="#Storage.copy-277"><span class="linenos">277</span></a>
</span><span id="Storage.copy-278"><a href="#Storage.copy-278"><span class="linenos">278</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="Storage.copy-279"><a href="#Storage.copy-279"><span class="linenos">279</span></a>
</span><span id="Storage.copy-280"><a href="#Storage.copy-280"><span class="linenos">280</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rewriteToken&#39;</span><span class="p">):</span>
</span><span id="Storage.copy-281"><a href="#Storage.copy-281"><span class="linenos">281</span></a>            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;rewriteToken&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rewriteToken&#39;</span><span class="p">]</span>
</span><span id="Storage.copy-282"><a href="#Storage.copy-282"><span class="linenos">282</span></a>            <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span><span id="Storage.copy-283"><a href="#Storage.copy-283"><span class="linenos">283</span></a>                <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
</span><span id="Storage.copy-284"><a href="#Storage.copy-284"><span class="linenos">284</span></a>                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage.copy-285"><a href="#Storage.copy-285"><span class="linenos">285</span></a>            <span class="p">)</span>
</span><span id="Storage.copy-286"><a href="#Storage.copy-286"><span class="linenos">286</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="Storage.copy-287"><a href="#Storage.copy-287"><span class="linenos">287</span></a>
</span><span id="Storage.copy-288"><a href="#Storage.copy-288"><span class="linenos">288</span></a>        <span class="k">return</span> <span class="n">data</span>
</span></pre></div>


            <div class="docstring"><p>When files are too large, multiple calls to <code>rewriteTo</code> are made. We
refer to the same copy job by using the <code>rewriteToken</code> from the
previous return payload in subsequent <code>rewriteTo</code> calls.</p>

<p>Using the <code>rewriteTo</code> GCS API is preferred in part because it is able
to make multiple calls to fully copy an object whereas the <code>copyTo</code> GCS
API only calls <code>rewriteTo</code> once under the hood, and thus may fail if
files are large.</p>

<p>In the rare case you need to resume a copy operation, include the
<code>rewriteToken</code> in the <code>params</code> dictionary. Once you begin a multi-part
copy operation, you then have 1 week to complete the copy job.</p>

<p><a href="https://cloud.google.com/storage/docs/json_api/v1/objects/rewrite">https://cloud.google.com/storage/docs/json_api/v1/objects/rewrite</a></p>
</div>


                            </div>
                            <div id="Storage.delete" class="classattr">
                                        <input id="Storage.delete-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">delete</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="o">*</span>,</span><span class="param">	<span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">requests</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="Storage.delete-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Storage.delete"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Storage.delete-290"><a href="#Storage.delete-290"><span class="linenos">290</span></a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span>
</span><span id="Storage.delete-291"><a href="#Storage.delete-291"><span class="linenos">291</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
</span><span id="Storage.delete-292"><a href="#Storage.delete-292"><span class="linenos">292</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Storage.delete-293"><a href="#Storage.delete-293"><span class="linenos">293</span></a>        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.delete-294"><a href="#Storage.delete-294"><span class="linenos">294</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.delete-295"><a href="#Storage.delete-295"><span class="linenos">295</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.delete-296"><a href="#Storage.delete-296"><span class="linenos">296</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Storage.delete-297"><a href="#Storage.delete-297"><span class="linenos">297</span></a>        <span class="c1"># https://cloud.google.com/storage/docs/request-endpoints#encoding</span>
</span><span id="Storage.delete-298"><a href="#Storage.delete-298"><span class="linenos">298</span></a>        <span class="n">encoded_object_name</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="Storage.delete-299"><a href="#Storage.delete-299"><span class="linenos">299</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_root_read</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s1">/o/</span><span class="si">{</span><span class="n">encoded_object_name</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Storage.delete-300"><a href="#Storage.delete-300"><span class="linenos">300</span></a>        <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage.delete-301"><a href="#Storage.delete-301"><span class="linenos">301</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">())</span>
</span><span id="Storage.delete-302"><a href="#Storage.delete-302"><span class="linenos">302</span></a>
</span><span id="Storage.delete-303"><a href="#Storage.delete-303"><span class="linenos">303</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">SyncSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="k">if</span> <span class="n">session</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span id="Storage.delete-304"><a href="#Storage.delete-304"><span class="linenos">304</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
</span><span id="Storage.delete-305"><a href="#Storage.delete-305"><span class="linenos">305</span></a>            <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{},</span>
</span><span id="Storage.delete-306"><a href="#Storage.delete-306"><span class="linenos">306</span></a>            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage.delete-307"><a href="#Storage.delete-307"><span class="linenos">307</span></a>        <span class="p">)</span>
</span><span id="Storage.delete-308"><a href="#Storage.delete-308"><span class="linenos">308</span></a>
</span><span id="Storage.delete-309"><a href="#Storage.delete-309"><span class="linenos">309</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Storage.delete-310"><a href="#Storage.delete-310"><span class="linenos">310</span></a>            <span class="n">data</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span id="Storage.delete-311"><a href="#Storage.delete-311"><span class="linenos">311</span></a>        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
</span><span id="Storage.delete-312"><a href="#Storage.delete-312"><span class="linenos">312</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="Storage.delete-313"><a href="#Storage.delete-313"><span class="linenos">313</span></a>
</span><span id="Storage.delete-314"><a href="#Storage.delete-314"><span class="linenos">314</span></a>        <span class="k">return</span> <span class="n">data</span>
</span></pre></div>


    

                            </div>
                            <div id="Storage.download" class="classattr">
                                        <input id="Storage.download-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">download</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="o">*</span>,</span><span class="param">	<span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">requests</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">bytes</span>:</span></span>

                <label class="view-source-button" for="Storage.download-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Storage.download"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Storage.download-316"><a href="#Storage.download-316"><span class="linenos">316</span></a>    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span>
</span><span id="Storage.download-317"><a href="#Storage.download-317"><span class="linenos">317</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
</span><span id="Storage.download-318"><a href="#Storage.download-318"><span class="linenos">318</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.download-319"><a href="#Storage.download-319"><span class="linenos">319</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Storage.download-320"><a href="#Storage.download-320"><span class="linenos">320</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.download-321"><a href="#Storage.download-321"><span class="linenos">321</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="Storage.download-322"><a href="#Storage.download-322"><span class="linenos">322</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download</span><span class="p">(</span>
</span><span id="Storage.download-323"><a href="#Storage.download-323"><span class="linenos">323</span></a>            <span class="n">bucket</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
</span><span id="Storage.download-324"><a href="#Storage.download-324"><span class="linenos">324</span></a>            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;alt&#39;</span><span class="p">:</span> <span class="s1">&#39;media&#39;</span><span class="p">},</span>
</span><span id="Storage.download-325"><a href="#Storage.download-325"><span class="linenos">325</span></a>            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
</span><span id="Storage.download-326"><a href="#Storage.download-326"><span class="linenos">326</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="Storage.download_to_filename" class="classattr">
                                        <input id="Storage.download_to_filename-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">download_to_filename</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Storage.download_to_filename-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Storage.download_to_filename"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Storage.download_to_filename-328"><a href="#Storage.download_to_filename-328"><span class="linenos">328</span></a>    <span class="k">def</span> <span class="nf">download_to_filename</span><span class="p">(</span>
</span><span id="Storage.download_to_filename-329"><a href="#Storage.download_to_filename-329"><span class="linenos">329</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Storage.download_to_filename-330"><a href="#Storage.download_to_filename-330"><span class="linenos">330</span></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="Storage.download_to_filename-331"><a href="#Storage.download_to_filename-331"><span class="linenos">331</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Storage.download_to_filename-332"><a href="#Storage.download_to_filename-332"><span class="linenos">332</span></a>        <span class="k">with</span> <span class="n">file_open</span><span class="p">(</span>  <span class="c1"># type: ignore[attr-defined]</span>
</span><span id="Storage.download_to_filename-333"><a href="#Storage.download_to_filename-333"><span class="linenos">333</span></a>                <span class="n">filename</span><span class="p">,</span>
</span><span id="Storage.download_to_filename-334"><a href="#Storage.download_to_filename-334"><span class="linenos">334</span></a>                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wb+&#39;</span><span class="p">,</span>
</span><span id="Storage.download_to_filename-335"><a href="#Storage.download_to_filename-335"><span class="linenos">335</span></a>        <span class="p">)</span> <span class="k">as</span> <span class="n">file_object</span><span class="p">:</span>
</span><span id="Storage.download_to_filename-336"><a href="#Storage.download_to_filename-336"><span class="linenos">336</span></a>            <span class="n">file_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
</span><span id="Storage.download_to_filename-337"><a href="#Storage.download_to_filename-337"><span class="linenos">337</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="Storage.download_to_filename-338"><a href="#Storage.download_to_filename-338"><span class="linenos">338</span></a>            <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="Storage.download_metadata" class="classattr">
                                        <input id="Storage.download_metadata-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">download_metadata</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="o">*</span>,</span><span class="param">	<span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">requests</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Storage.download_metadata-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Storage.download_metadata"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Storage.download_metadata-340"><a href="#Storage.download_metadata-340"><span class="linenos">340</span></a>    <span class="k">def</span> <span class="nf">download_metadata</span><span class="p">(</span>
</span><span id="Storage.download_metadata-341"><a href="#Storage.download_metadata-341"><span class="linenos">341</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
</span><span id="Storage.download_metadata-342"><a href="#Storage.download_metadata-342"><span class="linenos">342</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.download_metadata-343"><a href="#Storage.download_metadata-343"><span class="linenos">343</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.download_metadata-344"><a href="#Storage.download_metadata-344"><span class="linenos">344</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Storage.download_metadata-345"><a href="#Storage.download_metadata-345"><span class="linenos">345</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Storage.download_metadata-346"><a href="#Storage.download_metadata-346"><span class="linenos">346</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download</span><span class="p">(</span>
</span><span id="Storage.download_metadata-347"><a href="#Storage.download_metadata-347"><span class="linenos">347</span></a>            <span class="n">bucket</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
</span><span id="Storage.download_metadata-348"><a href="#Storage.download_metadata-348"><span class="linenos">348</span></a>            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
</span><span id="Storage.download_metadata-349"><a href="#Storage.download_metadata-349"><span class="linenos">349</span></a>        <span class="p">)</span>
</span><span id="Storage.download_metadata-350"><a href="#Storage.download_metadata-350"><span class="linenos">350</span></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span><span id="Storage.download_metadata-351"><a href="#Storage.download_metadata-351"><span class="linenos">351</span></a>        <span class="k">return</span> <span class="n">metadata</span>
</span></pre></div>


    

                            </div>
                            <div id="Storage.download_stream" class="classattr">
                                        <input id="Storage.download_stream-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">download_stream</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="o">*</span>,</span><span class="param">	<span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">requests</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#StreamResponse">StreamResponse</a></span>:</span></span>

                <label class="view-source-button" for="Storage.download_stream-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Storage.download_stream"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Storage.download_stream-353"><a href="#Storage.download_stream-353"><span class="linenos">353</span></a>    <span class="k">def</span> <span class="nf">download_stream</span><span class="p">(</span>
</span><span id="Storage.download_stream-354"><a href="#Storage.download_stream-354"><span class="linenos">354</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
</span><span id="Storage.download_stream-355"><a href="#Storage.download_stream-355"><span class="linenos">355</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.download_stream-356"><a href="#Storage.download_stream-356"><span class="linenos">356</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Storage.download_stream-357"><a href="#Storage.download_stream-357"><span class="linenos">357</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.download_stream-358"><a href="#Storage.download_stream-358"><span class="linenos">358</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StreamResponse</span><span class="p">:</span>
</span><span id="Storage.download_stream-359"><a href="#Storage.download_stream-359"><span class="linenos">359</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Download a GCS object in a buffered stream.</span>
</span><span id="Storage.download_stream-360"><a href="#Storage.download_stream-360"><span class="linenos">360</span></a>
</span><span id="Storage.download_stream-361"><a href="#Storage.download_stream-361"><span class="linenos">361</span></a><span class="sd">        Args:</span>
</span><span id="Storage.download_stream-362"><a href="#Storage.download_stream-362"><span class="linenos">362</span></a><span class="sd">            bucket (str): The bucket from which to download.</span>
</span><span id="Storage.download_stream-363"><a href="#Storage.download_stream-363"><span class="linenos">363</span></a><span class="sd">            object_name (str): The object within the bucket to download.</span>
</span><span id="Storage.download_stream-364"><a href="#Storage.download_stream-364"><span class="linenos">364</span></a><span class="sd">            headers (Optional[Dict[str, Any]], optional): Custom header values</span>
</span><span id="Storage.download_stream-365"><a href="#Storage.download_stream-365"><span class="linenos">365</span></a><span class="sd">                for the request, such as range. Defaults to None.</span>
</span><span id="Storage.download_stream-366"><a href="#Storage.download_stream-366"><span class="linenos">366</span></a><span class="sd">            timeout (int, optional): Timeout, in seconds, for the request. Note</span>
</span><span id="Storage.download_stream-367"><a href="#Storage.download_stream-367"><span class="linenos">367</span></a><span class="sd">                that with this function, this is the time to the beginning of</span>
</span><span id="Storage.download_stream-368"><a href="#Storage.download_stream-368"><span class="linenos">368</span></a><span class="sd">                the response data (TTFB). Defaults to 10.</span>
</span><span id="Storage.download_stream-369"><a href="#Storage.download_stream-369"><span class="linenos">369</span></a><span class="sd">            session (Optional[Session], optional): A specific session to</span>
</span><span id="Storage.download_stream-370"><a href="#Storage.download_stream-370"><span class="linenos">370</span></a><span class="sd">                (re)use. Defaults to None.</span>
</span><span id="Storage.download_stream-371"><a href="#Storage.download_stream-371"><span class="linenos">371</span></a>
</span><span id="Storage.download_stream-372"><a href="#Storage.download_stream-372"><span class="linenos">372</span></a><span class="sd">        Returns:</span>
</span><span id="Storage.download_stream-373"><a href="#Storage.download_stream-373"><span class="linenos">373</span></a><span class="sd">            StreamResponse: A object encapsulating the stream, similar to</span>
</span><span id="Storage.download_stream-374"><a href="#Storage.download_stream-374"><span class="linenos">374</span></a><span class="sd">            io.BufferedIOBase, but it only supports the read() function.</span>
</span><span id="Storage.download_stream-375"><a href="#Storage.download_stream-375"><span class="linenos">375</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Storage.download_stream-376"><a href="#Storage.download_stream-376"><span class="linenos">376</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_stream</span><span class="p">(</span>
</span><span id="Storage.download_stream-377"><a href="#Storage.download_stream-377"><span class="linenos">377</span></a>            <span class="n">bucket</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span>
</span><span id="Storage.download_stream-378"><a href="#Storage.download_stream-378"><span class="linenos">378</span></a>            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage.download_stream-379"><a href="#Storage.download_stream-379"><span class="linenos">379</span></a>            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;alt&#39;</span><span class="p">:</span> <span class="s1">&#39;media&#39;</span><span class="p">},</span>
</span><span id="Storage.download_stream-380"><a href="#Storage.download_stream-380"><span class="linenos">380</span></a>            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
</span><span id="Storage.download_stream-381"><a href="#Storage.download_stream-381"><span class="linenos">381</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Download a GCS object in a buffered stream.</p>

<p>Args:
    bucket (str): The bucket from which to download.
    object_name (str): The object within the bucket to download.
    headers (Optional[Dict[str, Any]], optional): Custom header values
        for the request, such as range. Defaults to None.
    timeout (int, optional): Timeout, in seconds, for the request. Note
        that with this function, this is the time to the beginning of
        the response data (TTFB). Defaults to 10.
    session (Optional[Session], optional): A specific session to
        (re)use. Defaults to None.</p>

<p>Returns:
    StreamResponse: A object encapsulating the stream, similar to
    io.BufferedIOBase, but it only supports the read() function.</p>
</div>


                            </div>
                            <div id="Storage.list_objects" class="classattr">
                                        <input id="Storage.list_objects-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">list_objects</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="o">*</span>,</span><span class="param">	<span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">requests</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Storage.list_objects-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Storage.list_objects"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Storage.list_objects-383"><a href="#Storage.list_objects-383"><span class="linenos">383</span></a>    <span class="k">def</span> <span class="nf">list_objects</span><span class="p">(</span>
</span><span id="Storage.list_objects-384"><a href="#Storage.list_objects-384"><span class="linenos">384</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
</span><span id="Storage.list_objects-385"><a href="#Storage.list_objects-385"><span class="linenos">385</span></a>        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.list_objects-386"><a href="#Storage.list_objects-386"><span class="linenos">386</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.list_objects-387"><a href="#Storage.list_objects-387"><span class="linenos">387</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.list_objects-388"><a href="#Storage.list_objects-388"><span class="linenos">388</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Storage.list_objects-389"><a href="#Storage.list_objects-389"><span class="linenos">389</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Storage.list_objects-390"><a href="#Storage.list_objects-390"><span class="linenos">390</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_root_read</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s1">/o&#39;</span>
</span><span id="Storage.list_objects-391"><a href="#Storage.list_objects-391"><span class="linenos">391</span></a>        <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage.list_objects-392"><a href="#Storage.list_objects-392"><span class="linenos">392</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">())</span>
</span><span id="Storage.list_objects-393"><a href="#Storage.list_objects-393"><span class="linenos">393</span></a>
</span><span id="Storage.list_objects-394"><a href="#Storage.list_objects-394"><span class="linenos">394</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">SyncSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="k">if</span> <span class="n">session</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span id="Storage.list_objects-395"><a href="#Storage.list_objects-395"><span class="linenos">395</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="Storage.list_objects-396"><a href="#Storage.list_objects-396"><span class="linenos">396</span></a>            <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{},</span>
</span><span id="Storage.list_objects-397"><a href="#Storage.list_objects-397"><span class="linenos">397</span></a>            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage.list_objects-398"><a href="#Storage.list_objects-398"><span class="linenos">398</span></a>        <span class="p">)</span>
</span><span id="Storage.list_objects-399"><a href="#Storage.list_objects-399"><span class="linenos">399</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="Storage.list_objects-400"><a href="#Storage.list_objects-400"><span class="linenos">400</span></a>        <span class="k">return</span> <span class="n">data</span>
</span></pre></div>


    

                            </div>
                            <div id="Storage.upload" class="classattr">
                                        <input id="Storage.upload-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">upload</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">file_data</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="o">*</span>,</span><span class="param">	<span class="n">content_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">requests</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">force_resumable_upload</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Storage.upload-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Storage.upload"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Storage.upload-404"><a href="#Storage.upload-404"><span class="linenos">404</span></a>    <span class="k">def</span> <span class="nf">upload</span><span class="p">(</span>
</span><span id="Storage.upload-405"><a href="#Storage.upload-405"><span class="linenos">405</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_data</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="Storage.upload-406"><a href="#Storage.upload-406"><span class="linenos">406</span></a>        <span class="o">*</span><span class="p">,</span> <span class="n">content_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.upload-407"><a href="#Storage.upload-407"><span class="linenos">407</span></a>        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.upload-408"><a href="#Storage.upload-408"><span class="linenos">408</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.upload-409"><a href="#Storage.upload-409"><span class="linenos">409</span></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.upload-410"><a href="#Storage.upload-410"><span class="linenos">410</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.upload-411"><a href="#Storage.upload-411"><span class="linenos">411</span></a>        <span class="n">force_resumable_upload</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.upload-412"><a href="#Storage.upload-412"><span class="linenos">412</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
</span><span id="Storage.upload-413"><a href="#Storage.upload-413"><span class="linenos">413</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Storage.upload-414"><a href="#Storage.upload-414"><span class="linenos">414</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_root_write</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s1">/o&#39;</span>
</span><span id="Storage.upload-415"><a href="#Storage.upload-415"><span class="linenos">415</span></a>
</span><span id="Storage.upload-416"><a href="#Storage.upload-416"><span class="linenos">416</span></a>        <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_data</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
</span><span id="Storage.upload-417"><a href="#Storage.upload-417"><span class="linenos">417</span></a>
</span><span id="Storage.upload-418"><a href="#Storage.upload-418"><span class="linenos">418</span></a>        <span class="k">if</span> <span class="n">BUILD_GCLOUD_REST</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">):</span>
</span><span id="Storage.upload-419"><a href="#Storage.upload-419"><span class="linenos">419</span></a>            <span class="c1"># HACK: `requests` library does not accept `str` as `data` in `put`</span>
</span><span id="Storage.upload-420"><a href="#Storage.upload-420"><span class="linenos">420</span></a>            <span class="c1"># HTTP request.</span>
</span><span id="Storage.upload-421"><a href="#Storage.upload-421"><span class="linenos">421</span></a>            <span class="n">stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</span><span id="Storage.upload-422"><a href="#Storage.upload-422"><span class="linenos">422</span></a>
</span><span id="Storage.upload-423"><a href="#Storage.upload-423"><span class="linenos">423</span></a>        <span class="n">content_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stream_len</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
</span><span id="Storage.upload-424"><a href="#Storage.upload-424"><span class="linenos">424</span></a>
</span><span id="Storage.upload-425"><a href="#Storage.upload-425"><span class="linenos">425</span></a>        <span class="c1"># mime detection method same as in aiohttp 3.4.4</span>
</span><span id="Storage.upload-426"><a href="#Storage.upload-426"><span class="linenos">426</span></a>        <span class="n">content_type</span> <span class="o">=</span> <span class="n">content_type</span> <span class="ow">or</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">object_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Storage.upload-427"><a href="#Storage.upload-427"><span class="linenos">427</span></a>
</span><span id="Storage.upload-428"><a href="#Storage.upload-428"><span class="linenos">428</span></a>        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage.upload-429"><a href="#Storage.upload-429"><span class="linenos">429</span></a>
</span><span id="Storage.upload-430"><a href="#Storage.upload-430"><span class="linenos">430</span></a>        <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage.upload-431"><a href="#Storage.upload-431"><span class="linenos">431</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">())</span>
</span><span id="Storage.upload-432"><a href="#Storage.upload-432"><span class="linenos">432</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
</span><span id="Storage.upload-433"><a href="#Storage.upload-433"><span class="linenos">433</span></a>            <span class="s1">&#39;Content-Length&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">content_length</span><span class="p">),</span>
</span><span id="Storage.upload-434"><a href="#Storage.upload-434"><span class="linenos">434</span></a>            <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="n">content_type</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span id="Storage.upload-435"><a href="#Storage.upload-435"><span class="linenos">435</span></a>        <span class="p">})</span>
</span><span id="Storage.upload-436"><a href="#Storage.upload-436"><span class="linenos">436</span></a>
</span><span id="Storage.upload-437"><a href="#Storage.upload-437"><span class="linenos">437</span></a>        <span class="n">upload_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decide_upload_type</span><span class="p">(</span>
</span><span id="Storage.upload-438"><a href="#Storage.upload-438"><span class="linenos">438</span></a>            <span class="n">force_resumable_upload</span><span class="p">,</span>
</span><span id="Storage.upload-439"><a href="#Storage.upload-439"><span class="linenos">439</span></a>            <span class="n">content_length</span><span class="p">,</span>
</span><span id="Storage.upload-440"><a href="#Storage.upload-440"><span class="linenos">440</span></a>        <span class="p">)</span>
</span><span id="Storage.upload-441"><a href="#Storage.upload-441"><span class="linenos">441</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;using </span><span class="si">%r</span><span class="s1"> gcloud storage upload method&#39;</span><span class="p">,</span> <span class="n">upload_type</span><span class="p">)</span>
</span><span id="Storage.upload-442"><a href="#Storage.upload-442"><span class="linenos">442</span></a>
</span><span id="Storage.upload-443"><a href="#Storage.upload-443"><span class="linenos">443</span></a>        <span class="k">if</span> <span class="n">upload_type</span> <span class="o">==</span> <span class="n">UploadType</span><span class="o">.</span><span class="n">RESUMABLE</span><span class="p">:</span>
</span><span id="Storage.upload-444"><a href="#Storage.upload-444"><span class="linenos">444</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upload_resumable</span><span class="p">(</span>
</span><span id="Storage.upload-445"><a href="#Storage.upload-445"><span class="linenos">445</span></a>                <span class="n">url</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span>
</span><span id="Storage.upload-446"><a href="#Storage.upload-446"><span class="linenos">446</span></a>                <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage.upload-447"><a href="#Storage.upload-447"><span class="linenos">447</span></a>            <span class="p">)</span>
</span><span id="Storage.upload-448"><a href="#Storage.upload-448"><span class="linenos">448</span></a>        <span class="k">if</span> <span class="n">upload_type</span> <span class="o">==</span> <span class="n">UploadType</span><span class="o">.</span><span class="n">SIMPLE</span><span class="p">:</span>
</span><span id="Storage.upload-449"><a href="#Storage.upload-449"><span class="linenos">449</span></a>            <span class="k">if</span> <span class="n">metadata</span><span class="p">:</span>
</span><span id="Storage.upload-450"><a href="#Storage.upload-450"><span class="linenos">450</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upload_multipart</span><span class="p">(</span>
</span><span id="Storage.upload-451"><a href="#Storage.upload-451"><span class="linenos">451</span></a>                    <span class="n">url</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
</span><span id="Storage.upload-452"><a href="#Storage.upload-452"><span class="linenos">452</span></a>                    <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage.upload-453"><a href="#Storage.upload-453"><span class="linenos">453</span></a>                <span class="p">)</span>
</span><span id="Storage.upload-454"><a href="#Storage.upload-454"><span class="linenos">454</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upload_simple</span><span class="p">(</span>
</span><span id="Storage.upload-455"><a href="#Storage.upload-455"><span class="linenos">455</span></a>                <span class="n">url</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
</span><span id="Storage.upload-456"><a href="#Storage.upload-456"><span class="linenos">456</span></a>                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage.upload-457"><a href="#Storage.upload-457"><span class="linenos">457</span></a>            <span class="p">)</span>
</span><span id="Storage.upload-458"><a href="#Storage.upload-458"><span class="linenos">458</span></a>
</span><span id="Storage.upload-459"><a href="#Storage.upload-459"><span class="linenos">459</span></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;upload type </span><span class="si">{</span><span class="n">upload_type</span><span class="si">}</span><span class="s1"> not supported&#39;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="Storage.upload_from_filename" class="classattr">
                                        <input id="Storage.upload_from_filename-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">upload_from_filename</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Storage.upload_from_filename-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Storage.upload_from_filename"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Storage.upload_from_filename-461"><a href="#Storage.upload_from_filename-461"><span class="linenos">461</span></a>    <span class="k">def</span> <span class="nf">upload_from_filename</span><span class="p">(</span>
</span><span id="Storage.upload_from_filename-462"><a href="#Storage.upload_from_filename-462"><span class="linenos">462</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Storage.upload_from_filename-463"><a href="#Storage.upload_from_filename-463"><span class="linenos">463</span></a>        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Storage.upload_from_filename-464"><a href="#Storage.upload_from_filename-464"><span class="linenos">464</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="Storage.upload_from_filename-465"><a href="#Storage.upload_from_filename-465"><span class="linenos">465</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Storage.upload_from_filename-466"><a href="#Storage.upload_from_filename-466"><span class="linenos">466</span></a>        <span class="k">with</span> <span class="n">file_open</span><span class="p">(</span>  <span class="c1"># type: ignore[attr-defined]</span>
</span><span id="Storage.upload_from_filename-467"><a href="#Storage.upload_from_filename-467"><span class="linenos">467</span></a>                <span class="n">filename</span><span class="p">,</span>
</span><span id="Storage.upload_from_filename-468"><a href="#Storage.upload_from_filename-468"><span class="linenos">468</span></a>                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">,</span>
</span><span id="Storage.upload_from_filename-469"><a href="#Storage.upload_from_filename-469"><span class="linenos">469</span></a>        <span class="p">)</span> <span class="k">as</span> <span class="n">file_object</span><span class="p">:</span>
</span><span id="Storage.upload_from_filename-470"><a href="#Storage.upload_from_filename-470"><span class="linenos">470</span></a>            <span class="n">contents</span> <span class="o">=</span> <span class="n">file_object</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="Storage.upload_from_filename-471"><a href="#Storage.upload_from_filename-471"><span class="linenos">471</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">contents</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="Storage.patch_metadata" class="classattr">
                                        <input id="Storage.patch_metadata-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">patch_metadata</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="o">*</span>,</span><span class="param">	<span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">requests</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Storage.patch_metadata-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Storage.patch_metadata"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Storage.patch_metadata-763"><a href="#Storage.patch_metadata-763"><span class="linenos">763</span></a>    <span class="k">def</span> <span class="nf">patch_metadata</span><span class="p">(</span>
</span><span id="Storage.patch_metadata-764"><a href="#Storage.patch_metadata-764"><span class="linenos">764</span></a>            <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="Storage.patch_metadata-765"><a href="#Storage.patch_metadata-765"><span class="linenos">765</span></a>            <span class="o">*</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.patch_metadata-766"><a href="#Storage.patch_metadata-766"><span class="linenos">766</span></a>            <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.patch_metadata-767"><a href="#Storage.patch_metadata-767"><span class="linenos">767</span></a>            <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.patch_metadata-768"><a href="#Storage.patch_metadata-768"><span class="linenos">768</span></a>            <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Storage.patch_metadata-769"><a href="#Storage.patch_metadata-769"><span class="linenos">769</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Storage.patch_metadata-770"><a href="#Storage.patch_metadata-770"><span class="linenos">770</span></a>        <span class="c1"># https://cloud.google.com/storage/docs/json_api/v1/objects/patch</span>
</span><span id="Storage.patch_metadata-771"><a href="#Storage.patch_metadata-771"><span class="linenos">771</span></a>        <span class="n">encoded_object_name</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="Storage.patch_metadata-772"><a href="#Storage.patch_metadata-772"><span class="linenos">772</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_root_read</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s1">/o/</span><span class="si">{</span><span class="n">encoded_object_name</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Storage.patch_metadata-773"><a href="#Storage.patch_metadata-773"><span class="linenos">773</span></a>        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage.patch_metadata-774"><a href="#Storage.patch_metadata-774"><span class="linenos">774</span></a>        <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage.patch_metadata-775"><a href="#Storage.patch_metadata-775"><span class="linenos">775</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">())</span>
</span><span id="Storage.patch_metadata-776"><a href="#Storage.patch_metadata-776"><span class="linenos">776</span></a>        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;application/json&#39;</span>
</span><span id="Storage.patch_metadata-777"><a href="#Storage.patch_metadata-777"><span class="linenos">777</span></a>        <span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span><span id="Storage.patch_metadata-778"><a href="#Storage.patch_metadata-778"><span class="linenos">778</span></a>
</span><span id="Storage.patch_metadata-779"><a href="#Storage.patch_metadata-779"><span class="linenos">779</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">SyncSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="k">if</span> <span class="n">session</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span id="Storage.patch_metadata-780"><a href="#Storage.patch_metadata-780"><span class="linenos">780</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span>
</span><span id="Storage.patch_metadata-781"><a href="#Storage.patch_metadata-781"><span class="linenos">781</span></a>            <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
</span><span id="Storage.patch_metadata-782"><a href="#Storage.patch_metadata-782"><span class="linenos">782</span></a>            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage.patch_metadata-783"><a href="#Storage.patch_metadata-783"><span class="linenos">783</span></a>        <span class="p">)</span>
</span><span id="Storage.patch_metadata-784"><a href="#Storage.patch_metadata-784"><span class="linenos">784</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="Storage.patch_metadata-785"><a href="#Storage.patch_metadata-785"><span class="linenos">785</span></a>        <span class="k">return</span> <span class="n">data</span>
</span></pre></div>


    

                            </div>
                            <div id="Storage.get_bucket_metadata" class="classattr">
                                        <input id="Storage.get_bucket_metadata-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_bucket_metadata</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="o">*</span>,</span><span class="param">	<span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">requests</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Storage.get_bucket_metadata-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Storage.get_bucket_metadata"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Storage.get_bucket_metadata-787"><a href="#Storage.get_bucket_metadata-787"><span class="linenos">787</span></a>    <span class="k">def</span> <span class="nf">get_bucket_metadata</span><span class="p">(</span>
</span><span id="Storage.get_bucket_metadata-788"><a href="#Storage.get_bucket_metadata-788"><span class="linenos">788</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
</span><span id="Storage.get_bucket_metadata-789"><a href="#Storage.get_bucket_metadata-789"><span class="linenos">789</span></a>        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.get_bucket_metadata-790"><a href="#Storage.get_bucket_metadata-790"><span class="linenos">790</span></a>        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.get_bucket_metadata-791"><a href="#Storage.get_bucket_metadata-791"><span class="linenos">791</span></a>        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Storage.get_bucket_metadata-792"><a href="#Storage.get_bucket_metadata-792"><span class="linenos">792</span></a>        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
</span><span id="Storage.get_bucket_metadata-793"><a href="#Storage.get_bucket_metadata-793"><span class="linenos">793</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Storage.get_bucket_metadata-794"><a href="#Storage.get_bucket_metadata-794"><span class="linenos">794</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_root_read</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="Storage.get_bucket_metadata-795"><a href="#Storage.get_bucket_metadata-795"><span class="linenos">795</span></a>        <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Storage.get_bucket_metadata-796"><a href="#Storage.get_bucket_metadata-796"><span class="linenos">796</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">())</span>
</span><span id="Storage.get_bucket_metadata-797"><a href="#Storage.get_bucket_metadata-797"><span class="linenos">797</span></a>
</span><span id="Storage.get_bucket_metadata-798"><a href="#Storage.get_bucket_metadata-798"><span class="linenos">798</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">SyncSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="k">if</span> <span class="n">session</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span id="Storage.get_bucket_metadata-799"><a href="#Storage.get_bucket_metadata-799"><span class="linenos">799</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="Storage.get_bucket_metadata-800"><a href="#Storage.get_bucket_metadata-800"><span class="linenos">800</span></a>            <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{},</span>
</span><span id="Storage.get_bucket_metadata-801"><a href="#Storage.get_bucket_metadata-801"><span class="linenos">801</span></a>            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="Storage.get_bucket_metadata-802"><a href="#Storage.get_bucket_metadata-802"><span class="linenos">802</span></a>        <span class="p">)</span>
</span><span id="Storage.get_bucket_metadata-803"><a href="#Storage.get_bucket_metadata-803"><span class="linenos">803</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="Storage.get_bucket_metadata-804"><a href="#Storage.get_bucket_metadata-804"><span class="linenos">804</span></a>        <span class="k">return</span> <span class="n">data</span>
</span></pre></div>


    

                            </div>
                            <div id="Storage.close" class="classattr">
                                        <input id="Storage.close-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">close</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Storage.close-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Storage.close"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Storage.close-806"><a href="#Storage.close-806"><span class="linenos">806</span></a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Storage.close-807"><a href="#Storage.close-807"><span class="linenos">807</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="StreamResponse">
                            <input id="StreamResponse-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">StreamResponse</span>:

                <label class="view-source-button" for="StreamResponse-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StreamResponse"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StreamResponse-114"><a href="#StreamResponse-114"><span class="linenos">114</span></a><span class="k">class</span> <span class="nc">StreamResponse</span><span class="p">:</span>
</span><span id="StreamResponse-115"><a href="#StreamResponse-115"><span class="linenos">115</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;This class provides an abstraction between the slightly different</span>
</span><span id="StreamResponse-116"><a href="#StreamResponse-116"><span class="linenos">116</span></a><span class="sd">    recommended streaming implementations between requests and aiohttp.</span>
</span><span id="StreamResponse-117"><a href="#StreamResponse-117"><span class="linenos">117</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="StreamResponse-118"><a href="#StreamResponse-118"><span class="linenos">118</span></a>
</span><span id="StreamResponse-119"><a href="#StreamResponse-119"><span class="linenos">119</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StreamResponse-120"><a href="#StreamResponse-120"><span class="linenos">120</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span> <span class="o">=</span> <span class="n">response</span>
</span><span id="StreamResponse-121"><a href="#StreamResponse-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterator</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StreamResponse-122"><a href="#StreamResponse-122"><span class="linenos">122</span></a>
</span><span id="StreamResponse-123"><a href="#StreamResponse-123"><span class="linenos">123</span></a>    <span class="nd">@property</span>
</span><span id="StreamResponse-124"><a href="#StreamResponse-124"><span class="linenos">124</span></a>    <span class="k">def</span> <span class="nf">content_length</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="StreamResponse-125"><a href="#StreamResponse-125"><span class="linenos">125</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-length&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="StreamResponse-126"><a href="#StreamResponse-126"><span class="linenos">126</span></a>
</span><span id="StreamResponse-127"><a href="#StreamResponse-127"><span class="linenos">127</span></a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="StreamResponse-128"><a href="#StreamResponse-128"><span class="linenos">128</span></a>        <span class="n">chunk</span><span class="p">:</span> <span class="nb">bytes</span>
</span><span id="StreamResponse-129"><a href="#StreamResponse-129"><span class="linenos">129</span></a>        <span class="k">if</span> <span class="n">BUILD_GCLOUD_REST</span><span class="p">:</span>
</span><span id="StreamResponse-130"><a href="#StreamResponse-130"><span class="linenos">130</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StreamResponse-131"><a href="#StreamResponse-131"><span class="linenos">131</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
</span><span id="StreamResponse-132"><a href="#StreamResponse-132"><span class="linenos">132</span></a>            <span class="n">chunk</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="StreamResponse-133"><a href="#StreamResponse-133"><span class="linenos">133</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StreamResponse-134"><a href="#StreamResponse-134"><span class="linenos">134</span></a>            <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
</span><span id="StreamResponse-135"><a href="#StreamResponse-135"><span class="linenos">135</span></a>        <span class="k">return</span> <span class="n">chunk</span>
</span><span id="StreamResponse-136"><a href="#StreamResponse-136"><span class="linenos">136</span></a>
</span><span id="StreamResponse-137"><a href="#StreamResponse-137"><span class="linenos">137</span></a>    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="StreamResponse-138"><a href="#StreamResponse-138"><span class="linenos">138</span></a>        <span class="c1"># strictly speaking, since this method can&#39;t be called via gcloud-rest,</span>
</span><span id="StreamResponse-139"><a href="#StreamResponse-139"><span class="linenos">139</span></a>        <span class="c1"># we know the return type is aiohttp.ClientResponse</span>
</span><span id="StreamResponse-140"><a href="#StreamResponse-140"><span class="linenos">140</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
</span><span id="StreamResponse-141"><a href="#StreamResponse-141"><span class="linenos">141</span></a>
</span><span id="StreamResponse-142"><a href="#StreamResponse-142"><span class="linenos">142</span></a>    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exc_info</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StreamResponse-143"><a href="#StreamResponse-143"><span class="linenos">143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="o">*</span><span class="n">exc_info</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This class provides an abstraction between the slightly different
recommended streaming implementations between requests and aiohttp.</p>
</div>


                            <div id="StreamResponse.__init__" class="classattr">
                                        <input id="StreamResponse.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">StreamResponse</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">response</span><span class="p">:</span> <span class="n">Any</span></span>)</span>

                <label class="view-source-button" for="StreamResponse.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StreamResponse.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StreamResponse.__init__-119"><a href="#StreamResponse.__init__-119"><span class="linenos">119</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StreamResponse.__init__-120"><a href="#StreamResponse.__init__-120"><span class="linenos">120</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span> <span class="o">=</span> <span class="n">response</span>
</span><span id="StreamResponse.__init__-121"><a href="#StreamResponse.__init__-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterator</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


    

                            </div>
                            <div id="StreamResponse.content_length" class="classattr">
                                <div class="attr variable">
            <span class="name">content_length</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#StreamResponse.content_length"></a>
    
    

                            </div>
                            <div id="StreamResponse.read" class="classattr">
                                        <input id="StreamResponse.read-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">read</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span></span><span class="return-annotation">) -> <span class="nb">bytes</span>:</span></span>

                <label class="view-source-button" for="StreamResponse.read-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StreamResponse.read"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StreamResponse.read-127"><a href="#StreamResponse.read-127"><span class="linenos">127</span></a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="StreamResponse.read-128"><a href="#StreamResponse.read-128"><span class="linenos">128</span></a>        <span class="n">chunk</span><span class="p">:</span> <span class="nb">bytes</span>
</span><span id="StreamResponse.read-129"><a href="#StreamResponse.read-129"><span class="linenos">129</span></a>        <span class="k">if</span> <span class="n">BUILD_GCLOUD_REST</span><span class="p">:</span>
</span><span id="StreamResponse.read-130"><a href="#StreamResponse.read-130"><span class="linenos">130</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StreamResponse.read-131"><a href="#StreamResponse.read-131"><span class="linenos">131</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
</span><span id="StreamResponse.read-132"><a href="#StreamResponse.read-132"><span class="linenos">132</span></a>            <span class="n">chunk</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="StreamResponse.read-133"><a href="#StreamResponse.read-133"><span class="linenos">133</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StreamResponse.read-134"><a href="#StreamResponse.read-134"><span class="linenos">134</span></a>            <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
</span><span id="StreamResponse.read-135"><a href="#StreamResponse.read-135"><span class="linenos">135</span></a>        <span class="k">return</span> <span class="n">chunk</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="__version__">
                    <div class="attr variable">
            <span class="name">__version__</span>        =
<span class="default_value">&#39;8.3.0&#39;</span>

        
    </div>
    <a class="headerlink" href="#__version__"></a>
    
    

                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>